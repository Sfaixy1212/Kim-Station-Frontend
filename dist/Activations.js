import{j as e,r as d,u as q,n as T}from"./vendor.js";import{a as I,u as G,D as H}from"./DashboardLayout.js";import{u as J,D as Q}from"./DynamicForm.js";import{u as ee}from"./index.js";import"./logo2.js";function te({steps:i,current:o}){const f=i.length,u=Math.min(Math.max(o,0),f-1),b=u/(f-1)*100;return e.jsxs("div",{className:"relative h-16",children:[e.jsx("div",{className:"absolute left-0 right-0 top-1/2 -translate-y-1/2 h-[2px] bg-gray-200 rounded-full","aria-hidden":!0}),e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 h-[2px] bg-blue-500 rounded-full transition-all duration-500 ease-out",style:{width:`${b}%`},"aria-hidden":!0}),e.jsx("ol",{className:"relative z-[1] grid grid-cols-4",children:i.map((l,p)=>{const x=p<u,s=p===u;return e.jsxs("li",{className:"relative flex flex-col items-center",children:[e.jsx("span",{className:`absolute top-1/2 -translate-y-1/2 -translate-y-[18px] flex h-8 w-8 items-center justify-center rounded-full text-sm font-semibold transition-all duration-300 ${x?"bg-blue-600 text-white shadow-sm":s?"bg-blue-100 text-blue-700 ring-2 ring-blue-200":"bg-gray-100 text-gray-500"}`,"aria-current":s?"step":void 0,children:p+1}),e.jsx("span",{className:`mt-12 text-xs font-medium ${s?"text-gray-900":"text-gray-500"}`,children:l.label})]},l.key)})})]})}function re({operators:i=[],selectedOperator:o,onSelect:f}){const[u,b]=d.useState(new Set),l=(s,h)=>{console.error(`âŒ Errore caricamento logo per ${s}:`,h),b(a=>new Set([...a,s]))},p=s=>{f(s)},x=i.flatMap(s=>{if(s.id==="SKY"||String(s.name).toUpperCase()==="SKY"){const h=s.skyVariants||[];console.log("ðŸ” SKY variants ricevute:",h);const a={3:"TV",8:"MOBILE",12:"BUSINESS",14:"BAR"},t=h.filter(r=>a[r.id]).map(r=>({id:`${s.id}::${a[r.id]}`,name:`SKY ${a[r.id]}`,logo:r.logo}));return console.log("âœ… SKY varianti espanse:",t),t}return[s]}).filter(s=>s.logo);return console.log("ðŸ“¸ Operatori con loghi finali:",x),x.length===0?null:e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:"Selezione rapida operatore"}),e.jsx("span",{className:"text-xs text-gray-500",children:"Click sul logo per selezionare"})]}),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"flex gap-3 overflow-x-auto pb-2 scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100",children:x.map(s=>{const h=o===s.id||typeof o=="string"&&o.startsWith(`${s.id}::`);return e.jsxs("button",{onClick:()=>p(s.id),className:`
                  flex-shrink-0 relative group
                  w-32 h-32 rounded-xl overflow-hidden
                  transition-all duration-200
                  ${h?"ring-4 ring-blue-500 shadow-lg scale-105":"ring-2 ring-gray-200 hover:ring-blue-300 hover:shadow-md hover:scale-102"}
                  bg-white p-3
                `,title:s.name,children:[u.has(s.id)?e.jsxs("div",{className:"w-full h-full flex flex-col items-center justify-center bg-gray-50",children:[e.jsx("div",{className:"text-3xl font-bold text-gray-300",children:s.name.charAt(0)}),e.jsx("div",{className:"text-xs text-gray-400 mt-1 text-center px-2",children:s.name})]}):e.jsx("img",{src:s.logo,alt:s.name,className:"w-full h-full object-contain",onError:()=>l(s.id,s.logo),loading:"lazy"}),h&&e.jsx("div",{className:"absolute top-1 right-1 w-5 h-5 bg-blue-500 rounded-full flex items-center justify-center",children:e.jsx("svg",{className:"w-3 h-3 text-white",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})})}),s.name.includes("SKY")&&s.name!=="SKY"&&e.jsx("div",{className:"absolute top-1 left-1 bg-blue-600 text-white text-[10px] font-bold px-1.5 py-0.5 rounded",children:s.name.replace("SKY ","")}),e.jsx("div",{className:"absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/70 to-transparent opacity-0 group-hover:opacity-100 transition-opacity p-2",children:e.jsx("p",{className:"text-xs font-medium text-white text-center truncate",children:s.name})})]},s.id)})}),e.jsx("div",{className:"absolute top-0 left-0 h-full w-8 bg-gradient-to-r from-white to-transparent pointer-events-none"}),e.jsx("div",{className:"absolute top-0 right-0 h-full w-8 bg-gradient-to-l from-white to-transparent pointer-events-none"})]})]})}function ae({operators:i=[],value:o,onChange:f}){const u=new Set(["KENA MOBILE","ASSISTENZA","RABONA"]),b=Array.isArray(i)?i.filter(l=>!u.has(String(l?.name||l?.label||"").toUpperCase())).flatMap(l=>String(l?.name||l?.label||"").toUpperCase()==="SKY"?[{id:`${l.id}::TV`,name:"SKY TV"},{id:`${l.id}::MOBILE`,name:"SKY MOBILE"},{id:`${l.id}::BUSINESS`,name:"SKY BUSINESS"},{id:`${l.id}::BAR`,name:"SKY BAR"}]:[{id:l.id,name:l.name}]):[];return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"1. Scegli operatore"}),e.jsxs("div",{className:"relative",children:[e.jsxs("select",{className:"w-full appearance-none rounded-xl border border-gray-200 bg-white py-3 pl-4 pr-10 text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",value:o||"",onChange:l=>f(l.target.value||null),children:[e.jsx("option",{value:"",children:"Seleziona..."}),b.map(l=>e.jsx("option",{value:l.id,children:l.name},l.id))]}),e.jsx("span",{className:"pointer-events-none absolute inset-y-0 right-3 flex items-center text-gray-400",children:"â–¾"})]})]})}function se({types:i=[],value:o,onChange:f}){return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"2. Scegli tipologia"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:i.map(u=>{const b=o===u.id;return e.jsx("button",{type:"button",onClick:()=>f(u.id),className:`px-3 py-2 rounded-xl border text-sm transition-all duration-200 ${b?"bg-blue-50 text-blue-700 border-blue-200 shadow-sm":"bg-white text-gray-700 border-gray-200 hover:bg-gray-50"}`,children:u.label},u.id)})})]})}function U({label:i,onClear:o}){return e.jsxs("span",{className:"inline-flex items-center gap-2 rounded-full bg-blue-50 text-blue-700 px-3 py-1.5 text-sm border border-blue-200",children:[i,o&&e.jsx("button",{type:"button",onClick:o,className:"ml-1 inline-flex h-5 w-5 items-center justify-center rounded-full hover:bg-blue-100 text-blue-700","aria-label":"Rimuovi",children:"Ã—"})]})}function ne(i){const o=Number(i);if(!Number.isFinite(o))return"â‚¬ 0,00";const f=o;return new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(f)}function ie({offer:i,onSelect:o}){return e.jsxs("div",{className:"rounded-2xl border border-gray-200 bg-white p-4 shadow-sm hover:shadow-md transition-shadow duration-200",children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-pink-600",children:i.brand||"Operatore"}),e.jsx("h3",{className:"mt-1 text-sm font-bold text-gray-900 leading-snug",children:i.title})]}),i.tag&&e.jsx("span",{className:"text-[10px] px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 border border-blue-200",children:i.tag})]}),e.jsx("p",{className:"text-xs text-gray-600 h-16 line-clamp-4",children:i.subtitle}),e.jsxs("div",{className:"mt-3 flex items-center justify-between",children:[e.jsx("span",{className:"inline-flex items-center justify-center rounded-full bg-blue-50 text-blue-700 border border-blue-200 px-3 py-1 text-sm font-semibold",children:ne(i.price)}),e.jsx("button",{type:"button",onClick:()=>o?.(i),className:"w-28 h-9 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-semibold",children:"Attiva"})]})]})}function le(){const[i,o]=d.useState([]),[f,u]=d.useState(!1),[b,l]=d.useState(null),p=()=>(l(null),u(!0),I.get("/api/operatori").then(x=>{const s=Array.isArray(x.data)?x.data:x.data?.data||[];console.log("ðŸ” Operatori ricevuti dal backend:",s);const h=s.map(r=>{if(typeof r=="string")return{id:r,name:r,logo:null};const g=r.id??r._id??r.value??r.operatorId??r.codice??r.code??String(r.id||r.value||r.operatorId||""),j=r.name??r.label??r.nome??r.denominazione??r.title??String(r.name||r.label||g),S=r.logo??r.logoLink??r.LogoLink??r.image??null,E=r.skyVariants||null;return{id:String(g),name:String(j),logo:S,skyVariants:E}}),a=new Set(["KENA MOBILE","ASSISTENZA","RABONA"]),t=h.filter(r=>!a.has(r.name.toUpperCase()));console.log("âœ… Operatori dopo filtro EXCLUDED:",t),o(t)}).catch(x=>{l(x.normalized||x)}).finally(()=>{u(!1)}));return d.useEffect(()=>{p()},[]),{data:i,loading:f,error:b,refetch:p}}function oe(i){const[o,f]=d.useState([]),[u,b]=d.useState(!1),[l,p]=d.useState(null),x=a=>{const t=String(a).toUpperCase();return t==="RESIDENZIALE"?"RES":t==="BUSINESS"?"BUS":t},s=a=>a.map(t=>{if(typeof t=="string")return{id:x(t),label:t};const r=t.label??t.nome??t.name??t.tipologia??t.tipo??t.id,g=x(t.code??t.codice??t.id??t.value??t.tipoId??r);return{id:String(g),label:String(r)}}),h=()=>{if(!i){f([]);return}return p(null),b(!0),I.get("/api/tipologie",{params:{operatore:i}}).then(a=>{const t=Array.isArray(a.data)?a.data:a.data?.data||[];f(s(t||[]))}).catch(a=>{p(a.normalized||a)}).finally(()=>{b(!1)})};return d.useEffect(()=>{h()},[i]),{data:o,loading:u,error:l,refetch:h}}function ce(i,o){const[f,u]=d.useState([]),[b,l]=d.useState(!1),[p,x]=d.useState(null),s=a=>a.map(t=>{const r=t.IDOfferta??t.id??t._id??t.offertaId,g=Object.prototype.hasOwnProperty.call(t,"Crediti")?Number(t.Crediti):void 0,j=Object.prototype.hasOwnProperty.call(t,"PrezzoCentesimi")?Number(t.PrezzoCentesimi):void 0,S=Object.prototype.hasOwnProperty.call(t,"CostoCentesimi")?Number(t.CostoCentesimi):void 0,E=Number(t.price??t.prezzo);let m=0;return Number.isFinite(j)?m=j/100:Number.isFinite(S)?m=S/100:Number.isFinite(g)?m=g>=100?g/100:g:Number.isFinite(E)?(m=E,Number.isInteger(m)&&m>=100&&(m=m/100)):m=0,{...t,id:String(r),brand:t.NomeOperatore??t.brand??t.operatore??t.operatorName??"Operatore",title:t.Titolo??t.title??t.nome??t.name??"",subtitle:t.DescrizioneBreve??t.description??t.descrizione??"",price:m,tag:t.categoria??t.Tipo??t.tag??void 0}}),h=async()=>{if(!i||!o){u([]);return}x(null),l(!0);try{const a=await I.get("/api/offerte",{params:{operatore:i,operatoreId:i,operator:i,tipologia:o,tipo:o,from:"attivazioni"}});let t=Array.isArray(a.data)?a.data:a.data?.data||[];if(!t||t.length===0)try{const r=await I.get(`/api/offerte/${i}`,{params:{tipologia:o,from:"attivazioni"}});t=Array.isArray(r.data)?r.data:r.data?.data||[]}catch{}u(s(t||[]))}catch(a){if(a?.normalized?.status===404)try{const t=await I.get(`/api/offerte/${i}`,{params:{tipologia:o,from:"attivazioni"}}),r=Array.isArray(t.data)?t.data:t.data?.data||[];u(s(r));return}catch{}x(a.normalized||a)}finally{l(!1)}};return d.useEffect(()=>{h()},[i,o]),{data:f,loading:b,error:p,refetch:h}}function pe(){const{user:i}=ee(),o=n=>(n||"").toString().trim().toLowerCase().replace(/[^a-z]/g,""),f=o(i?.role),u=(()=>{try{return o(localStorage.getItem("ruoloUtente"))}catch{return null}})(),b=f==="dealer"||u==="dealer",l=q(),{data:p=[],loading:x,error:s,refetch:h}=le(),[a,t]=d.useState(null),r=d.useMemo(()=>{if(!a||typeof a!="string")return{baseId:a,sub:null};const n=a.split("::");return n.length===2?{baseId:n[0],sub:n[1]}:{baseId:a,sub:null}},[a]),{data:g=[],loading:j,error:S,refetch:E}=oe(r.baseId),[m,O]=d.useState(null),{data:w=[],loading:D,error:M,refetch:K}=ce(r.baseId,m),[N,k]=d.useState(null),{data:R,loading:Y,error:P,refetch:V}=J(N),{data:z}=G(b),v=d.useMemo(()=>{if(!Array.isArray(g))return[];const n=(r.sub||"").toUpperCase();return n?n==="TV"||n==="MOBILE"?g.filter(c=>String(c.id).toUpperCase().includes("RES")):n==="BUSINESS"||n==="BAR"?g.filter(c=>String(c.id).toUpperCase().includes("BUS")):g:g},[g,r.sub]);d.useEffect(()=>{a&&!m&&Array.isArray(v)&&v.length===1&&O(v[0].id),m&&Array.isArray(v)&&v.length>0&&(v.some(c=>c.id===m)||O(null))},[a,m,v]);const _=d.useMemo(()=>a?m?N?3:2:1:0,[a,m,N]),X=[{key:"operatore",label:"Operatore"},{key:"tipologia",label:"Tipologia"},{key:"offerta",label:"Offerta"},{key:"compilazione",label:"Compilazione"}],B=d.useMemo(()=>{if(!Array.isArray(w)||w.length===0)return w;const n=(r.sub||"").toUpperCase();if(!n)return w;const A={TV:3,MOBILE:8,BUSINESS:12,BAR:14}[n];return A?w.filter(C=>{const W=C.IdOperatore??C.IDOperatore??C.idOperatore??C.operatoreId;return String(W)===String(A)}):w},[w,r.sub]),$=d.useMemo(()=>{const n=p.find(C=>String(C.id)===String(r.baseId))?.name;if(!n)return;if(!r.sub)return n;const c=String(r.sub).toUpperCase();return`${n} ${c==="TV"?"TV":c==="MOBILE"?"MOBILE":c==="BUSINESS"?"BUSINESS":c==="BAR"?"BAR":c}`},[p,r.baseId,r.sub]),Z=g.find(n=>n.id===m)?.label,y=d.useMemo(()=>N?B.find(n=>n.id===N):null,[N,B]),F=d.useMemo(()=>{if(!y)return;const n=y.name||y.title||y.Titolo||"Offerta",c=y.price||y.Crediti||y.crediti||0;return`${n} - ${Number(c).toFixed(2)}â‚¬`},[y]),L=()=>{O(null),k(null)};return e.jsx(H,{title:"Attivazioni",children:e.jsxs("div",{className:"rounded-2xl bg-white p-6 sm:p-8 shadow-sm mt-4 flex flex-col",children:[e.jsxs("div",{className:"mb-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900",children:"Attivazioni"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Crea una nuova attivazione in pochi passaggi."})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"hidden sm:inline text-xs text-gray-500",children:"Salvataggio automatico"})})]}),e.jsx("div",{className:"mb-6",children:e.jsx(te,{steps:X,current:_})}),e.jsxs("div",{className:"mb-4 flex flex-wrap gap-2",children:[a&&e.jsx(U,{label:`Operatore: ${$}`,onClear:()=>{t(null),L()}}),m&&e.jsx(U,{label:`Tipologia: ${Z}`,onClear:()=>O(null)}),N&&F&&e.jsx(U,{label:`Offerta: ${F}`,onClear:()=>k(null)})]}),!a&&e.jsxs("div",{className:"mb-6",children:[e.jsx(re,{operators:p,selectedOperator:a,onSelect:n=>{t(n||null),L()}}),e.jsx(ae,{operators:p,value:a,onChange:n=>{t(n||null),L()}}),x&&e.jsx("div",{className:"mt-2 space-y-2",children:[...Array(3)].map((n,c)=>e.jsx("div",{className:"h-5 bg-gray-100 rounded animate-pulse"},c))}),s&&e.jsxs("div",{className:"mt-2 text-xs text-red-600 flex items-center justify-between",children:[e.jsx("span",{children:"Errore nel caricamento operatori. Verifica token o API."}),e.jsx("button",{onClick:h,className:"ml-3 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Riprova"})]})]}),a&&!m&&e.jsxs("div",{className:"mb-6",children:[e.jsx(se,{types:v,value:m,onChange:O}),j&&e.jsx("div",{className:"mt-2 space-y-2",children:[...Array(2)].map((n,c)=>e.jsx("div",{className:"h-5 bg-gray-100 rounded animate-pulse"},c))}),S&&e.jsxs("div",{className:"mt-2 text-xs text-red-600 flex items-center justify-between",children:[e.jsx("span",{children:"Errore nel caricamento tipologie."}),e.jsx("button",{onClick:E,className:"ml-3 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Riprova"})]}),!j&&!S&&g.length===0&&e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Nessuna tipologia disponibile per questo operatore."})]}),a&&m&&!N&&e.jsx("div",{className:"mt-2 flex-1 min-h-0",children:e.jsxs("div",{className:"h-full overflow-y-auto overscroll-contain pr-1",children:[D&&e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:[...Array(4)].map((n,c)=>e.jsx("div",{className:"h-24 rounded-lg bg-gray-100 animate-pulse"},c))}),M&&e.jsxs("div",{className:"py-4 text-sm text-red-600 flex items-center justify-between",children:[e.jsx("span",{children:"Errore nel caricamento offerte."}),e.jsx("button",{onClick:K,className:"ml-3 px-3 py-1.5 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Riprova"})]}),!D&&!M&&(B.length===0?e.jsx("div",{className:"py-10 text-center text-sm text-gray-500",children:"Nessuna offerta trovata"}):e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:B.map(n=>e.jsx(ie,{offer:n,onSelect:()=>{try{if(b){const c=Number(n.price||0),A=Number((z&&typeof z=="object"?z.credito:z)??0);if(Number.isFinite(c)&&Number.isFinite(A)&&c>0&&A<c){T.error("FONDI INSUFFICIENTI. RICARICA PLAFOND"),l("/dealer",{state:{openTopUp:!0},replace:!1});return}}}catch{}k(n.id)}},n.id))}))]})}),N&&e.jsxs("div",{className:"mt-4 flex-1",children:[y&&e.jsx("div",{className:"mb-3 rounded-lg border border-blue-200 bg-gradient-to-r from-blue-50 to-indigo-50 p-3 shadow-sm",children:e.jsxs("div",{className:"flex items-start gap-3",children:[y.logo&&e.jsx("div",{className:"flex-shrink-0",children:e.jsx("img",{src:y.logo,alt:y.brand,className:"h-10 w-10 object-contain rounded bg-white p-1"})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-[10px] font-semibold text-blue-600 uppercase mb-0.5",children:y.brand||$}),e.jsx("h3",{className:"text-sm font-bold text-gray-900 leading-tight mb-1",children:y.title}),e.jsx("p",{className:"text-xs text-gray-600 leading-snug line-clamp-2",children:y.subtitle})]}),e.jsx("div",{className:"flex-shrink-0",children:e.jsxs("div",{className:"inline-flex items-center justify-center rounded-full bg-blue-600 text-white px-3 py-1.5 text-sm font-bold whitespace-nowrap",children:[Number(y.price||0).toFixed(2),"â‚¬"]})})]})})]})}),e.jsxs("div",{className:"pr-1 pb-8",children:[Y&&e.jsx("div",{className:"text-sm text-gray-500",children:"Caricamento moduloâ€¦"}),P&&e.jsxs("div",{className:"mt-2 text-sm text-red-600 flex items-center justify-between",children:[e.jsx("span",{children:"Errore nel caricamento del modulo."}),e.jsx("button",{onClick:V,className:"ml-3 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Riprova"})]}),!!R&&e.jsx(Q,{template:R,idOfferta:N,onSuccess:n=>{T.success("Attivazione inviata")},onError:n=>{T.error(n?.message||"Errore invio")}})]})]})]})})}export{pe as default};
