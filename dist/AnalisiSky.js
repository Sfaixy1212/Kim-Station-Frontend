import{r as o,j as e,i as E,k as V,l as B,m as A,Y as f,o as T,p as R,q as N,s as te,t as $,v as se,z as H}from"./vendor.js";import{S as ae}from"./Topbar2.js";import{C as x}from"./Card.js";import{f as ie,h as re}from"./index.js";const ne=[{value:"DEALER",label:"Dealer"},{value:"AGENTE",label:"Agenti"}],le=[{value:3,label:"Ultimi 3 mesi"},{value:6,label:"Ultimi 6 mesi"},{value:9,label:"Ultimi 9 mesi"},{value:12,label:"Ultimi 12 mesi"}],r=i=>new Intl.NumberFormat("it-IT",{maximumFractionDigits:0}).format(Number(i||0)),w=i=>new Intl.NumberFormat("it-IT",{minimumFractionDigits:2,maximumFractionDigits:2}).format(Number(i||0)),Q=i=>new Date(i).toLocaleDateString("it-IT",{month:"short",year:"numeric"}),q=i=>{if(!i)return"—";const c=new Date(i);return Number.isNaN(c.getTime())?"—":c.toLocaleDateString("it-IT",{day:"2-digit",month:"short",year:"numeric"})+" "+c.toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"})},oe=()=>{const i=new Date,c=new Date(i.getFullYear(),i.getMonth()-1,1);return{year:c.getFullYear(),month:c.getMonth()+1}},X=["#2563EB","#10B981","#F97316","#8B5CF6","#EF4444","#0EA5E9","#14B8A6","#F59E0B"];function ge(){const[i,c]=o.useState("DEALER"),[{year:v,month:S},M]=o.useState(oe),[D,J]=o.useState(6),[P,L]=o.useState(!1),[I,O]=o.useState(!1),[y,C]=o.useState([]),[g,F]=o.useState([]),[k,K]=o.useState(""),[b,Y]=o.useState(""),u=o.useMemo(()=>y.length?y.reduce((t,s)=>{const j=Number(s.TotAttivazioni||0),h=Number(s.AttivazioniBusiness||0),z=Number(s.AttivazioniRes||0),a=Number(s.PunteggioTotale||0),l=Number(s.SimSkyVendute||0),n=s.LastOrderDate?new Date(s.LastOrderDate):null;return t.totAttivazioni+=j,t.business+=h,t.res+=z,t.punteggioTotale+=a,t.simSky+=l,n&&!Number.isNaN(n.getTime())&&(!t.lastOrderDate||n>t.lastOrderDate)&&(t.lastOrderDate=n),t},{totAttivazioni:0,business:0,res:0,punteggioTotale:0,simSky:0,lastOrderDate:null}):{totAttivazioni:0,business:0,res:0,punteggioTotale:0,simSky:0,lastOrderDate:null},[y]),W=async()=>{try{L(!0),K("");const t=await ie({scope:i,year:v,month:S});C(t?.rows||[])}catch(t){console.error("[AnalisiSky] loadRanking error:",t);const s=t?.message||"Errore durante il caricamento del ranking SKY";K(s),H.error(s),C([])}finally{L(!1)}},G=async()=>{try{O(!0),Y("");const t=await re({scope:i,monthsBack:D});F(t?.rows||[])}catch(t){console.error("[AnalisiSky] loadTrend error:",t);const s=t?.message||"Errore durante il caricamento del trend SKY";Y(s),H.error(s),F([])}finally{O(!1)}};o.useEffect(()=>{W()},[i,v,S]),o.useEffect(()=>{G()},[i,D]);const p=o.useMemo(()=>[...y].sort((t,s)=>Number(s.PunteggioTotale||0)-Number(t.PunteggioTotale||0)),[y]),U=o.useMemo(()=>p.slice(0,10).map(t=>({name:t.EntityName,business:Number(t.AttivazioniBusiness||0),res:Number(t.AttivazioniRes||0)})),[p]),d=o.useMemo(()=>p.reduce((t,s)=>(t.skyGlass+=Number(s.SkyGlass||0),t.triplePlay+=Number(s.TriplePlay||0),t.tvOnly+=Number(s.TvOnly||0),t.wifiBusiness+=Number(s.WifiBusiness||0),t.wifiRes+=Number(s.WifiRes||0),t.mobile+=Number(s.Mobile||0),t.barBus+=Number(s.BarBus||0),t.bbus+=Number(s.BBus||0),t.prova+=Number(s.ProvaSky||0),t),{skyGlass:0,triplePlay:0,tvOnly:0,wifiBusiness:0,wifiRes:0,mobile:0,barBus:0,bbus:0,prova:0}),[p]),_=o.useMemo(()=>[{type:"Sky Glass",value:d.skyGlass},{type:"Triple Play",value:d.triplePlay},{type:"TV Only",value:d.tvOnly},{type:"WiFi Business",value:d.wifiBusiness},{type:"WiFi Res",value:d.wifiRes},{type:"Mobile",value:d.mobile},{type:"Bar Bus",value:d.barBus},{type:"B&B Bus",value:d.bbus},{type:"Prova Sky",value:d.prova}].filter(t=>t.value>0),[d]),m=o.useMemo(()=>{if(!g.length)return{type:i==="DEALER"?"dealer":"agent",chartData:[],series:[]};if(i==="DEALER")return{type:"dealer",chartData:[...g].filter(n=>n.EntityId==="DEALER:ALL").sort((n,ee)=>new Date(n.MonthStart)-new Date(ee.MonthStart)).map(n=>({label:Q(n.MonthStart),monthStart:n.MonthStart,attivazioni:Number(n.TotAttivazioni||0),punteggio:Number(n.PunteggioTotale||0),sim:Number(n.SimSkyVendute||0)})),series:[{key:"punteggio",name:"Punteggio totale"}]};const s=[...g.reduce((a,l)=>{const n=l.EntityName;return a.set(n,(a.get(n)||0)+Number(l.PunteggioTotale||0)),a},new Map).entries()].sort((a,l)=>l[1]-a[1]).slice(0,5).map(([a])=>a),j=[...new Set(g.map(a=>a.MonthStart))].sort((a,l)=>new Date(a)-new Date(l)),h=j.map(a=>{const l={label:Q(a),monthStart:a};return s.forEach(n=>{l[n]=0}),l});g.forEach(a=>{if(!s.includes(a.EntityName))return;const l=j.indexOf(a.MonthStart);l!==-1&&(h[l][a.EntityName]=Number(a.PunteggioTotale||0))});const z=s.map((a,l)=>({key:a,name:a,color:X[l%X.length]}));return{type:"agent",chartData:h,series:z}},[g,i]),Z=new Date(v||new Date().getFullYear(),(S||1)-1,1).toLocaleDateString("it-IT",{month:"long",year:"numeric"});return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(ae,{}),e.jsx("main",{className:"px-4 sm:px-6 lg:px-8 py-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("header",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-semibold text-gray-900",children:"Analisi SKY"}),e.jsx("p",{className:"text-sm text-gray-500",children:"Ranking e trend delle attivazioni SKY per rete SuperMaster."})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsx("select",{value:i,onChange:t=>c(t.target.value),className:"text-sm border-gray-300 rounded-md px-3 py-2 bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500",children:ne.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx("select",{value:S,onChange:t=>M(s=>({...s,month:Number(t.target.value)})),className:"text-sm border-gray-300 rounded-md px-3 py-2 bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500",children:Array.from({length:12},(t,s)=>s+1).map(t=>e.jsx("option",{value:t,children:new Date(2e3,t-1,1).toLocaleDateString("it-IT",{month:"long"})},t))}),e.jsx("select",{value:v,onChange:t=>M(s=>({...s,year:Number(t.target.value)})),className:"text-sm border-gray-300 rounded-md px-3 py-2 bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500",children:Array.from({length:4},(t,s)=>{const h=new Date().getFullYear()-s;return e.jsx("option",{value:h,children:h},h)})}),e.jsx("select",{value:D,onChange:t=>J(Number(t.target.value)),className:"text-sm border-gray-300 rounded-md px-3 py-2 bg-white shadow-sm focus:ring-blue-500 focus:border-blue-500",children:le.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsxs("button",{onClick:()=>{W(),G()},className:"inline-flex items-center gap-2 px-3 py-2 text-sm font-medium rounded-md border border-gray-300 bg-white shadow-sm hover:bg-gray-50",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"currentColor",className:"w-4 h-4",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M16.023 9.348h4.992v-4.99m0 0l-3.535 3.535A9 9 0 104.5 19.5"})}),"Aggiorna"]})]})]}),e.jsxs("section",{children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("span",{className:"text-xs uppercase tracking-wide text-gray-500",children:"Periodo"}),e.jsx("div",{className:"text-lg font-medium text-gray-900",children:Z})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs(x,{className:"bg-white",children:[e.jsx("div",{className:"text-xs uppercase text-gray-500",children:"Totale attivazioni"}),e.jsx("div",{className:"text-2xl font-semibold text-gray-900 mt-1",children:r(u.totAttivazioni)})]}),e.jsxs(x,{className:"bg-white",children:[e.jsx("div",{className:"text-xs uppercase text-gray-500",children:"Business (SHP)"}),e.jsx("div",{className:"text-2xl font-semibold text-gray-900 mt-1",children:r(u.business)})]}),e.jsxs(x,{className:"bg-white",children:[e.jsx("div",{className:"text-xs uppercase text-gray-500",children:"Residenziale (RES)"}),e.jsx("div",{className:"text-2xl font-semibold text-gray-900 mt-1",children:r(u.res)})]}),e.jsxs(x,{className:"bg-white",children:[e.jsx("div",{className:"text-xs uppercase text-gray-500",children:"Punteggio totale"}),e.jsx("div",{className:"text-2xl font-semibold text-gray-900 mt-1",children:w(u.punteggioTotale)})]}),e.jsxs(x,{className:"bg-white",children:[e.jsx("div",{className:"text-xs uppercase text-gray-500",children:"SIM SKY vendute"}),e.jsx("div",{className:"text-2xl font-semibold text-gray-900 mt-1",children:r(u.simSky)})]}),e.jsxs(x,{className:"bg-white",children:[e.jsx("div",{className:"text-xs uppercase text-gray-500",children:"Ultima attivazione"}),e.jsx("div",{className:"text-base font-medium text-gray-900 mt-1",children:q(u.lastOrderDate)})]})]}),e.jsx(x,{title:"Legenda punteggi SKY",className:"mt-6",children:e.jsxs("div",{className:"space-y-3 text-sm text-gray-600",children:[e.jsx("p",{children:"Punteggio calcolato sommando il valore assegnato a ciascuna tipologia di offerta attiva nel periodo:"}),e.jsxs("ul",{className:"list-disc list-inside space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Sky Glass"}),": 5 punti"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Triple Play"}),": 4 punti"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"TV Only"}),": 3 punti"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"WiFi Business / Res"}),": 7 punti"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Mobile"}),": 2 punti"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Bar / B&B Business"}),": 10 punti"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Prova Sky"}),": 0 punti"]})]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Le SIM SKY vendute derivano dal pacchetto dedicato (`idOfferta = 148`, 5 SIM per ordine) conteggiato su `tbOrdiniProdotti`."})]})})]}),e.jsxs("section",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4",children:[e.jsx(x,{title:"Mix Business vs Res",subtitle:`Top 10 ${i==="DEALER"?"dealer":"agenti"} per punteggio`,className:"h-full",children:U.length?e.jsx("div",{className:"h-80",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(V,{data:U,margin:{top:16,right:24,left:0,bottom:8},children:[e.jsx(B,{strokeDasharray:"3 3",stroke:"#E5E7EB"}),e.jsx(A,{dataKey:"name",tick:{fontSize:10},interval:0,angle:-35,textAnchor:"end",height:80}),e.jsx(f,{allowDecimals:!1,tick:{fontSize:12}}),e.jsx(T,{formatter:(t,s)=>[r(t),s==="business"?"Business":"Res"]}),e.jsx(R,{wrapperStyle:{fontSize:12}}),e.jsx(N,{dataKey:"business",stackId:"mix",fill:"#1D4ED8",radius:[4,4,0,0],name:"Business"}),e.jsx(N,{dataKey:"res",stackId:"mix",fill:"#16A34A",radius:[4,4,0,0],name:"Res"})]})})}):e.jsx("p",{className:"text-sm text-gray-500",children:"Nessun dato disponibile per il grafico."})}),e.jsx(x,{title:"Distribuzione tipologie",subtitle:"Somma attivazioni per categoria",className:"h-full",children:_.length?e.jsx("div",{className:"h-80",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(V,{data:_,margin:{top:16,right:24,left:0,bottom:8},children:[e.jsx(B,{strokeDasharray:"3 3",stroke:"#E5E7EB"}),e.jsx(A,{dataKey:"type",tick:{fontSize:11},interval:0,angle:-30,textAnchor:"end",height:70}),e.jsx(f,{allowDecimals:!1,tick:{fontSize:12}}),e.jsx(T,{formatter:t=>[r(t),"Attivazioni"]}),e.jsx(N,{dataKey:"value",fill:"#6366F1",radius:[4,4,0,0]})]})})}):e.jsx("p",{className:"text-sm text-gray-500",children:"Nessuna attivazione nel periodo selezionato."})})]}),e.jsxs("section",{className:"bg-white shadow-sm border border-gray-200 rounded-xl",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Trend multi-mese"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["Analisi temporale degli ultimi ",D," mesi completati."]})]}),I&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx("div",{className:"h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),"Caricamento trend..."]})]}),e.jsxs("div",{className:"p-4",children:[b&&e.jsx("p",{className:"text-sm text-rose-600",children:b}),!b&&!m.chartData.length&&!I&&e.jsx("p",{className:"text-sm text-gray-500",children:"Nessun dato disponibile per il trend nel periodo selezionato."}),!b&&m.type==="dealer"&&m.chartData.length>0&&e.jsx("div",{className:"h-80",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(te,{data:m.chartData,margin:{top:16,right:24,left:0,bottom:8},children:[e.jsx(B,{strokeDasharray:"3 3",stroke:"#E5E7EB"}),e.jsx(A,{dataKey:"label",tick:{fontSize:12}}),e.jsx(f,{yAxisId:"left",allowDecimals:!1,tick:{fontSize:12}}),e.jsx(f,{yAxisId:"right",orientation:"right",tick:{fontSize:12}}),e.jsx(T,{formatter:(t,s)=>s==="attivazioni"?[r(t),"Attivazioni"]:s==="sim"?[r(t),"SIM SKY"]:[w(t),"Punteggio"]}),e.jsx(R,{wrapperStyle:{fontSize:12}}),e.jsx(N,{yAxisId:"left",dataKey:"attivazioni",barSize:28,fill:"#22C55E",radius:[4,4,0,0],name:"Attivazioni"}),e.jsx(N,{yAxisId:"left",dataKey:"sim",barSize:20,fill:"#0EA5E9",radius:[4,4,0,0],name:"SIM SKY"}),e.jsx($,{yAxisId:"right",type:"monotone",dataKey:"punteggio",stroke:"#EF4444",strokeWidth:2,dot:{r:3},name:"Punteggio"})]})})}),!b&&m.type==="agent"&&m.chartData.length>0&&e.jsx("div",{className:"h-80",children:e.jsx(E,{width:"100%",height:"100%",children:e.jsxs(se,{data:m.chartData,margin:{top:16,right:24,left:0,bottom:8},children:[e.jsx(B,{strokeDasharray:"3 3",stroke:"#E5E7EB"}),e.jsx(A,{dataKey:"label",tick:{fontSize:12}}),e.jsx(f,{allowDecimals:!1,tick:{fontSize:12}}),e.jsx(T,{formatter:t=>[w(t),"Punteggio"]}),e.jsx(R,{wrapperStyle:{fontSize:12}}),m.series.map(t=>e.jsx($,{type:"monotone",dataKey:t.key,name:t.name,stroke:t.color,strokeWidth:2,dot:{r:3},connectNulls:!0},t.key))]})})})]})]}),e.jsxs("section",{className:"bg-white shadow-sm border border-gray-200 rounded-xl",children:[e.jsxs("div",{className:"px-4 py-3 border-b border-gray-200 flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-lg font-semibold text-gray-900",children:["Classifica ",i==="DEALER"?"dealer":"agenti"]}),e.jsx("p",{className:"text-xs text-gray-500",children:"Ordine per punteggio totale con dettaglio tipologia e SIM vendute."})]}),P&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx("div",{className:"h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full animate-spin"}),"Caricamento..."]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-xs uppercase text-gray-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"#"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:i==="DEALER"?"Dealer":"Agente"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Tot"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Business"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Res"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Glass"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Triple"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"WiFi BUS"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"WiFi RES"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Mobile"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Bar BUS"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"B&B BUS"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Prova"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"SIM"}),e.jsx("th",{className:"px-4 py-3 text-right font-semibold",children:"Punteggio"}),e.jsx("th",{className:"px-4 py-3 text-left font-semibold",children:"Ultimo ordine"})]})}),e.jsxs("tbody",{className:"divide-y divide-gray-100",children:[k&&e.jsx("tr",{children:e.jsx("td",{colSpan:16,className:"px-4 py-6 text-center text-sm text-rose-600",children:k})}),!k&&!P&&p.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:16,className:"px-4 py-6 text-center text-sm text-gray-500",children:"Nessun dato disponibile per il periodo selezionato."})}),!k&&p.map((t,s)=>e.jsxs("tr",{className:s===0?"bg-yellow-50/60":"",children:[e.jsx("td",{className:"px-4 py-3 text-xs font-semibold text-gray-500",children:s+1}),e.jsx("td",{className:"px-4 py-3 text-sm font-medium text-gray-900",children:t.EntityName}),e.jsx("td",{className:"px-4 py-3 text-right font-semibold text-gray-900",children:r(t.TotAttivazioni)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.AttivazioniBusiness)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.AttivazioniRes)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.SkyGlass)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.TriplePlay)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.WifiBusiness)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.WifiRes)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.Mobile)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.BarBus)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.BBus)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.ProvaSky)}),e.jsx("td",{className:"px-4 py-3 text-right text-gray-700",children:r(t.SimSkyVendute)}),e.jsx("td",{className:"px-4 py-3 text-right text-blue-700 font-semibold",children:w(t.PunteggioTotale)}),e.jsx("td",{className:"px-4 py-3 text-sm text-gray-600",children:q(t.LastOrderDate)})]},`${t.EntityId}-${s}`))]})]})})]})]})})]})}export{ge as default};
