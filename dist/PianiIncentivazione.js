import{r as o,j as e,z as r}from"./vendor.js";import{C as J}from"./Card.js";import{g as $,d as A}from"./index.js";import{S as O}from"./Topbar2.js";import{t as w,s as k,e as E,r as _}from"./rateizzazioni.js";function M(){const[i,h]=o.useState("fastweb_tlc"),[c,y]=o.useState(()=>{const a=new Date;return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`}),[v,g]=o.useState("bozza"),[d,l]=o.useState(""),[x,u]=o.useState(!1),b=a=>{const t=String(a||"").toLowerCase();return t==="fastweb_tlc"||t==="tlc"?w:t==="sky"?k:t==="energia"||t==="energy"?E:t==="rate"||t==="rateizzazioni"?_:w};o.useEffect(()=>{let a=null,t=null;try{const s=new URLSearchParams(window.location.search);a=s.get("plan"),t=s.get("period"),a&&h(a),t&&y(t)}catch{}try{if(!d){const s=b(a||i);l(JSON.stringify(s,null,2))}}catch{}},[]),o.useEffect(()=>{d||l(JSON.stringify(b(i),null,2))},[i]);const z=async()=>{try{u(!0);const a=await $(`/supermaster/piani-incentivi/config?plan=${encodeURIComponent(i)}&period=${encodeURIComponent(c)}`);if(a?.data_json)g(a.status||"bozza"),l(JSON.stringify(a.data_json,null,2)),r.success("Piano caricato");else{r("Nessun piano trovato: uso template");const t=b(i);l(JSON.stringify({...t,plan_key:i,period:c},null,2))}}catch(a){console.error("Load plan error",a),r.error("Errore caricamento piano")}finally{u(!1)}},j=async(a=!1)=>{try{u(!0);let t;try{t=JSON.parse(d)}catch{r.error("JSON non valido");return}if(!t||typeof t!="object"){r.error("JSON mancante o non valido");return}const s=[];if((!t.brand||typeof t.brand!="object")&&s.push("brand mancante o non valido"),!Array.isArray(t.sections)||t.sections.length===0?s.push("sections deve essere un array non vuoto"):t.sections.forEach((n,P)=>{const p=n?.id||`#${P+1}`;if(!n||typeof n!="object"){s.push(`section ${p}: non valida`);return}if((!n.table||!Array.isArray(n.table.columns)||n.table.columns.length===0)&&s.push(`section ${p}: tabella senza colonne`),!n.table||!Array.isArray(n.table.rows))s.push(`section ${p}: tabella senza righe`);else if(Array.isArray(n.table.columns)){const S=n.table.columns.length;(n.table.rows||[]).forEach((m,C)=>{(!Array.isArray(m)||m.length!==S)&&s.push(`section ${p}: riga ${C+1} ha ${Array.isArray(m)?m.length:0} celle, attese ${S}`)})}}),s.length){r.error(`Correggi il JSON:
- ${s.slice(0,5).join(`
- `)}`);return}const N={plan_key:i,period:c,status:a?"pubblicato":v||"bozza",data_json:t},f=await A("/supermaster/piani-incentivi/config",{method:"PUT",body:JSON.stringify(N)});f?.success?(r.success(a?"Piano pubblicato":"Piano salvato"),g(f?.row?.status||N.status),l(JSON.stringify(f?.row?.data_json||t,null,2))):r("Risposta ricevuta")}catch(t){console.error("Save plan error",t),r.error("Errore salvataggio piano")}finally{u(!1)}};return e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50",children:[e.jsx(O,{}),e.jsx("div",{className:"bg-gradient-to-r from-indigo-600 via-purple-600 to-blue-600 text-white py-8",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h1",{className:"text-4xl font-bold mb-2",children:"ðŸŽ¯ Piani Incentivazione"}),e.jsx("p",{className:"text-xl opacity-90",children:"Crea piani incentivazione personalizzati per i tuoi dealer"})]})})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsx("div",{className:"grid grid-cols-1 gap-8",children:e.jsxs(J,{title:"ðŸ—‚ï¸ Configuratore Piano (JSON in DB)",className:"border-l-4 border-l-indigo-500",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Plan Key"}),e.jsx("input",{value:i,onChange:a=>h(a.target.value),className:"w-full px-3 py-2 border rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Periodo (YYYY-MM)"}),e.jsx("input",{value:c,onChange:a=>y(a.target.value),className:"w-full px-3 py-2 border rounded-lg"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Stato"}),e.jsxs("select",{value:v,onChange:a=>g(a.target.value),className:"w-full px-3 py-2 border rounded-lg",children:[e.jsx("option",{value:"bozza",children:"bozza"}),e.jsx("option",{value:"pubblicato",children:"pubblicato"})]})]}),e.jsxs("div",{className:"flex items-end gap-2",children:[e.jsx("button",{onClick:z,disabled:x,className:"px-4 py-2 bg-blue-600 text-white rounded-lg disabled:opacity-50",children:"Carica"}),e.jsx("button",{onClick:()=>j(!1),disabled:x,className:"px-4 py-2 bg-emerald-600 text-white rounded-lg disabled:opacity-50",children:"Salva"}),e.jsx("button",{onClick:()=>j(!0),disabled:x,className:"px-4 py-2 bg-purple-600 text-white rounded-lg disabled:opacity-50",children:"Pubblica"})]})]}),e.jsx("textarea",{value:d,onChange:a=>l(a.target.value),rows:22,className:"w-full font-mono text-sm p-3 border rounded-lg",placeholder:"Incolla qui il JSON del piano (brand, sections[{title,notes?,table{columns,rows},footnotes?}])"}),e.jsxs("p",{className:"text-xs text-gray-500 mt-2",children:["Suggerimento: copia il contenuto di ",e.jsx("code",{children:"src/data/incentivi/tlc.json"})," e modifica solo i valori necessari."]})]})})})]})}export{M as default};
