import{r as x,j as e,z}from"./vendor.js";import{D as B}from"./DashboardLayout.js";import{u as U,g as L,p as Y}from"./index.js";const D=["RAFFAELE","LUIGI","GIACOMO","ARMANDO","GABRIELE"],H="RAFFAELE";function P(s){if(!s)return"-";try{const n=new Date(s);if(!isNaN(n.getTime())){const c=String(n.getDate()).padStart(2,"0"),d=String(n.getMonth()+1).padStart(2,"0"),t=n.getFullYear();return`${c}/${d}/${t}`}const r=String(s),g=r.match(/^(\d{4})[-/]?(\d{2})[-/]?(\d{2})/);return g?`${g[3]}/${g[2]}/${g[1]}`:r}catch{return"-"}}function _({label:s,value:n,color:r="blue"}){const g={blue:"bg-blue-50 text-blue-700 border-blue-100",emerald:"bg-emerald-50 text-emerald-700 border-emerald-100",amber:"bg-amber-50 text-amber-700 border-amber-100",gray:"bg-gray-50 text-gray-700 border-gray-100"},c=g[r]||g.blue;return e.jsxs("div",{className:`inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs border ${c}`,children:[e.jsx("span",{className:"font-medium whitespace-nowrap",children:s}),e.jsx("span",{className:"font-semibold",children:n??"-"})]})}async function O({agente:s,year:n,month:r}){const g=new URLSearchParams({agente:s,year:String(n),month:String(r)});return await L(`/supermaster/report-agente?${g.toString()}`)}async function G({agente:s,year:n,month:r}){const g=new URLSearchParams({agente:s,year:String(n),month:String(r)});try{const c=await L(`/supermaster/report-agente/dettagli-ordini?${g.toString()}`),d=Array.isArray(c?.rows)?c.rows:[],t=d.some(m=>(m.provincia||m.Provincia)&&(m.segmento||m.Segmento)&&(m.categoria||m.Categoria)&&(m.attivazioni!=null||m.Attivazioni!=null));if(d.length>0&&t)return c}catch{}return await L(`/supermaster/report-agente/dettagli?${g.toString()}`)}async function $({agente:s,year:n,month:r}){const g=new URLSearchParams({agente:s,year:String(n),month:String(r)});return await L(`/supermaster/report-agente/province-distrib?${g.toString()}`)}async function V(){return typeof window<"u"&&window.Chart||await new Promise((s,n)=>{const r=document.createElement("script");r.src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js",r.async=!0,r.onload=s,r.onerror=()=>n(new Error("Chart.js CDN load failed")),document.head.appendChild(r)}),window.Chart}function W({value:s,onChange:n,onLoad:r,loading:g}){const c=x.useMemo(()=>[{v:1,l:"Gen"},{v:2,l:"Feb"},{v:3,l:"Mar"},{v:4,l:"Apr"},{v:5,l:"Mag"},{v:6,l:"Giu"},{v:7,l:"Lug"},{v:8,l:"Ago"},{v:9,l:"Set"},{v:10,l:"Ott"},{v:11,l:"Nov"},{v:12,l:"Dic"}],[]),d=x.useMemo(()=>{const t=new Date().getFullYear();return[t-2,t-1,t,t+1]},[]);return e.jsxs("div",{className:"flex items-end gap-2 flex-wrap",children:[e.jsxs("div",{className:"flex flex-col text-sm",children:[e.jsx("label",{htmlFor:"sel-mese",className:"text-gray-500",children:"Mese"}),e.jsx("select",{id:"sel-mese",className:"border rounded px-2 py-1",value:s.month,onChange:t=>n({...s,month:Number(t.target.value)}),children:c.map(t=>e.jsx("option",{value:t.v,children:t.l},t.v))})]}),e.jsxs("div",{className:"flex flex-col text-sm",children:[e.jsx("label",{htmlFor:"sel-anno",className:"text-gray-500",children:"Anno"}),e.jsx("select",{id:"sel-anno",className:"border rounded px-2 py-1",value:s.year,onChange:t=>n({...s,year:Number(t.target.value)}),children:d.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsx("button",{type:"button",onClick:r,disabled:g,className:"ml-2 mt-5 inline-flex items-center rounded bg-blue-600 text-white px-3 py-1.5 text-sm disabled:opacity-60",children:g?"Caricamento…":"Carica"})]})}function Z({agente:s,year:n,month:r}){const[g,c]=x.useState(!1),[d,t]=x.useState(null),[m,N]=x.useState({auto:null,pura:null});x.useEffect(()=>{let i=!0;return(async()=>{try{c(!0);const p=await O({agente:s,year:n,month:r}),E=(a,l)=>{const h=new Set,b=f=>{if(!(!f||typeof f!="object")&&!h.has(f)){if(h.add(f),Array.isArray(f)){for(const I of f){const o=b(I);if(o!==void 0)return o}return}for(const[I,o]of Object.entries(f))if(l.some(R=>R.test(I))){const R=Number(o);if(Number.isFinite(R))return R}for(const I of Object.values(f))if(I&&typeof I=="object"){const o=b(I);if(o!==void 0)return o}}};try{const f=b(a);return Number.isFinite(f)?f:0}catch{return 0}},j=(Array.isArray(p?.provinceTotals)?p.provinceTotals:[]).reduce((a,l)=>({dealerTotali:a.dealerTotali+Number(l.dealerTotali||l.tot||0),dealerIngaggiati:a.dealerIngaggiati+Number(l.dealerIngaggiati||0),tlcFissoInseriti:a.tlcFissoInseriti+Number(l.tlcFissoInseriti||0),tlcMobileInseriti:a.tlcMobileInseriti+Number(l.tlcMobileInseriti||0),energiaInseriti:a.energiaInseriti+Number(l.energiaInseriti||l.energia_inseriti||l.energy||0)}),{dealerTotali:0,dealerIngaggiati:0,tlcFissoInseriti:0,tlcMobileInseriti:0,energiaInseriti:0});j.dealerTotali=Number(p?.kpi?.dealerTotali||j.dealerTotali),j.dealerIngaggiati=Number(p?.kpi?.dealerIngaggiati||j.dealerIngaggiati);const C=Number(p?.kpi?.dealerIngaggiatiFisso||0),y=Number(p?.kpi?.dealerIngaggiatiMobile||0);let S=j.energiaInseriti,w=E(p,[/mobile.*automatic/i,/ric.*automat/i,/tlc.*mobile.*automat/i,/mobile_automat/i]),A=E(p,[/eni.*inser/i,/^eni$/i,/eniInseriti/i]);try{const a=await $({agente:s,year:n,month:r}),h=(Array.isArray(a?.rows)?a.rows:[]).filter(o=>Number(o?.SortOrder)===2),b=o=>h.reduce((R,M)=>R+Number(M?.[o]||0),0),f=b("TotaleEnergia"),I=b("TotaleMobileRA");!S&&f&&(S=f),(w==null||w===0)&&I&&(w=I)}catch{}if(!S&&p?.kpi&&Number(p.kpi.energiaInseriti||0)>0&&(S=Number(p.kpi.energiaInseriti)),(w==null||w===0)&&p?.kpi&&Number(p.kpi.tlc_mobile_ra_inseriti||p.kpi.mobile_ricarica_automatica||0)>0&&(w=Number(p.kpi.tlc_mobile_ra_inseriti||p.kpi.mobile_ricarica_automatica)),(A==null||A===0)&&p?.kpi&&Number(p.kpi.eniInseriti||0)>0&&(A=Number(p.kpi.eniInseriti)),!S){const a=E(p,[/energia.*inser/i,/energia(_|\s)*tot/i,/fw.*energy/i,/^energy$/i,/TotaleEnergia/i,/energy.*inser/i]);Number.isFinite(a)&&a>0&&(S=a)}const u={...j,energiaInseriti:S,dealerIngaggiatiFisso:C,dealerIngaggiatiMobile:y};i&&t(u),i&&N({auto:w||w===0?w:0,eni:A||A===0?A:0})}finally{i&&c(!1)}})(),()=>{i=!1}},[s,n,r]);const v=[{label:"DEALER TOTALI",value:d?.dealerTotali},{label:"DEALER INGAGGIATI FISSO",value:d?.dealerIngaggiatiFisso},{label:"DEALER INGAGGIATI MOBILE",value:d?.dealerIngaggiatiMobile},{label:"ATT.FISSO",value:d?.tlcFissoInseriti},{label:"ATTIVAZIONI MOBILE",value:d?.tlcMobileInseriti},{label:"ENERGIA INSERITI",value:d?.energiaInseriti},{label:"SIM RIC. AUTOMATICA",value:m.auto},{label:"ENI",value:m.eni}];return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm ring-1 ring-gray-100 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-login-bg mb-2",children:s}),e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2",children:v.map((i,p)=>e.jsxs("div",{className:"rounded border border-gray-100 p-2",children:[e.jsx("div",{className:"text-[11px] text-gray-500",children:i.label}),e.jsx("div",{className:"text-sm font-semibold",children:String(i.value??(g?"…":"-"))})]},p))})]})}function K({year:s,month:n}){return e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-5 gap-3",children:D.map(r=>e.jsx(Z,{agente:r,year:s,month:n},r))})}function J({dealers:s}){const n=x.useMemo(()=>{const r=Array.isArray(s)?s:[],g=t=>t?.ragioneSociale||t?.RagioneSociale||t?.DealerKey||t?.dealerKey||t?.nome||t?.name||"-",c=t=>{const m=Number(t);return Number.isFinite(m)?m:0};return r.map(t=>{const m=c(t?.fisso??t?.FISSO??t?.Fisso??t?.tlcFissoInseriti),N=c(t?.fissoShp??t?.["FISSO SHP"]??t?.fisso_shp),v=c(t?.fissoRes??t?.["FISSO RES"]??t?.fisso_res),i=c(t?.mobile??t?.MOBILE??t?.Mobile??t?.tlcMobileInseriti),p=c(t?.mobileShp??t?.["MOBILE SHP"]??t?.mobile_shp),E=c(t?.mobileRes??t?.["MOBILE RES"]??t?.mobile_res),F=c(t?.mobileRa??t?.["Mobile RA"]??t?.["Mobili R. Automatica"]??t?.MobiliRA??t?.mobile_ra),j=c(t?.convergenza??t?.CONVERGENZA??t?.Convergenza),C=c(t?.energia??t?.ENERGIA??t?.Energia??t?.energiaInseriti),y=v,S=N,w=m+y+S+i+C;return{dealer:g(t),fisso:m,fissoShp:N,fissoRes:v,mobile:i,mobileShp:p,mobileRes:E,mobileRa:F,convergenza:j,energia:C,totale:w}}).filter(t=>t.totale>0||t.mobileRa>0||t.convergenza>0).sort((t,m)=>m.totale-t.totale||m.mobile-t.mobile||t.dealer.localeCompare(m.dealer))},[s]);return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm ring-1 ring-gray-100 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"Avanzamento"}),e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-gray-600",children:[e.jsx("th",{className:"text-left px-2 py-1",children:"Dealer"}),e.jsx("th",{className:"text-right px-2 py-1 whitespace-nowrap",children:"Fisso"}),e.jsx("th",{className:"text-right px-2 py-1 whitespace-nowrap",children:"Fisso SHP"}),e.jsx("th",{className:"text-right px-2 py-1 whitespace-nowrap",children:"Fisso RES"}),e.jsx("th",{className:"text-right px-2 py-1",children:"Mobile"}),e.jsx("th",{className:"text-right px-2 py-1 whitespace-nowrap",children:"Mobile SHP"}),e.jsx("th",{className:"text-right px-2 py-1 whitespace-nowrap",children:"Mobile RES"}),e.jsx("th",{className:"text-right px-2 py-1 whitespace-nowrap",children:"Mobile RA"}),e.jsx("th",{className:"text-right px-2 py-1 whitespace-nowrap",children:"Convergenza"}),e.jsx("th",{className:"text-right px-2 py-1",children:"Energia"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:n.length?n.map((r,g)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-2 py-1",children:r.dealer}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.fisso}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.fissoShp}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.fissoRes}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.mobile}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.mobileShp}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.mobileRes}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.mobileRa}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.convergenza}),e.jsx("td",{className:"px-2 py-1 text-right",children:r.energia})]},g)):e.jsx("tr",{children:e.jsx("td",{className:"px-2 py-3 text-center text-gray-500",colSpan:10,children:"Nessun dato"})})})]})})]})}function q({agente:s,year:n,month:r}){const g=x.useRef(null),c=x.useRef(null),[d,t]=x.useState(!1);return x.useEffect(()=>{let m=!0;return(async()=>{try{const N=await $({agente:s,year:n,month:r}),v=N?.chart?.labels||[],i=N?.chart?.datasets||[];if(t(v.length===0),await V(),!m||!g.current)return;c.current&&(c.current.destroy(),c.current=null),c.current=new window.Chart(g.current,{type:"bar",data:{labels:v,datasets:i},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{ticks:{maxRotation:0,autoSkip:!0}},y:{beginAtZero:!0}}}})}catch{}})(),()=>{let N=c.current;if(N){try{N.destroy()}catch{}c.current=null}m=!1}},[s,n,r]),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm ring-1 ring-gray-100 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Distribuzione per provincia"}),e.jsx("div",{className:"h-[220px]",children:e.jsx("canvas",{ref:g,"aria-label":"Grafico distribuzione per provincia"})}),d&&e.jsx("div",{className:"text-xs text-gray-500 mt-2",children:"Nessun dato per il periodo"})]})}function Q({agente:s,year:n,month:r}){const[g,c]=x.useState(!1),[d,t]=x.useState(""),[m,N]=x.useState({kpi:null,province:[],provSegment:[],dealers:[],provTotalsForStack:null,dettagli:[]});return x.useEffect(()=>{let v=!0;return(async()=>{try{t(""),c(!0);const i=await O({agente:s,year:n,month:r}),p=Array.isArray(i?.provSegment)?i.provSegment:[],E=Array.isArray(i?.provinceTotals)?i.provinceTotals:Array.isArray(i?.province)?i.province:[];let F=[];try{const j=await G({agente:s,year:n,month:r});F=(Array.isArray(j?.rows)?j.rows:[]).map(y=>({provincia:y.provincia||y.Provincia||"",segmento:y.segmento||y.Segmento||"",categoria:y.categoria||y.Categoria||"",attivazioni:Number(y.attivazioni||y.Attivazioni||0)})).sort((y,S)=>S.attivazioni-y.attivazioni||y.provincia.localeCompare(S.provincia))}catch{F=[]}v&&N({kpi:i.kpi||null,province:E,provSegment:p,dealers:Array.isArray(i?.dealers)?i.dealers:[],provTotalsForStack:i?.provTotalsForStack||null,dettagli:F})}catch{v&&t("Errore caricamento dati")}finally{v&&c(!1)}})(),()=>{v=!1}},[s,n,r]),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm ring-1 ring-gray-100 p-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-login-bg mb-2",children:s}),g&&e.jsx("div",{className:"text-sm text-gray-500 mb-2",children:"Caricamento…"}),d&&e.jsx("div",{className:"text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded px-3 py-2 mb-2",children:d}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-3",children:[e.jsx(q,{agente:s,year:n,month:r}),e.jsx(J,{dealers:m.dealers})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-gray-900 mb-1",children:"Dettagli per provincia / segmento / categoria"}),e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"min-w-full text-xs",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600",children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-left px-2 py-1",children:"Provincia"}),e.jsx("th",{className:"text-left px-2 py-1",children:"Segmento"}),e.jsx("th",{className:"text-left px-2 py-1",children:"Categoria"}),e.jsx("th",{className:"text-right px-2 py-1",children:"Attivazioni"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:m.dettagli.length?m.dettagli.map((v,i)=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-2 py-1",children:v.provincia||"-"}),e.jsx("td",{className:"px-2 py-1",children:v.segmento||"-"}),e.jsx("td",{className:"px-2 py-1",children:v.categoria||"-"}),e.jsx("td",{className:"px-2 py-1 text-right",children:v.attivazioni??"-"})]},i)):e.jsx("tr",{children:e.jsx("td",{className:"px-2 py-3 text-center text-gray-500",colSpan:4,children:"Nessun dato"})})})]})})]})]})]})}function se({embed:s=!1}){const{user:n}=U(),r=new Date,c=(()=>{if(r.getDate()===1){const a=r.getMonth()===0?12:r.getMonth();return{year:r.getMonth()===0?r.getFullYear()-1:r.getFullYear(),month:a}}return{year:r.getFullYear(),month:r.getMonth()+1}})(),[d,t]=x.useState({month:c.month,year:c.year}),[m,N]=x.useState(!1),[v,i]=x.useState(""),[p,E]=x.useState({kpi:null,province:[],provSegment:[],dealers:[],provTotalsForStack:null}),[F,j]=x.useState({tlc:null,energy:null});x.useEffect(()=>{C()},[d.year,d.month]),x.useEffect(()=>{let u=!0;return(async()=>{try{const a=await L("/agente/reportistica/last-updates"),l=a?.data?.data||a?.data||{};if(!u)return;j({tlc:l.tlc||null,energy:l.energy||null})}catch{}})(),()=>{u=!1}},[]);async function C(){try{i(""),N(!0);const u=await O({agente:H,year:d.year,month:d.month}),a=Array.isArray(u?.provinceTotals)?u.provinceTotals:[],l=a.reduce((h,b)=>({dealerTotali:h.dealerTotali+Number(b.dealerTotali||b.tot||0),dealerIngaggiati:h.dealerIngaggiati+Number(b.dealerIngaggiati||0),tlcFissoInseriti:h.tlcFissoInseriti+Number(b.tlcFissoInseriti||0),tlcMobileInseriti:h.tlcMobileInseriti+Number(b.tlcMobileInseriti||0),energiaInseriti:h.energiaInseriti+Number(b.energiaInseriti||b.energia_inseriti||b.energy||0)}),{dealerTotali:0,dealerIngaggiati:0,tlcFissoInseriti:0,tlcMobileInseriti:0,energiaInseriti:0});l.dealerTotali=Number(u?.kpi?.dealerTotali||l.dealerTotali),l.dealerIngaggiati=Number(u?.kpi?.dealerIngaggiati||l.dealerIngaggiati),E({kpi:u?.kpi||null,province:a.length?a.map(h=>({province:h.provincia||h.Provincia||h.province||"",tot:Number(h.dealerTotali||h.tot||0)})):u?.province||[],provSegment:u?.provinceSegmentEngagement||u?.provSegment||u?.provWide||[],provTotalsForStack:a,dealers:Array.isArray(u?.dealers)?u.dealers:[]})}catch{i("Impossibile caricare i dati."),E({kpi:null,province:[],provSegment:[],dealers:[],provTotalsForStack:null})}finally{N(!1)}}const[y,S]=x.useState(!1),w=async()=>{if(!y)try{S(!0);const u=await Y("/supermaster/report-agente/invalidate-cache",{});u?.success?(z.success(u.message||"Cache invalidata con successo!"),await C()):z.error("Errore durante l'invalidazione della cache")}catch(u){console.error("Errore reset cache:",u),z.error(u.message||"Errore durante l'invalidazione della cache")}finally{S(!1)}},A=e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between gap-3 mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-[20px] leading-6 font-semibold text-gray-900 tracking-[-0.01em]",children:"Analisi"}),e.jsx(_,{label:"Ultimo Aggiornamento TLC",value:P(F.tlc),color:"blue"}),e.jsx(_,{label:"Ultimo aggiornamento ENERGY",value:P(F.energy),color:"emerald"}),e.jsx("button",{onClick:w,disabled:y||m,className:"inline-flex items-center gap-1.5 px-3 py-1.5 text-xs font-medium text-red-700 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:"Invalida la cache Redis e ricarica i dati",children:y?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin h-3.5 w-3.5",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),e.jsx("span",{children:"Reset..."})]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"h-3.5 w-3.5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"})}),e.jsx("span",{children:"Reset Cache"})]})})]}),e.jsx(W,{value:d,onChange:t,onLoad:C,loading:m})]}),v&&e.jsx("div",{className:"mb-3 text-sm text-amber-700 bg-amber-50 border border-amber-200 rounded px-3 py-2",children:v}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(K,{year:d.year,month:d.month}),e.jsx("div",{className:"grid grid-cols-1 gap-4",children:D.map(u=>e.jsx(Q,{agente:u,year:d.year,month:d.month},u))}),e.jsx(X,{year:d.year,month:d.month})]})]});return s?e.jsx("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6",children:A}):e.jsx(B,{title:"Analisi",children:A})}function X({year:s,month:n}){const[r,g]=x.useState([]),[c,d]=x.useState(!1),[t,m]=x.useState(""),[N,v]=x.useState(!1),[i,p]=x.useState({agente:"ALL",provincia:"ALL",segmento:"ALL",categoria:"ALL"});x.useEffect(()=>{let a=!0;return(async()=>{try{m(""),d(!0);const h=(await Promise.all(D.map(async b=>{try{const f=await G({agente:b,year:s,month:n});return(Array.isArray(f?.rows)?f.rows:[]).map(o=>({agente:b,provincia:o.provincia||o.Provincia||"",segmento:o.segmento||o.Segmento||"",categoria:o.categoria||o.Categoria||"",attivazioni:Number(o.attivazioni||o.Attivazioni||0),prodotto:o.prodotto||o.Prodotto||o.OFFERTA||o.offerta||void 0,operatore:o.operatore||o.Operatore||o.OPERATORE||void 0,mese:o.mese||o.Mese||o.month||void 0,anno:o.anno||o.Anno||o.year||void 0,dealer:o.dealer||o.Dealer||o.RagioneSociale||o.ragione_sociale||void 0}))}catch{return[]}}))).flat().sort((b,f)=>f.attivazioni-b.attivazioni||b.provincia.localeCompare(f.provincia));a&&g(h)}catch{a&&m("Errore caricamento dettagli")}finally{a&&d(!1)}})(),()=>{a=!1}},[s,n]);const j=N?["agente","provincia","segmento","categoria","prodotto","operatore","dealer","mese","anno","attivazioni"]:["agente","provincia","segmento","categoria","attivazioni"],C={agente:"Agente",provincia:"Provincia",segmento:"Segmento",categoria:"Categoria",attivazioni:"Attivazioni",prodotto:"Prodotto",operatore:"Operatore",dealer:"Dealer",mese:"Mese",anno:"Anno"},y=a=>C[a]||a.replace(/_/g," ").replace(/\b\w/g,l=>l.toUpperCase()),S=(a,l)=>["ALL",...Array.from(new Set(a.map(h=>(h[l]||"").toString().trim()).filter(Boolean))).sort((h,b)=>h.localeCompare(b))],w=x.useMemo(()=>({agente:S(r,"agente"),provincia:S(r,"provincia"),segmento:S(r,"segmento"),categoria:S(r,"categoria")}),[r]),A=r.filter(a=>(i.agente==="ALL"||a.agente===i.agente)&&(i.provincia==="ALL"||a.provincia===i.provincia)&&(i.segmento==="ALL"||a.segmento===i.segmento)&&(i.categoria==="ALL"||a.categoria===i.categoria)),u=()=>{const a=A,l=";",h=T=>{const k=T==null?"":String(T);return/[";\n]/.test(k)?'"'+k.replace(/"/g,'""')+'"':k},b=j.map(T=>y(T)).join(l),f=a.map(T=>j.map(k=>h(T[k])).join(l)).join(`
`),I=b+`
`+f,o=new Blob([I],{type:"text/csv;charset=utf-8;"}),R=URL.createObjectURL(o),M=document.createElement("a");M.href=R,M.download=`analisi_${s}-${String(n).padStart(2,"0")}_${N?"completa":"compatta"}.csv`,document.body.appendChild(M),M.click(),M.remove(),URL.revokeObjectURL(R)};return e.jsxs("div",{className:"bg-white rounded-lg shadow-sm ring-1 ring-gray-200 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"text-[13px] font-semibold text-gray-900 tracking-[-0.01em]",children:"Dettagli attivazioni (aggregato)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:u,className:"text-xs px-3 py-1.5 rounded-md border border-gray-200 hover:bg-gray-50 text-gray-700",children:"Export CSV"}),e.jsxs("div",{className:"hidden sm:flex items-center gap-1 text-xs",children:[e.jsx("span",{className:"text-gray-500 mr-1",children:"Vista"}),e.jsx("button",{onClick:()=>v(!1),className:`px-2 py-1 rounded border ${N?"bg-white text-gray-700 border-gray-200":"bg-blue-600 text-white border-blue-600"}`,children:"Compatta"}),e.jsx("button",{onClick:()=>v(!0),className:`px-2 py-1 rounded border ${N?"bg-blue-600 text-white border-blue-600":"bg-white text-gray-700 border-gray-200"}`,children:"Completa"})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-2 mb-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[11px] text-gray-500 mb-1",children:"Agente"}),e.jsx("select",{value:i.agente,onChange:a=>p(l=>({...l,agente:a.target.value})),className:"border-gray-300 rounded text-xs px-2 py-1.5",children:w.agente.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[11px] text-gray-500 mb-1",children:"Provincia"}),e.jsx("select",{value:i.provincia,onChange:a=>p(l=>({...l,provincia:a.target.value})),className:"border-gray-300 rounded text-xs px-2 py-1.5",children:w.provincia.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[11px] text-gray-500 mb-1",children:"Segmento"}),e.jsx("select",{value:i.segmento,onChange:a=>p(l=>({...l,segmento:a.target.value})),className:"border-gray-300 rounded text-xs px-2 py-1.5",children:w.segmento.map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-[11px] text-gray-500 mb-1",children:"Categoria"}),e.jsx("select",{value:i.categoria,onChange:a=>p(l=>({...l,categoria:a.target.value})),className:"border-gray-300 rounded text-xs px-2 py-1.5",children:w.categoria.map(a=>e.jsx("option",{value:a,children:a},a))})]})]}),t&&e.jsx("div",{className:"text-sm text-red-600 mb-2",children:t}),e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"min-w-full text-[12px]",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-600",children:e.jsx("tr",{children:j.map(a=>e.jsx("th",{className:"text-left px-2 py-2 whitespace-nowrap font-medium",children:y(a)},a))})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:c?e.jsx("tr",{children:e.jsx("td",{className:"px-2 py-3 text-center text-gray-500",colSpan:j.length,children:"Caricamento…"})}):A.length?A.map((a,l)=>e.jsx("tr",{className:"hover:bg-gray-50",children:j.map(h=>e.jsx("td",{className:"px-2 py-1.5 whitespace-nowrap text-gray-800",children:a[h]??"-"},h))},l)):e.jsx("tr",{children:e.jsx("td",{className:"px-2 py-3 text-center text-gray-500",colSpan:j.length,children:"Nessun dato"})})})]})})]})}export{se as A};
