import{r as x,j as t}from"./vendor.js";import{D as X}from"./DashboardLayout.js";import{u as Z,g as G}from"./index.js";import"./logo2.js";const V=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],q=(w,c,p)=>Math.max(c,Math.min(p,w)),y=w=>new Intl.NumberFormat("it-IT",{maximumFractionDigits:0}).format(Number(w||0));function ee({title:w,summary:c,units:p="attivazioni",details:$=[]}){const h=c?.target??0,E=c?.actual??0,d=c?.target?c.percent:null,U=c?.target?Math.max(c.target-E,0):null,M=d!=null?`${d}%`:"—",I=d==null?"text-gray-400":d>=100?"text-emerald-600":d>=75?"text-amber-600":d>=50?"text-orange-500":"text-rose-500",F=d==null?"bg-gray-300":d>=100?"bg-emerald-500":d>=75?"bg-amber-500":d>=50?"bg-orange-400":"bg-rose-500";let j;return c?.target?d>=100?j={text:"Obiettivo raggiunto!",color:"text-emerald-600"}:d>=75?j={text:"Quasi al traguardo",color:"text-amber-600"}:j={text:"Serve più impegno",color:"text-rose-500"}:j={text:"Nessun target impostato",color:"text-gray-400"},t.jsxs("div",{className:"border border-gray-200 rounded-xl bg-white/90 p-4 shadow-sm flex flex-col gap-3",children:[t.jsxs("div",{className:"flex items-start justify-between",children:[t.jsx("div",{className:"text-sm font-semibold uppercase tracking-wide text-gray-700",children:w}),t.jsx("div",{className:`text-sm font-semibold ${I}`,children:M})]}),t.jsx("div",{className:"text-sm text-gray-700",children:c?.target?`${y(E)} / ${y(h)} ${p}`:`Target: ${y(h)} ${p}`}),U!=null&&c?.target?t.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500",children:[t.jsx("span",{children:"Mancano:"}),t.jsxs("span",{className:"font-medium text-gray-700",children:[y(U)," ",p]})]}):null,t.jsx("div",{className:"h-1.5 rounded-full bg-gray-100 overflow-hidden",children:t.jsx("div",{className:`h-1.5 rounded-full transition-all ${F}`,style:{width:`${c?.target?Math.min(c.percent,100):0}%`}})}),t.jsx("div",{className:`text-xs font-medium ${j.color}`,children:j.text}),$?.length?t.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3 mt-1",children:$.map(({label:K,target:R=0,actual:s=0,hint:z,unit:C=p,showTarget:D=!0,isRAPercentage:N=!1,percent:P})=>{const _=D&&R>0,f=_?q(Math.round(s/R*100),0,999):null,e=f!=null?`${f}%`:"—",r=N?s>=50?"bg-emerald-500":"bg-rose-500":f==null?"bg-gray-300":f>=100?"bg-emerald-500":f>=75?"bg-amber-500":f>=50?"bg-orange-400":"bg-sky-500";return t.jsxs("div",{className:"rounded-lg border border-gray-100 bg-white px-3 py-2",children:[t.jsxs("div",{className:"flex items-center justify-between text-[11px] font-medium text-gray-500 uppercase tracking-wide",children:[t.jsx("span",{children:K}),_&&!N&&t.jsx("span",{className:"text-gray-400",children:e})]}),t.jsxs("div",{className:"text-sm font-semibold mt-1 flex items-center gap-2",children:[t.jsx("span",{className:N?s>=50?"text-emerald-600":"text-rose-600":"text-gray-900",children:_?`${y(s)} / ${y(R)} ${C}`:`${y(s)} ${C}`}),!N&&P!=null&&P>0&&t.jsxs("span",{className:"text-[10px] font-normal text-gray-500",children:["(",P,"%)"]})]}),_&&t.jsx("div",{className:"mt-2 h-1.5 rounded-full bg-gray-100 overflow-hidden",children:t.jsx("div",{className:`h-1.5 rounded-full ${r}`,style:{width:`${Math.min(N?s*2:f,100)}%`}})}),z?t.jsx("div",{className:"mt-1 text-[11px] text-gray-400",children:z}):null]},K)})}):null]})}function le(){const{user:w}=Z();(w?.role||"").toString().toLowerCase();const c=new Date,[p,$]=x.useState(c.getFullYear()),[h,E]=x.useState(c.getMonth()+1),[d,U]=x.useState(!0),[M,I]=x.useState(null),[F,j]=x.useState(null),[K,R]=x.useState({ra:0,energy:0,fissi:0}),[s,z]=x.useState(null),[C,D]=x.useState(!1),[N,P]=x.useState(null),{objectiveCards:_,objectivesLastUpdate:f}=x.useMemo(()=>{const e=F?.targetsDetailed||{},r=F?.targets||{},a=F?.progressi||{},l=(g,v=0)=>{const T=Number(g??v??0);return Number.isFinite(T)?T:0},m=(g,v,Y)=>{const T=Y!=null?Number(Y)||0:Number(g)||0,A=Number(v)||0;return!A&&!T?null:{percent:A?q(Math.round(T/A*100),0,999):0,display:`${y(T)} / ${y(A||0)}`,actual:T,target:A}},o=g=>{const v=Number(g);return Number.isFinite(v)?v:0},W=o(s?.eni_inseriti??a.energyEni),Q=o((s?.energia_inseriti??a.energyAttuali)+W),S={fissi:o(s?.tlc_fisso_inseriti??a.fissiAttuali),mobili:o(s?.tlc_mobile_inseriti??a.mobileAttuali),energy:Q,energyEni:W,simRa:o(s?.sim_ric_automatica??a.mobileRa)},B=S.mobili>0?Math.round((S.simRa||0)/S.mobili*1e3)/10:o(a.mobilePercentRA),u={totale:l(e?.fissi?.totale,r?.fissi?.goal??r?.TargetFissi),start:l(e?.fissi?.start),pro:l(e?.fissi?.pro),ultra:l(e?.fissi?.ultra),progressTotale:m(a.fissiAttuali,e?.fissi?.totale??r?.fissi?.goal??r?.TargetFissi,S.fissi),progressStart:m(o(a.fissiStart),e?.fissi?.start),progressPro:m(o(a.fissiPro),e?.fissi?.pro),progressUltra:m(o(a.fissiUltra),e?.fissi?.ultra)},n={totale:l(e?.mobili?.totale,r?.mobili?.goal??r?.ra?.goal??r?.TargetRA),start:l(e?.mobili?.start),pro:l(e?.mobili?.pro),ultra:l(e?.mobili?.ultra),percentRA:l(e?.mobili?.percentRA),convergenze:l(e?.mobili?.convergenze),progressTotale:m(a.mobileAttuali,e?.mobili?.totale??r?.mobili?.goal??r?.ra?.goal??r?.TargetRA,S.mobili),progressConvergenze:m(a.convergenzaRES,e?.mobili?.convergenze),progressStart:m(o(a.mobileStart),e?.mobili?.start),progressPro:m(o(a.mobilePro),e?.mobili?.pro),progressUltra:m(o(a.mobileUltra),e?.mobili?.ultra)},i={totale:l(e?.energy?.totale,r?.energy?.goal??r?.TargetEnergy),core:l(e?.energy?.core),flex:l(e?.energy?.flex),fix:l(e?.energy?.fix),eni:l(e?.energy?.eni),percentFastweb:l(e?.energy?.percentFastweb),progressTotale:m(a.energyAttuali,e?.energy?.totale??r?.energy?.goal??r?.TargetEnergy,S.energy),progressCore:m(o(a.energyCore),e?.energy?.core),progressFlex:m(o(a.energyFlex),e?.energy?.flex),progressFix:m(o(a.energyFix),e?.energy?.fix),progressEni:m(o(a.energyEni),e?.energy?.eni,S.energyEni)},b=(g,v)=>v>0?Math.round(g/v*100):0,O=(u.progressStart?.actual??0)+(u.progressPro?.actual??0)+(u.progressUltra?.actual??0),k=(n.progressStart?.actual??0)+(n.progressPro?.actual??0)+(n.progressUltra?.actual??0),L=(i.progressCore?.actual??0)+(i.progressFlex?.actual??0)+(i.progressFix?.actual??0),H=[{key:"fissi",title:"Fissi",summary:u.progressTotale,units:"attivazioni",details:[{label:"Start",actual:u.progressStart?.actual??0,target:u.progressStart?.target??0,percent:b(u.progressStart?.actual,O),showTarget:(u.progressStart?.target??0)>0},{label:"Pro",actual:u.progressPro?.actual??0,target:u.progressPro?.target??0,percent:b(u.progressPro?.actual,O),showTarget:(u.progressPro?.target??0)>0},{label:"Ultra",actual:u.progressUltra?.actual??0,target:u.progressUltra?.target??0,percent:b(u.progressUltra?.actual,O),showTarget:(u.progressUltra?.target??0)>0}].filter(g=>g.actual>0||g.target>0)},{key:"mobili",title:"Mobili",summary:n.progressTotale,units:"attivazioni",details:[{label:"Start",actual:n.progressStart?.actual??0,target:n.progressStart?.target??0,percent:b(n.progressStart?.actual,k),showTarget:(n.progressStart?.target??0)>0},{label:"Pro",actual:n.progressPro?.actual??0,target:n.progressPro?.target??0,percent:b(n.progressPro?.actual,k),showTarget:(n.progressPro?.target??0)>0},{label:"Ultra",actual:n.progressUltra?.actual??0,target:n.progressUltra?.target??0,percent:b(n.progressUltra?.actual,k),showTarget:(n.progressUltra?.target??0)>0},{label:"% RA",actual:B??o(a.mobilePercentRA),unit:"%",showTarget:!1,isRAPercentage:!0},{label:"Convergenze",actual:n.progressConvergenze?.actual??0,target:n.progressConvergenze?.target??0,percent:b(n.progressConvergenze?.actual,k),showTarget:(n.progressConvergenze?.target??0)>0}].filter(g=>g.isRAPercentage||g.actual>0||g.target>0)},{key:"energy",title:"Energy",summary:i.progressTotale,units:"attivazioni",details:[{label:"Core (FW)",actual:i.progressCore?.actual??0,target:i.progressCore?.target??0,percent:b(i.progressCore?.actual,L),showTarget:(i.progressCore?.target??0)>0},{label:"Flex (FW)",actual:i.progressFlex?.actual??0,target:i.progressFlex?.target??0,percent:b(i.progressFlex?.actual,L),showTarget:(i.progressFlex?.target??0)>0},{label:"Fix (FW)",actual:i.progressFix?.actual??0,target:i.progressFix?.target??0,percent:b(i.progressFix?.actual,L),showTarget:(i.progressFix?.target??0)>0},{label:"ENI",actual:i.progressEni?.actual??0,target:i.progressEni?.target??0,percent:b(i.progressEni?.actual,L),showTarget:(i.progressEni?.target??0)>0},{label:"% FW minima",actual:o(a.energyPercentFastweb),unit:"%",showTarget:!1,isRAPercentage:!0,hint:i.percentFastweb>0?`Target: ${i.percentFastweb}%`:null}].filter(g=>g.isRAPercentage||g.actual>0||g.target>0)}],J=e?.meta?.lastUpdate||e?.lastUpdate||r?.meta?.lastUpdate||r?.lastUpdate||F?.targetsLastUpdate;return{objectiveCards:H,objectivesLastUpdate:J}},[F,s]);return x.useEffect(()=>{let e=!0;return(async()=>{try{U(!0),I(null);const r=await G(`/agente/obiettivi-compensi-v2?year=${p}&month=${h}`);e&&j(r)}catch(r){console.error("Errore fetch obiettivi agente:",r),e&&I(r?.message||"Errore nel caricamento degli obiettivi")}finally{e&&U(!1)}})(),()=>{e=!1}},[p,h]),x.useEffect(()=>{let e=!0;return(async()=>{try{D(!0),P(null);const r=new URLSearchParams({year:String(p),month:String(h),operator:"fastweb"}),a=await G(`/agente/reportistica?${r.toString()}`),l=a?.data||a||{},m=l?.data??l,o=Array.isArray(m?.kpi_card)?m.kpi_card[0]:null;e&&z(o||null)}catch(r){console.error("[Obiettivi][KPI]",r),e&&(P(r?.message||"Errore KPI agenti"),z(null))}finally{e&&D(!1)}})(),()=>{e=!1}},[p,h]),t.jsx(X,{title:"Obiettivi & Compensi",children:t.jsxs("div",{className:"rounded-2xl bg-white p-4 sm:p-6 shadow-sm mt-4",children:[t.jsxs("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between mb-4",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900",children:"Obiettivi & Compensi"}),t.jsxs("p",{className:"text-sm text-gray-600",children:["Periodo: ",V[h-1]," ",p]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("select",{value:h,onChange:e=>{const r=parseInt(e.target.value,10),a=new Date;p>a.getFullYear()||p===a.getFullYear()&&r>a.getMonth()+1||E(r)},className:"border rounded-md px-2 py-1 text-sm",children:V.map((e,r)=>t.jsx("option",{value:r+1,children:e},e))}),t.jsx("select",{value:p,onChange:e=>{const r=parseInt(e.target.value,10),a=new Date;r>a.getFullYear()||(r===a.getFullYear()&&h>a.getMonth()+1&&E(a.getMonth()+1),$(r))},className:"border rounded-md px-2 py-1 text-sm",children:Array.from({length:6}).map((e,r)=>{const a=c.getFullYear()-r;return t.jsx("option",{value:a,children:a},a)})})]})]}),d&&t.jsx("div",{className:"py-8 text-sm text-gray-500",children:"Caricamento…"}),M&&!d&&t.jsx("div",{className:"py-8 text-sm text-red-600",children:M}),!d&&!M&&t.jsxs(t.Fragment,{children:[t.jsxs("section",{className:"mb-8",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Obiettivi"}),f?t.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:["Ultimo aggiornamento: ",new Date(f).toLocaleString("it-IT")]}):null]}),t.jsx("div",{className:"text-xs text-gray-500",children:"I target indicati sono impostati dall'Agenzia."})]}),t.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:_.map(e=>t.jsx(ee,{title:e.title,summary:e.summary,units:e.units,details:e.details},e.key))})]}),t.jsxs("section",{className:"mb-8",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between mb-4",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"KPI Reali (fonte Supermaster)"}),t.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"Conteggi estratti dagli stessi dati utilizzati nel cruscotto Supermaster."})]}),C&&t.jsx("span",{className:"text-xs text-gray-500",children:"Caricamento…"}),N&&!C&&t.jsx("span",{className:"text-xs text-red-600",children:N})]}),s?t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3",children:[{label:"Dealer Totali",value:s.dealer_totali??s.dealerTotali},{label:"Dealer Ingaggiati Fisso",value:s.dealer_ingaggiati_fisso??s.dealerIngaggiatiFisso},{label:"Dealer Ingaggiati Mobile",value:s.dealer_ingaggiati_mobile??s.dealerIngaggiatiMobile},{label:"Attivazioni Fisso",value:s.tlc_fisso_inseriti??s.tlcFissoInseriti},{label:"Attivazioni Mobile",value:s.tlc_mobile_inseriti??s.tlcMobileInseriti},{label:"SIM Ric. Automatica",value:s.sim_ric_automatica??s.tlc_mobile_ra_inseriti},{label:"Energy",value:s.energia_inseriti??s.energiaInseriti},{label:"ENI",value:s.eni_inseriti??s.eniInseriti??s.eni}].map(e=>t.jsxs("div",{className:"rounded-xl border border-gray-200 bg-white/90 p-4 shadow-sm",children:[t.jsx("p",{className:"text-xs font-medium text-gray-500 uppercase tracking-wide",children:e.label}),t.jsx("p",{className:"text-2xl font-semibold text-gray-900 mt-1",children:y(e.value||0)})]},e.label))}):C?null:t.jsx("div",{className:"text-sm text-gray-500 bg-gray-50 border border-dashed border-gray-200 rounded-xl p-4",children:"Nessun KPI disponibile per il periodo selezionato."})]}),t.jsxs("section",{className:"rounded-xl border border-dashed border-gray-300 bg-gray-50/60 p-6 text-center text-sm text-gray-500",children:[t.jsx("div",{className:"text-lg font-semibold text-gray-800 mb-2",children:"Compensi"}),t.jsx("p",{className:"text-base font-medium text-gray-600",children:"Funzionalità in arrivo"}),t.jsx("p",{className:"mt-2 text-xs text-gray-500 max-w-xl mx-auto",children:"Stiamo completando l’integrazione dei dati reali di compenso. Presto vedrai qui KPI aggiornati, progressi e simulazioni in tempo reale."})]})]})]})})}export{le as default};
