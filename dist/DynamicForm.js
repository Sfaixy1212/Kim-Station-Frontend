import{r as d,j as e,n as w}from"./vendor.js";import{a as T,b as B}from"./DashboardLayout.js";function Q(r){const[o,f]=d.useState(null),[p,u]=d.useState(!1),[h,C]=d.useState(null);return d.useEffect(()=>{if(!r){f(null);return}let b=!0;return u(!0),T.get(`/api/template-offerta/${r}`).then(m=>{b&&f(m.data)}).catch(m=>{b&&C(m.normalized||m)}).finally(()=>{b&&u(!1)}),()=>{b=!1}},[r]),{data:o,loading:p,error:h}}const N="cognome_nome",j="codice_fiscale",H=/eni/i,Z=/^[A-Za-zÃ€-Ã–Ã˜-Ã¶Ã¸-Ã¿'â€™\-]+$/,K=(r="")=>{const o=r.trim();if(o.length<5)return!1;const f=o.split(/\s+/).filter(Boolean);return f.length<2?!1:f.every(p=>p.length>=2&&Z.test(p))},W=(r="")=>/^[A-Z0-9]{16}$/.test(r);function q(r=[]){return r.map(o=>typeof o=="string"?{value:o,label:o}:o)}function ee({template:r,idOfferta:o,onSuccess:f,onError:p}){const u=r?.campi||[],h=r?.documenti||[],C=r?.template||"",b=H.test(C),m=d.useMemo(()=>{const s={};return u.forEach(t=>{s[t.key]=t.tipo==="checkbox"?!1:""}),h.forEach(t=>{s[t.key]=null}),s},[u,h]),[y,M]=d.useState(m),[R,E]=d.useState({}),D=d.useRef({}),[S,k]=d.useState(!1),[A,F]=d.useState(!1),[I,U]=d.useState(!1),O=(s,t)=>{let n=t;typeof n=="string"&&(s===j?n=n.toUpperCase():s===N&&(n=n.replace(/\s+/g," "))),M(a=>({...a,[s]:n})),E(a=>({...a,[s]:null}))},_=s=>{if(s==null||s==="")return!0;const t=String(s).trim();if(!/^[0-9 ]+$/.test(t))return!1;const n=t.replace(/\s+/g,"");return!(!(n.length===9||n.length===10)||n[0]==="0"||/^([0-9])\1+$/.test(n)||t.includes(" ")&&!/^\d{3}\s\d{6,7}$/.test(t))},L=s=>{if(s==null)return"";const t=String(s).replace(/[^0-9]/g,"").slice(0,10);return t.length<=3?t:`${t.slice(0,3)} ${t.slice(3)}`};d.useEffect(()=>{F(!1),M(m)},[o,m]);const P=async s=>{if(s?.preventDefault?.(),S||A){console.log("Invio giÃ  in corso o completato, ignorato");return}try{k(!0);const t=u.find(i=>i.key==="NUMERO_DA_PASSARE");if(t){const i=y.NUMERO_DA_PASSARE||"";if(!_(i)||t.obbligatorio&&!String(i).trim()){E(g=>({...g,NUMERO_DA_PASSARE:"Inserisci un numero di cellulare valido (es. 123 4567890)."}));try{D.current.NUMERO_DA_PASSARE?.focus()}catch{}w.error("Numero di cellulare non valido."),k(!1);return}}const n={...y},a={};if(b){const i=typeof n[N]=="string"?n[N].trim().replace(/\s+/g," "):"",l=typeof n[j]=="string"?n[j].trim().toUpperCase():"";u.some(g=>g.key===N)&&!K(i)?a[N]="Inserisci cognome e nome (es. Rossi Mario).":n[N]=i,u.some(g=>g.key===j)&&!W(l)?a[j]="Il codice fiscale deve contenere 16 caratteri alfanumerici.":n[j]=l}if(Object.keys(a).length){E(l=>({...l,...a}));const i=Object.keys(a)[0];try{i&&D.current[i]?.focus()}catch{}w.error("Controlla i campi evidenziati."),k(!1);return}const c=new FormData;Object.entries(n).forEach(([i,l])=>{l!=null&&(l instanceof File||c.append(i,l))}),h.forEach(i=>{const l=y[i.key];l&&c.append(i.key,l)});const x={},v={};Object.entries(n).forEach(([i,l])=>{if(l==null||l===""||l instanceof File)return;const g=i.toUpperCase();["NOME_E_COGNOME","CODICE_FISCALE","CF_","DATA_DI_NASCITA","LUOGO_DI_NASCITA","INDIRIZZO","CAP","CITTA","PROVINCIA","EMAIL","TELEFONO","PEC"].some($=>g.includes($))?x[i]=l:v[i]=l});const z=Object.keys(x).length>0,V=Object.keys(v).length>0;if(!z&&!V){w.error("Errore: Nessun dato inserito nel form. Compila almeno un campo."),k(!1);return}console.log("[FORM-DEBUG] Payload intestatario:",x),console.log("[FORM-DEBUG] Payload altriDati:",v),c.set("idOfferta",String(o));try{const i=localStorage.getItem("email");i&&c.set("utente",i)}catch{}c.set("intestatario",JSON.stringify(x)),c.set("altriDati",JSON.stringify(v));const G=await B("/api/attivazioni",c);F(!0),w.success("Attivazione inviata con successo"),f?.(G.data)}catch(t){const n=t.normalized||t;w.error(n?.message||"Errore durante l'invio"),p?.(n)}finally{k(!1)}};return e.jsxs("form",{onSubmit:P,className:"space-y-6",children:[r?.istruzioni&&e.jsx("div",{className:"rounded-xl border border-yellow-200 bg-yellow-50 p-4 text-sm text-yellow-900",children:r.istruzioni}),r?.firmeGuida&&r.firmeGuida.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("button",{type:"button",onClick:()=>U(!I),className:"inline-flex items-center gap-2 text-sm font-medium text-blue-600 hover:text-blue-700 transition-colors",children:[e.jsx("svg",{className:`w-4 h-4 transition-transform ${I?"rotate-90":""}`,fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})}),"ðŸ“‹ Vedi dove apporre le firme"]}),I&&e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-xl border border-gray-200",children:r.firmeGuida.map((s,t)=>e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-medium text-gray-700",children:s.label||`Pagina ${t+1}`}),e.jsx("a",{href:s.url,target:"_blank",rel:"noreferrer",children:e.jsx("img",{src:s.url,alt:s.label||`Esempio firme ${t+1}`,className:"w-full h-auto rounded-lg border border-gray-300 hover:border-blue-500 transition-colors cursor-pointer shadow-sm hover:shadow-md"})})]},t))})]}),(r?.linkDownload||r?.downloadUrl)&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("a",{href:r.linkDownload?.url||r.downloadUrl,target:"_blank",rel:"noreferrer",className:"inline-flex items-center gap-2 text-blue-600 hover:underline text-sm",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"h-4 w-4",children:e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM8 13h2a2 2 0 0 0 0-4H8v4zm6 0h-2v4h2a2 2 0 0 0 0-4zm-4-2h1a1 1 0 1 1 0 2H10v-2zm4 4h1a1 1 0 1 1 0 2h-1v-2zM13 9V3.5L18.5 9H13z"})}),e.jsx("span",{children:r.linkDownload?.label||r.downloadLabel||"SCARICA E COMPILA IL MODULO DI RILANCIO"})]}),e.jsx("span",{className:"inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10",children:"PDF"})]}),r.linkDownload?.descrizione&&e.jsx("p",{className:"text-xs text-gray-600",children:r.linkDownload.descrizione})]}),r?.downloadUrl2&&e.jsx("div",{className:"space-y-2",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("a",{href:r.downloadUrl2,target:"_blank",rel:"noreferrer",className:"inline-flex items-center gap-2 text-blue-600 hover:underline text-sm",children:[e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"h-4 w-4",children:e.jsx("path",{d:"M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM8 13h2a2 2 0 0 0 0-4H8v4zm6 0h-2v4h2a2 2 0 0 0 0-4zm-4-2h1a1 1 0 1 1 0 2H10v-2zm4 4h1a1 1 0 1 1 0 2h-1v-2zM13 9V3.5L18.5 9H13z"})}),e.jsx("span",{children:r.downloadLabel2||"SCARICA DOCUMENTO AGGIUNTIVO"})]}),e.jsx("span",{className:"inline-flex items-center rounded-md bg-red-50 px-2 py-1 text-xs font-medium text-red-700 ring-1 ring-inset ring-red-600/10",children:"PDF"})]})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:u.map(s=>{const t={id:s.key,name:s.key,required:!!s.obbligatorio,className:"w-full rounded-xl border border-gray-200 bg-white py-3 px-4 text-gray-900 shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500",value:s.tipo==="checkbox"?void 0:y[s.key]??"",onChange:a=>{const c=a.target.type==="checkbox"?a.target.checked:a.target.value;if(s.key==="NUMERO_DA_PASSARE"){const x=L(c);O(s.key,x);const v=_(x);E(z=>({...z,[s.key]:v?null:"Numero non valido (es. 123 4567890)."}))}else O(s.key,c)}},n=s.placeholder||(s.key==="NUMERO_DA_PASSARE"?"123 4567890":void 0);return e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{htmlFor:s.key,className:"text-sm font-medium text-gray-700",children:[s.label,s.obbligatorio?e.jsx("span",{className:"text-red-500",children:" *"}):null]}),s.tipo==="select"?e.jsxs("select",{...t,children:[e.jsx("option",{value:"",children:"Seleziona..."}),q(s.opzioni).map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]}):s.tipo==="checkbox"?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",checked:!!y[s.key],onChange:t.onChange,className:"h-4 w-4"}),e.jsx("span",{className:"text-sm text-gray-700",children:s.label})]}):e.jsxs(e.Fragment,{children:[e.jsx("input",{ref:a=>{D.current[s.key]=a},type:s.tipo||"text",...t,placeholder:n,onBlur:()=>{if(s.key==="NUMERO_DA_PASSARE"){const a=_(y[s.key]);E(c=>({...c,[s.key]:a?null:"Numero non valido (es. 123 4567890)."}))}}}),R[s.key]?e.jsx("p",{className:"text-xs text-red-600 mt-1",children:R[s.key]}):null]})]},s.key)})}),h.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900",children:"Documenti"}),h.map(s=>e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"text-sm text-gray-700",children:[s.label,s.obbligatorio?e.jsx("span",{className:"text-red-500",children:" *"}):null]}),e.jsx("input",{type:"file",onChange:t=>O(s.key,t.target.files?.[0]||null),className:"block w-full text-sm text-gray-700 file:mr-3 file:rounded-lg file:border file:border-gray-200 file:bg-white file:px-3 file:py-2 file:text-sm file:text-gray-700 hover:file:bg-gray-50",required:!!s.obbligatorio,accept:s.accept||void 0})]},s.key))]}),e.jsxs("div",{className:"pt-2",children:[e.jsx("button",{type:"submit",disabled:S||A,className:`inline-flex items-center justify-center rounded-xl px-5 py-3 text-white font-medium shadow-sm transition-colors ${A?"bg-green-600 hover:bg-green-700":S?"bg-gray-400 cursor-not-allowed":"bg-blue-600 hover:bg-blue-700"} disabled:opacity-75`,children:A?e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"Attivazione inviata"]}):S?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Invio in corso..."]}):"Invia attivazione"}),A&&e.jsx("div",{className:"mt-3 p-3 bg-green-50 border border-green-200 rounded-lg",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("svg",{className:"w-5 h-5 text-green-400 mr-2",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),e.jsx("span",{className:"text-sm text-green-800 font-medium",children:"Attivazione inviata con successo! Puoi selezionare una nuova offerta per continuare."})]})})]})]})}export{ee as D,Q as u};
