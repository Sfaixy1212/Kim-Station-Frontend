import{r as x,j as e}from"./vendor.js";import{_ as D,W as A,a as U}from"./pdfjs.js";import{a as k,D as O}from"./DashboardLayout.js";import"./index.js";import"./logo2.js";let E=null;function I(){E||(E=new A,U.workerPort=E)}async function _(n,{width:u=512,pageNumber:t=1}={}){try{I();const l=await D({url:n,withCredentials:!1}).promise,o=await l.getPage(t),d=o.getViewport({scale:1}),a=u/d.width,m=o.getViewport({scale:a}),i=document.createElement("canvas"),h=i.getContext("2d",{willReadFrequently:!1});i.width=Math.floor(m.width),i.height=Math.floor(m.height),await o.render({canvasContext:h,viewport:m}).promise;const c=i.toDataURL("image/png");return i.width=0,i.height=0,await o.cleanup?.(),await l.cleanup?.(),c}catch(p){return console.warn("[PDF-THUMB] Impossibile generare thumbnail:",p),null}}async function S(){const{data:n}=await k.get("/api/operatori");return(Array.isArray(n)?n:n?.data||[]).map((t,p)=>{if(typeof t=="string"){const a=String(t);return{id:a,name:a,code:a}}const l=String(t.id??t._id??t.value??t.operatorId??t.codice??t.code??p),o=String(t.name??t.label??t.nome??t.denominazione??t.title??l),d=String(t.code??t.codice??t.sigla??l);return{id:l,name:o,code:d}})}async function C(n){const u=String(n||"").trim(),t=u.toUpperCase(),p=u.toLowerCase(),l=t.replace(/\s+/g,"-"),o=t.replace(/\s+/g,"_"),d=t.replace(/\s+/g,""),a=[{url:"/api/dealer/docs",params:{operator:t}},{url:"/api/dealer/docs",params:{operatore:t}},{url:"/api/dealer/docs",params:{operator:l}},{url:"/api/dealer/docs",params:{operator:o}},{url:"/api/dealer/docs",params:{operator:d}},{url:"/api/dealer/docs",params:{operator:p}}];let m;for(const h of a)try{const{data:c}=h.params?await k.get(h.url,{params:h.params}):await k.get(h.url),b=Array.isArray(c)?c:c?.files||c?.documents||c?.data||[];if(!Array.isArray(b))continue;return b.map((s,w)=>({id:s.id??s.ID??s.Id??`${w}-${Math.random().toString(36).slice(2,7)}`,title:s.title??s.titolo??s.nome??s.name??s.Nome??"Documento",fileUrl:s.fileUrl??s.url??s.link??s.href??"#",thumbUrl:s.thumbUrl??s.thumbnail??s.thumb??null,status:s.status??s.stato??"Disponibile",extension:s.extension??s.ext??null}))}catch(c){m=c}const i=new Error(`Nessun documento trovato per operatore "${t}". Verifica che l'endpoint /api/dealer/docs sia raggiungibile e che VITE_API_BASE punti al backend.`);throw i.normalized={message:i.message,cause:m},i}function R(){const n=["1MOBILE","ENI PLENITUDE","FASTWEB","FASTWEB ENERGIA","ILIAD","KENA MOBILE","SKY","WEEDOO"],[u,t]=x.useState([]),[p,l]=x.useState(!0),[o,d]=x.useState(null),[a,m]=x.useState(null),[i,h]=x.useState([]),[c,b]=x.useState(!1),[s,w]=x.useState(null);x.useEffect(()=>{let r=!0;return l(!0),d(null),S().then(g=>{if(!r)return;const y=Array.isArray(g)?g:[],v=new Map(y.map(f=>[String(f.name||"").toUpperCase().trim(),f])),N=n.map(f=>v.get(f.toUpperCase())).filter(Boolean).map(f=>({id:f.id,name:f.name,code:f.code}));t(N),N.length&&!a&&m(N[0].name)}).catch(g=>{r&&d(g?.normalized?.message||g?.message||"Errore caricamento operatori")}).finally(()=>r&&l(!1)),()=>{r=!1}},[]),x.useEffect(()=>{if(!a)return;let r=!0;return b(!0),w(null),C(a).then(g=>{r&&h(g||[])}).catch(g=>{r&&w(g?.normalized?.message||g?.message||"Errore caricamento documenti")}).finally(()=>{r&&b(!1)}),()=>{r=!1}},[a]);const j=x.useMemo(()=>u.find(r=>r.name===a),[u,a]);return e.jsx(O,{title:"Documentazione",children:e.jsxs("div",{className:"rounded-2xl bg-white p-6 sm:p-8 shadow-sm h-[calc(100vh-160px)] mt-4 overflow-hidden flex flex-col",children:[e.jsxs("div",{className:"mb-6 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900",children:"Documenti Operatori"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Consulta e scarica rapidamente i materiali aggiornati degli operatori."})]}),e.jsx("div",{className:"flex items-center gap-2",children:!!i?.length&&e.jsxs("span",{className:"inline-flex items-center rounded-full bg-blue-50 text-blue-700 px-3 py-1 text-xs font-semibold",children:[i.length," documenti"]})})]}),e.jsxs("div",{className:"mb-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Seleziona Operatore"}),!c&&j&&e.jsx("span",{className:"text-xs text-gray-500",children:j.name||j.label||a})]}),e.jsxs("div",{className:"hidden sm:block",children:[e.jsx("div",{className:"flex gap-2 overflow-x-auto no-scrollbar py-1 pr-1",children:(p?Array.from({length:4}):u).map((r,g)=>{if(p)return e.jsx("div",{className:"h-9 w-28 rounded-full bg-gray-100 animate-pulse"},g);const y=r.name,v=y===a;return e.jsxs("button",{onClick:()=>m(y),className:`shrink-0 inline-flex items-center gap-2 h-9 rounded-full border px-4 text-sm font-medium transition-colors ${v?"bg-blue-600 border-blue-600 text-white shadow-sm":"bg-white border-gray-200 text-gray-700 hover:bg-gray-50"}`,title:r.name||y,children:[e.jsx("span",{className:"inline-block h-2.5 w-2.5 rounded-full bg-blue-300"}),r.name||y]},y)})}),!p&&!o&&u.length===0&&e.jsx("div",{className:"mt-2 text-xs text-gray-500",children:"Nessun operatore disponibile."}),o&&e.jsxs("div",{className:"mt-2 text-xs text-red-600 flex items-center justify-between",children:[e.jsx("span",{children:o}),e.jsx("button",{onClick:()=>{l(!0),d(null),S().then(r=>t(Array.isArray(r)?r:[])).catch(r=>d(r?.normalized?.message||r?.message||"Errore caricamento operatori")).finally(()=>l(!1))},className:"ml-3 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Riprova"})]})]}),e.jsxs("div",{className:"sm:hidden",children:[e.jsxs("select",{className:"w-full rounded-lg border border-gray-300 bg-white px-3 py-2 text-sm text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500",value:a||"",onChange:r=>m(r.target.value||null),disabled:p,children:[e.jsx("option",{value:"",disabled:!0,children:p?"Caricamento operatori…":"Scegli operatore"}),u.map(r=>e.jsx("option",{value:r.name,children:r.name},r.name))]}),o&&e.jsxs("div",{className:"mt-2 text-xs text-red-600 flex items-center justify-between",children:[e.jsx("span",{children:o}),e.jsx("button",{onClick:()=>{l(!0),d(null),S().then(t).catch(r=>d(r?.normalized?.message||r?.message||"Errore")).finally(()=>l(!1))},className:"ml-3 px-2 py-1 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Riprova"})]})]})]}),e.jsx("div",{className:"mt-2 flex-1 min-h-0",children:e.jsxs("div",{className:"h-full overflow-y-auto overscroll-contain pr-1",children:[c&&e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:Array.from({length:6}).map((r,g)=>e.jsxs("div",{className:"rounded-xl border border-gray-100 p-4",children:[e.jsx("div",{className:"h-28 rounded-md bg-gray-100 animate-pulse mb-3"}),e.jsx("div",{className:"h-4 w-2/3 bg-gray-100 animate-pulse rounded mb-2"}),e.jsx("div",{className:"h-3 w-1/3 bg-gray-100 animate-pulse rounded"})]},g))}),s&&!c&&e.jsxs("div",{className:"py-6 text-sm text-red-600 flex items-center justify-between",children:[e.jsx("span",{children:s}),e.jsx("button",{onClick:()=>m(r=>r),className:"ml-3 px-3 py-1.5 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Riprova"})]}),!c&&!s&&(i.length===0?e.jsx("div",{className:"py-10 text-center text-sm text-gray-500",children:"Nessun documento disponibile per questo operatore."}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"text-sm font-semibold text-gray-800",children:["Documenti ",j?.name||a]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:i.map(r=>e.jsx(L,{doc:r},r.id))})]}))]})})]})})}function L({doc:n}){const[u,t]=x.useState(n.thumbUrl||null),[p,l]=x.useState(!1);x.useEffect(()=>{let d=!1;const a=n.fileUrl,m=String(n.extension||"").toLowerCase();async function i(){if(n.thumbUrl){t(n.thumbUrl),l(!1);return}if(/\.(png|jpe?g|gif|webp|bmp|svg)(?:\?.*)?$/i.test(a)||["png","jpg","jpeg","gif","webp","bmp","svg"].includes(m)){t(a),l(!1);return}const c=/^https?:\/\//i.test(a),b=m==="pdf"||/\.pdf(?:\?.*)?$/i.test(a);if(c&&!b){try{const{hostname:s}=new URL(a),w=`https://www.google.com/s2/favicons?sz=128&domain=${s}`;t(w),l(!0)}catch{t(null),l(!0)}return}if(m==="pdf"||/\.pdf(?:\?.*)?$/i.test(a)){const s=await _(a,{width:512,pageNumber:1});d||t(s),l(!1);return}t(null),l(!1)}return i(),()=>{d=!0}},[n.fileUrl,n.extension,n.thumbUrl]);const o=()=>{try{window.open(n.fileUrl,"_blank","noopener,noreferrer")}catch{}};return e.jsxs("div",{className:"group rounded-xl border border-gray-100 bg-white p-4 hover:shadow-md transition-shadow",children:[e.jsxs("div",{className:"relative mb-3",children:[u?e.jsx("img",{src:u,alt:n.title,className:"h-28 w-full object-cover rounded-md border border-gray-100"}):e.jsx("div",{className:"h-28 w-full rounded-md bg-gray-50 border border-dashed border-gray-200 flex items-center justify-center text-gray-400",children:e.jsx("span",{className:"text-sm",children:"Anteprima"})}),p&&e.jsx("span",{className:"absolute top-2 left-2 inline-flex items-center rounded-full bg-blue-50/90 text-blue-700 text-[11px] font-medium px-2 py-0.5 border border-blue-100 shadow-sm",children:"Link"}),e.jsx("span",{className:"absolute top-2 right-2 inline-flex items-center rounded-full bg-white/90 text-green-700 text-[11px] font-medium px-2 py-0.5 border border-green-100 shadow-sm",children:"✓ Disponibile"})]}),e.jsx("div",{className:"mb-2 line-clamp-2 text-sm font-medium text-gray-900 min-h-[2rem]",children:n.title}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("button",{onClick:o,className:"inline-flex items-center gap-2 rounded-lg border border-gray-200 bg-white px-3 py-1.5 text-sm text-gray-700 hover:bg-gray-50",children:e.jsx("span",{children:"Apri"})}),e.jsx("a",{href:n.fileUrl,download:!0,className:"inline-flex items-center gap-2 rounded-lg bg-blue-600 px-3 py-1.5 text-sm font-semibold text-white hover:bg-blue-700",children:"Scarica"})]})]})}export{R as default};
