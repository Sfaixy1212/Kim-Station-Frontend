import{r as h,z as O,j as e}from"./vendor.js";import{D as Y}from"./DashboardLayout.js";import{u as _,g as T}from"./index.js";import"./logo2.js";function Q(){const{user:i}=_(),l=new Date().getFullYear(),[c,d]=h.useState(l),[r,x]=h.useState(!1),[n,M]=h.useState(null),[m,k]=h.useState({fastweb:{},sky:{},sim:{}}),[A,F]=h.useState(""),[j,I]=h.useState(""),[B,w]=h.useState(!1),[R,C]=h.useState({tlc:null,energy:null});h.useEffect(()=>{let a=!0;return(async()=>{try{const o=await T("/agente/reportistica/last-updates"),u=o?.data?.data||o?.data||{};if(!a)return;C({tlc:u.tlc||null,energy:u.energy||null})}catch(o){console.warn("[Reportistica] last-updates errore:",o?.message)}})(),()=>{a=!1}},[]),h.useEffect(()=>{let a=!0;return(async()=>{try{x(!0),M(null);const o=new URLSearchParams({year:String(c)});j&&j.trim()&&o.set("dealer",j.trim());const u=`/agente/reportistica/v3?${o.toString()}`;console.log("[Reportistica] Chiamando API:",u);const g=(await T(u))?.data||{};if(a){const b=g.fastweb||{totale:{},dealers:[]},y=g.sky||{totale:{},dealers:[]},v=g.sim||{aggregated:{},details:[]};k({fastweb:{totale:b.totale,dealers:b.dealers||[]},sky:{totale:y.totale,dealers:y.dealers||[]},sim:{aggregated:v.aggregated,details:v.details||[]}}),console.log("[Reportistica] Dati caricati:",g)}}catch(o){console.error("[Reportistica] Errore:",o),a&&(M(o.message||"Errore nel caricamento"),O.error("Errore nel caricamento dati"))}finally{a&&x(!1)}})(),()=>{a=!1}},[c,j]);const E=h.useMemo(()=>{const a=(A||"").trim().toLowerCase();if(!a||a.length<2)return[];const u=(m.fastweb?.dealers||[]).map(b=>b.Point||"").filter(Boolean),S=new Set,g=[];for(const b of u){const y=b.trim(),v=y.toUpperCase();if(!S.has(v)&&(y.toLowerCase().includes(a)&&(S.add(v),g.push(y)),g.length>=15))break}return g},[A,m.fastweb]),f=h.useMemo(()=>{const a=m.fastweb?.totale||{},o=m.sky?.totale||{},u=m.sim?.details||[];let S=0,g=0;if(u.length>0){const b=[...u].sort((p,L)=>(L.AnnoMese||"").localeCompare(p.AnnoMese||"")),y=b[0]?.AnnoMese;b.filter(p=>p.AnnoMese===y).forEach(p=>{p.SIMTYPE==="FW_SIM"?S+=Number(p.SIM_Vendute||0):p.SIMTYPE==="UNO_SIM"&&(g+=Number(p.SIM_Vendute||0))})}return{fissi:Number(a.FISSI||0),mobili:Number(a.MOBILI||0),mobileRA:Number(a.MobileRA||0),percentRA:Number(a.MobilePercentRA||0),energy:Number(a.ENERGY||0),skyTotale:Number(o.SKY_TOTALE||0),simFW:S,simUNO:g,simTotale:S+g}},[m]);return e.jsx(Y,{title:"Reportistica V3",children:e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-100 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-700 font-semibold",children:"Reportistica Agente (Nuova Versione)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{label:"Ultimo Aggiornamento TLC",value:P(R.tlc),color:"blue"}),e.jsx(U,{label:"Ultimo aggiornamento ENERGY",value:P(R.energy),color:"emerald"})]})]}),e.jsx("div",{className:"bg-white rounded-xl p-4 border border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Anno"}),e.jsx("select",{value:c,onChange:a=>d(Number(a.target.value)),className:"rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm",children:[l,l-1,l-2].map(a=>e.jsx("option",{value:a,children:a},a))})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e.jsx("input",{type:"radio",name:"dealerFilter",checked:!j,onChange:()=>{I(""),F(""),w(!1)},className:"text-blue-600"}),"TUTTI"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e.jsx("input",{type:"radio",name:"dealerFilter",checked:!!j,onChange:()=>{},className:"text-blue-600"}),"Dealer specifico"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Ragione Sociale"}),e.jsx("input",{value:A,onChange:a=>{F(a.target.value),I(""),w(!0)},onFocus:()=>w(!0),onKeyDown:a=>{if(a.key==="Enter"&&E.length>0){const o=E[0];F(o),I(o),w(!1),a.preventDefault()}},placeholder:"Ragione Sociale",className:"rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm w-64"}),B&&E.length>0&&e.jsx("div",{className:"absolute z-10 mt-1 w-64 max-h-56 overflow-auto rounded-lg border border-gray-200 bg-white shadow",children:E.map(a=>e.jsx("button",{type:"button",onClick:()=>{F(a),I(a),w(!1)},className:"block w-full text-left px-3 py-2 text-sm hover:bg-gray-50",children:a},a))})]}),r&&e.jsx("div",{className:"text-sm text-gray-500",children:"Caricamentoâ€¦"}),n&&e.jsx("div",{className:"text-sm text-red-600",children:n})]})}),!j&&e.jsxs("section",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3",children:[e.jsx(N,{label:"Fissi",value:f.fissi}),e.jsx(N,{label:"Mobili",value:f.mobili}),e.jsx(N,{label:"Mobile RA",value:f.mobileRA}),e.jsx(N,{label:"% RA",value:`${f.percentRA.toFixed(1)}%`}),e.jsx(N,{label:"Energy",value:f.energy}),e.jsx(N,{label:"Sky",value:f.skyTotale}),e.jsx(N,{label:"SIM FW",value:f.simFW}),e.jsx(N,{label:"SIM Totali",value:f.simTotale})]}),e.jsxs("section",{className:"bg-white rounded-xl p-4 border border-gray-100",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"ðŸ“Š Dettaglio Fastweb"}),e.jsx("div",{className:"overflow-auto max-h-[500px]",children:e.jsx(D,{dealers:m.fastweb?.dealers||[]})})]}),!j&&m.sky?.dealers?.length>0&&e.jsxs("section",{className:"bg-white rounded-xl p-4 border border-gray-100",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"ðŸ“º Dettaglio Sky"}),e.jsx("div",{className:"overflow-auto max-h-[400px]",children:e.jsx(V,{dealers:m.sky?.dealers||[]})})]}),!j&&m.sim?.details?.length>0&&e.jsxs("section",{className:"bg-white rounded-xl p-4 border border-gray-100",children:[e.jsxs("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:["ðŸ“± SIM Vendute (Ultimo Mese: ",[...m.sim?.details||[]].sort((o,u)=>(u.AnnoMese||"").localeCompare(o.AnnoMese||""))[0]?.AnnoMese||"-",")"]}),e.jsx("div",{className:"overflow-auto",children:e.jsx(W,{details:m.sim?.details||[]})})]})]})})}function D({dealers:i}){if(i.length===0)return e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Nessun dato disponibile"});const l=h.useMemo(()=>{const r=i.some(n=>n.FissoStart>0||n.FissoPro>0||n.FissoUltra>0||n.MobileStart>0||n.MobilePro>0||n.MobileUltra>0),x=i.some(n=>n.FissoLight>0||n.FissoCasa>0||n.FissoBusiness>0||n.MobileMobile>0||n.MobileFull>0||n.MobileMaxi>0);return r&&x?"mixed":x?"old":"new"},[i]),c=l==="new"||l==="mixed",d=l==="old"||l==="mixed";return e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-700 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx(s,{children:"Point"}),e.jsx(s,{children:"Mese"}),e.jsx(s,{children:"FISSI"}),c&&e.jsxs(e.Fragment,{children:[e.jsx(s,{children:"Start"}),e.jsx(s,{children:"Pro"}),e.jsx(s,{children:"Ultra"})]}),d&&e.jsxs(e.Fragment,{children:[e.jsx(s,{children:"Light"}),e.jsx(s,{children:"Casa"}),e.jsx(s,{children:"Business"})]}),e.jsx(s,{children:"MOBILI"}),c&&e.jsxs(e.Fragment,{children:[e.jsx(s,{children:"Start"}),e.jsx(s,{children:"Pro"}),e.jsx(s,{children:"Ultra"})]}),d&&e.jsxs(e.Fragment,{children:[e.jsx(s,{children:"Mobile"}),e.jsx(s,{children:"Full"}),e.jsx(s,{children:"Maxi"})]}),e.jsx(s,{children:"RA"}),e.jsx(s,{children:"% RA"}),e.jsx(s,{children:"RES"}),e.jsx(s,{children:"BUS"}),e.jsx(s,{children:"Conv RES"}),e.jsx(s,{children:"Conv BUS"}),e.jsx(s,{children:"ENERGY"}),e.jsx(s,{children:"Core"}),e.jsx(s,{children:"Flex"}),e.jsx(s,{children:"Fix"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:i.map((r,x)=>e.jsxs("tr",{className:"odd:bg-white even:bg-gray-50 hover:bg-blue-50",children:[e.jsx(t,{children:r.Point}),e.jsx(t,{children:r.AnnoMese}),e.jsx(t,{children:e.jsx("strong",{children:r.FISSI||0})}),c&&e.jsxs(e.Fragment,{children:[e.jsx(t,{children:r.FissoStart||0}),e.jsx(t,{children:r.FissoPro||0}),e.jsx(t,{children:r.FissoUltra||0})]}),d&&e.jsxs(e.Fragment,{children:[e.jsx(t,{children:r.FissoLight||0}),e.jsx(t,{children:r.FissoCasa||0}),e.jsx(t,{children:r.FissoBusiness||0})]}),e.jsx(t,{children:e.jsx("strong",{children:r.MOBILI||0})}),c&&e.jsxs(e.Fragment,{children:[e.jsx(t,{children:r.MobileStart||0}),e.jsx(t,{children:r.MobilePro||0}),e.jsx(t,{children:r.MobileUltra||0})]}),d&&e.jsxs(e.Fragment,{children:[e.jsx(t,{children:r.MobileMobile||0}),e.jsx(t,{children:r.MobileFull||0}),e.jsx(t,{children:r.MobileMaxi||0})]}),e.jsx(t,{className:"font-semibold text-blue-600",children:r.MobileRA||0}),e.jsxs(t,{children:[(r.MobilePercentRA||0).toFixed(1),"%"]}),e.jsx(t,{children:r["MOBILI RES"]||0}),e.jsx(t,{children:r["MOBILI BUS"]||0}),e.jsx(t,{children:r["di cui CONV_RES"]||0}),e.jsx(t,{children:r["di cui CONV_BUS"]||0}),e.jsx(t,{children:e.jsx("strong",{children:r.ENERGY||0})}),e.jsx(t,{children:r.EnergyCore||0}),e.jsx(t,{children:r.EnergyFlex||0}),e.jsx(t,{children:r.EnergyFix||0})]},x))})]})}function V({dealers:i}){return i.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Nessun dato Sky disponibile"}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-700 sticky top-0",children:e.jsxs("tr",{children:[e.jsx(s,{children:"Point"}),e.jsx(s,{children:"Mese"}),e.jsx(s,{children:"TV Only"}),e.jsx(s,{children:"Triple Play"}),e.jsx(s,{children:"WiFi RES"}),e.jsx(s,{children:"Sky Glass"}),e.jsx(s,{children:"4P"}),e.jsx(s,{children:"Prova Sky"}),e.jsx(s,{children:"Mobile"}),e.jsx(s,{children:"WiFi BUS"}),e.jsx(s,{children:"B&B BUS"}),e.jsx(s,{children:"BAR BUS"}),e.jsx(s,{children:"TOTALE"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:i.map((l,c)=>e.jsxs("tr",{className:"odd:bg-white even:bg-gray-50 hover:bg-purple-50",children:[e.jsx(t,{children:l.Point}),e.jsx(t,{children:l.Mese}),e.jsx(t,{children:l.TV_ONLY||0}),e.jsx(t,{children:l.TRIPLE_PLAY||0}),e.jsx(t,{children:l.WIFI_RESIDENZIALE||0}),e.jsx(t,{children:l.SKY_GLASS||0}),e.jsx(t,{children:l["4P"]||0}),e.jsx(t,{children:l["PROVA SKY"]||0}),e.jsx(t,{children:l.MOBILE||0}),e.jsx(t,{children:l.WIFI_BUSINESS||0}),e.jsx(t,{children:l["B&B BUS"]||0}),e.jsx(t,{children:l["BAR BUS"]||0}),e.jsx(t,{children:e.jsx("strong",{children:l.SKY_TOTALE||0})})]},c))})]})}function W({details:i}){if(i.length===0)return e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Nessuna SIM venduta"});const l=[...i].sort((n,M)=>(M.AnnoMese||"").localeCompare(n.AnnoMese||"")),c=l[0]?.AnnoMese,d=l.filter(n=>n.AnnoMese===c);let r=0,x=0;return d.forEach(n=>{n.SIMTYPE==="FW_SIM"?r+=Number(n.SIM_Vendute||0):n.SIMTYPE==="UNO_SIM"&&(x+=Number(n.SIM_Vendute||0))}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-blue-50 rounded-lg p-3 border border-blue-200",children:[e.jsx("div",{className:"text-xs text-blue-600 font-medium",children:"FW SIM"}),e.jsx("div",{className:"text-2xl font-bold text-blue-900",children:r})]}),e.jsxs("div",{className:"bg-green-50 rounded-lg p-3 border border-green-200",children:[e.jsx("div",{className:"text-xs text-green-600 font-medium",children:"UNO SIM"}),e.jsx("div",{className:"text-2xl font-bold text-green-900",children:x})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 border border-gray-200",children:[e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:"TOTALE"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:r+x})]})]}),e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-700",children:e.jsxs("tr",{children:[e.jsx(s,{children:"Mese"}),e.jsx(s,{children:"Tipologia"}),e.jsx(s,{children:"QuantitÃ "})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:i.map((n,M)=>e.jsxs("tr",{className:"odd:bg-white even:bg-gray-50",children:[e.jsx(t,{children:n.AnnoMese}),e.jsx(t,{children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${n.SIMTYPE==="FW_SIM"?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:n.SIMTYPE})}),e.jsx(t,{children:e.jsx("strong",{children:n.SIM_Vendute||0})})]},M))})]})]})}function N({label:i,value:l}){return e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-100",children:[e.jsx("div",{className:"text-xs text-gray-600",children:i}),e.jsx("div",{className:"text-xl font-bold text-gray-900",children:l??"-"})]})}function s({children:i}){return e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold whitespace-nowrap",children:i})}function t({children:i,className:l=""}){return e.jsx("td",{className:`px-3 py-2 whitespace-nowrap ${l}`,children:i})}function P(i){if(!i)return"-";try{const l=new Date(i);if(!isNaN(l.getTime())){const r=String(l.getDate()).padStart(2,"0"),x=String(l.getMonth()+1).padStart(2,"0"),n=l.getFullYear();return`${r}/${x}/${n}`}const c=String(i),d=c.match(/^(\d{4})[-/]?(\d{2})[-/]?(\d{2})/);return d?`${d[3]}/${d[2]}/${d[1]}`:c}catch{return"-"}}function U({label:i,value:l,color:c="blue"}){const d={blue:"bg-blue-50 text-blue-700 border-blue-100",emerald:"bg-emerald-50 text-emerald-700 border-emerald-100",amber:"bg-amber-50 text-amber-700 border-amber-100",gray:"bg-gray-50 text-gray-700 border-gray-100"},r=d[c]||d.blue;return e.jsxs("div",{className:`inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs border ${r}`,children:[e.jsx("span",{className:"font-medium whitespace-nowrap",children:i}),e.jsx("span",{className:"font-semibold",children:l??"-"})]})}export{Q as default};
