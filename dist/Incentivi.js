import{r as s,j as e}from"./vendor.js";import{D as H}from"./DashboardLayout.js";import{l as J,j as U,m as W,r as D,s as Z,v as K,n as X,o as ee,q as te,u as se,t as ae,w as V,x as re,y as ne}from"./index.js";import"./logo2.js";function ie(){const[t,d]=s.useState(()=>J()||""),[i,o]=s.useState(!0),m=s.useCallback(()=>{const x=U()||"",l=W()||"";return x!==l?(D(),d(""),Z(x),!1):!0},[]);s.useEffect(()=>{m(),o(!1)},[m]);const u=s.useMemo(()=>!!t,[t]),p=s.useCallback(async x=>{if(!/^[0-9]{6}$/.test(x||""))throw new Error("Codice TOTP non valido");const a=(await K(x))?.token;if(!a)throw new Error("Token elevato non ricevuto");return X(a),d(a),a},[]),y=s.useCallback(()=>{D(),d("")},[]);return{elevatedToken:t,hasValidToken:u,checking:i,request:p,clear:y,ensureCache:m}}function oe(){const[t,d]=s.useState([]),[i,o]=s.useState(!1),[m,u]=s.useState(null),p=s.useCallback(async l=>{o(!0),u(null);try{const a=l?await ee(l):await te(),b=Array.isArray(a)?a:Array.isArray(a?.piani)?a.piani:[];return d(b),b}catch(a){throw u(a?.message||"Errore nel caricamento dei piani"),a}finally{o(!1)}},[]),y=s.useMemo(()=>{const l=new Set;for(const a of t)a?.operatore&&l.add(a.operatore);return Array.from(l).sort()},[t]),x=s.useCallback(l=>(l||[]).reduce((a,b)=>{const v=b?.operatore||"—";return a[v]||(a[v]=[]),a[v].push(b),a},{}),[]);return{piani:t,loading:i,error:m,load:p,operators:y,groupByOperatore:x}}function le(t){if(t?.periodo_label)return t.periodo_label;const d=t?.mese?String(t.mese).padStart(2,"0"):null,i=t?.anno??null;return d&&i?`${d}/${i}`:"—"}function _(t){if(!t)return"—";try{return new Date(t).toLocaleDateString("it-IT")}catch{return String(t)}}function ce({operators:t=[],value:d,onChange:i}){return e.jsxs("select",{className:"border rounded-md px-2 py-1 text-sm",value:d,onChange:o=>i(o.target.value),children:[e.jsx("option",{value:"",children:"Tutti gli operatori"}),t.map(o=>e.jsx("option",{value:o,children:o},o))]})}function de({value:t,onChange:d,options:i}){const o=Array.isArray(i)?i:[];return e.jsx("select",{className:"border rounded-md px-2 py-1 text-sm",value:t,onChange:m=>d(m.target.value),children:o.map(m=>e.jsx("option",{value:m,children:m},m))})}function me({piano:t}){return e.jsxs("div",{className:"rounded-lg border border-gray-100 p-4 flex flex-col",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500",children:"Periodo"}),e.jsx("div",{className:"text-sm font-medium text-gray-900",children:le(t)})]}),e.jsx("div",{className:"text-blue-600",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"currentColor",className:"w-6 h-6",children:e.jsx("path",{d:"M6 2a2 2 0 0 0-2 2v16l8-4 8 4V4a2 2 0 0 0-2-2H6Z"})})})]}),e.jsx("div",{className:"mt-2 text-sm text-gray-700 line-clamp-2",children:t?.nome_file||"Documento"}),e.jsxs("div",{className:"mt-2 text-xs text-gray-500",children:["Validità: ",_(t?.validita_dal)," → ",_(t?.validita_al)]}),e.jsx("div",{className:"mt-auto pt-3",children:e.jsx("a",{className:"inline-flex items-center gap-2 px-3 py-1.5 rounded-md bg-blue-600 hover:bg-blue-700 text-white text-sm",href:t?.url_s3||"#",target:"_blank",rel:"noopener noreferrer",children:"Apri / Scarica"})})]})}function ue({items:t=[]}){return t.length?e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4",children:t.map((d,i)=>e.jsx(me,{piano:d},i))}):e.jsx("div",{className:"text-sm text-gray-500 py-6",children:"Nessun piano disponibile per l'operatore selezionato."})}function xe({open:t,onSubmit:d,onCancel:i,onNeedEnroll:o,loading:m,enrolled:u}){const[p,y]=s.useState(""),[x,l]=s.useState(!1);return s.useEffect(()=>{t||y("")},[t]),t?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:i}),e.jsxs("div",{className:"relative bg-white rounded-xl shadow-lg w-full max-w-sm p-5",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-900",children:"Verifica TOTP"}),e.jsx("div",{className:"text-sm text-gray-600 mt-1",children:"Inserisci il codice OTP a 6 cifre per accedere ai Piani Incentivi."}),e.jsxs("div",{className:"mt-2 text-xs text-gray-600 flex items-center gap-3",children:[e.jsx("button",{type:"button",className:"underline",onClick:()=>o?.(),children:"Non hai ancora configurato l’OTP? Abilitalo ora"}),e.jsx("span",{className:"text-gray-300",children:"|"}),e.jsx("button",{type:"button",className:`underline ${u?"text-rose-700":"text-gray-400 cursor-not-allowed"}`,disabled:!u,onClick:async()=>{try{await V(),o?.()}catch{alert("Errore durante il reset OTP")}},children:"Hai dimenticato l’OTP? Reimposta"})]}),!u&&e.jsxs("div",{className:"mt-2 rounded-md bg-blue-50 border border-blue-100 p-3 text-xs text-blue-800",children:[e.jsx("div",{className:"font-medium mb-1",children:"Come attivare l’OTP"}),e.jsxs("ol",{className:"list-decimal list-inside space-y-1",children:[e.jsx("li",{children:"Installa un’app Authenticator (Google, Microsoft, Authy, 1Password…)"}),e.jsxs("li",{children:["Clicca su ",e.jsx("button",{type:"button",className:"underline font-medium",onClick:()=>o?.(),children:"Abilita OTP"})," per aprire il QR Code"]}),e.jsx("li",{children:"Nell’app, “Aggiungi account” → “Scansiona QR” e conferma"}),e.jsx("li",{children:"Inserisci qui il codice a 6 cifre mostrato dall’app"})]})]}),e.jsx("input",{autoFocus:!0,type:"text",inputMode:"numeric",pattern:"[0-9]*",maxLength:6,value:p,onChange:a=>y(a.target.value.replace(/\D/g,"")),className:"mt-4 w-full border rounded-md px-3 py-2 text-center tracking-widest text-lg",placeholder:"••••••"}),e.jsxs("div",{className:"mt-4 flex items-center justify-between gap-2",children:[e.jsx("button",{onClick:i,className:"px-3 py-1.5 text-sm border rounded-md",children:"Annulla"}),e.jsxs("div",{className:"flex items-center gap-2",children:[u&&e.jsx("button",{type:"button",disabled:x,onClick:async()=>{try{l(!0),await V(),o?.()}catch{alert("Errore durante il reset OTP")}finally{l(!1)}},className:"px-3 py-1.5 text-sm border rounded-md text-rose-700 border-rose-200 hover:bg-rose-50 disabled:opacity-60",title:"Reimposta OTP e rifai associazione",children:x?"Reimposto…":"Reimposta OTP"}),!u&&e.jsx("button",{type:"button",onClick:()=>o?.(),className:"px-3 py-1.5 text-sm border rounded-md",children:"Abilita OTP"}),e.jsx("button",{disabled:m||p.length!==6,onClick:()=>d(p),className:"px-3 py-1.5 text-sm rounded-md bg-blue-600 text-white disabled:opacity-60",children:m?"Verifica…":"Verifica"})]})]})]})]}):null}function fe({open:t,onClose:d}){const[i,o]=s.useState(!1),[m,u]=s.useState(!1),[p,y]=s.useState(null),[x,l]=s.useState("");return s.useEffect(()=>{t&&(async()=>{try{u(!0);const a=await re();y(a)}catch(a){console.error("Enroll MFA error:",a)}finally{u(!1)}})()},[t]),t?e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:d}),e.jsxs("div",{className:"relative bg-white rounded-xl shadow-lg w-full max-w-md p-5",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-900",children:"Abilita OTP (TOTP)"}),m?e.jsx("div",{className:"py-8 text-sm text-gray-500",children:"Caricamento…"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mt-2 text-sm text-gray-600",children:"Scansiona il QR con l'app Authenticator e inserisci il codice di verifica."}),e.jsxs("div",{className:"mt-3 flex items-center gap-4",children:[e.jsx("img",{src:`/api/mfa/totp/qr?otpauth=${encodeURIComponent(p?.otpauth||"")}`,alt:"QR TOTP",className:"w-40 h-40 border rounded"}),e.jsxs("div",{className:"text-xs text-gray-600",children:[e.jsx("div",{className:"font-medium text-gray-900",children:"Secret"}),e.jsx("div",{className:"select-all break-all",children:p?.secret||"-"})]})]}),e.jsx("input",{type:"text",inputMode:"numeric",pattern:"[0-9]*",maxLength:6,value:x,onChange:a=>l(a.target.value.replace(/\D/g,"")),className:"mt-4 w-full border rounded-md px-3 py-2 text-center tracking-widest text-lg",placeholder:"••••••"}),e.jsxs("div",{className:"mt-3 flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:d,className:"px-3 py-1.5 text-sm border rounded-md",children:"Chiudi"}),e.jsx("button",{className:"px-3 py-1.5 text-sm rounded-md bg-emerald-600 text-white disabled:opacity-60",disabled:x.length!==6,onClick:async()=>{try{u(!0),(await ne(x))?.ok&&o(!0)}catch(a){console.error("Verify enrollment error",a)}finally{u(!1)}},children:"Verifica"})]}),i&&e.jsx("div",{className:"mt-3 text-sm text-emerald-700 bg-emerald-50 border border-emerald-200 rounded px-3 py-2",children:"Verifica riuscita! OTP abilitato."})]})]})]}):null}function be(){const{user:t,logout:d}=se(),i=(t?.role||"").toString().toLowerCase(),o=i==="dealer",m=o||i==="agente"||i==="agent"||i==="attivazioni"||i==="masterprodotti"||i==="master_prodotti"||i==="master"||i==="supermaster",{elevatedToken:u,hasValidToken:p,checking:y,request:x}=ie(),{piani:l,loading:a,error:b,load:v,operators:L}=oe(),[j,C]=s.useState(""),P=new Date,[h,O]=s.useState(P.getMonth()+1),[g,E]=s.useState(P.getFullYear()),[$,N]=s.useState(!1),[F,A]=s.useState(!1),[B,T]=s.useState(!1),[w,q]=s.useState(!1);s.useEffect(()=>{try{const r=localStorage.getItem("incentivi_filters");if(r){const n=JSON.parse(r);typeof n.operator=="string"&&C(n.operator),n.month&&O(Number(n.month)),n.year&&E(Number(n.year))}}catch{}},[]),s.useEffect(()=>{try{const r={operator:j,month:h,year:g};localStorage.setItem("incentivi_filters",JSON.stringify(r))}catch{}},[j,h,g]),s.useEffect(()=>{if(!m){window.location.href="/login";return}},[m]),s.useEffect(()=>{(async()=>{if(!y)try{if(o){try{const r=await ae();q(!!r?.enrolled)}catch{}if(!p){N(!0);return}await v(u)}else await v(null)}catch(r){console.error("Load piani error:",r)}})()},[y,p,u,o,v]);const z=s.useMemo(()=>t?.dealerName||t?.agenteNome||t?.name||t?.email||"Utente",[t]);s.useMemo(()=>{const r=new Set;for(const c of l)c?.mese&&r.add(Number(c.mese));const n=Array.from(r).sort((c,f)=>c-f);return n.includes(h)||n.push(h),n.sort((c,f)=>c-f)},[l,h]),s.useMemo(()=>{const r=new Set;for(const c of l)c?.anno&&r.add(Number(c.anno));const n=Array.from(r).sort((c,f)=>c-f);return n.includes(g)||n.push(g),n.sort((c,f)=>c-f)},[l,g]);const k=(r,n)=>`${String(r).padStart(2,"0")}/${n}`,Q=s.useMemo(()=>{const r=new Set;for(const c of l){const f=c?.periodo_label||(c?.mese&&c?.anno?k(c.mese,c.anno):null);f&&r.add(String(f))}r.add(k(h,g));const n=Array.from(r);return n.sort((c,f)=>{const[S,I]=c.split("/").map(Number),[G,R]=f.split("/").map(Number);return I!==R?R-I:G-S}),n},[l,h,g]),Y=s.useMemo(()=>k(h,g),[h,g]),M=s.useMemo(()=>{let r=l;return j&&(r=r.filter(n=>n?.operatore===j)),h&&(r=r.filter(n=>Number(n?.mese)===Number(h))),g&&(r=r.filter(n=>Number(n?.anno)===Number(g))),r},[l,j,h,g]);return e.jsxs(H,{title:"Piani Incentivi",children:[e.jsxs("div",{className:"rounded-2xl bg-white p-4 sm:p-6 shadow-sm mt-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h1",{className:"text-xl sm:text-2xl font-bold text-gray-900",children:"Piani Incentivi"}),o&&e.jsx("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded text-xs font-medium border ${w?"bg-emerald-50 text-emerald-700 border-emerald-200":"bg-gray-50 text-gray-600 border-gray-200"}`,title:w?"OTP attivo sul tuo account":"OTP non configurato",children:w?"OTP attivo":"OTP non configurato"})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Benvenuto, ",e.jsx("span",{className:"font-medium text-gray-900",children:z})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:o&&e.jsx(e.Fragment,{children:e.jsx("button",{className:"text-sm px-3 py-1.5 border rounded-md",onClick:()=>T(!0),children:"Abilita OTP"})})})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto",children:[e.jsx(ce,{operators:L,value:j,onChange:C}),e.jsx(de,{value:Y,onChange:r=>{const[n,c]=String(r).split("/"),f=Number(n),S=Number(c);Number.isNaN(f)||O(f),Number.isNaN(S)||E(S)},options:Q})]}),e.jsxs("div",{className:"text-xs text-gray-500",children:[M.length," elementi"]})]}),a&&e.jsx("div",{className:"py-8 text-sm text-gray-500",children:"Caricamento…"}),b&&!a&&e.jsx("div",{className:"py-8 text-sm text-red-600",children:b}),!a&&!b&&e.jsx(ue,{items:M})]}),e.jsx(xe,{open:$,loading:F,onCancel:()=>{N(!1),window.location.href="/login"},onNeedEnroll:()=>{N(!1),T(!0)},enrolled:w,onSubmit:async r=>{try{A(!0),await x(r),N(!1),await v(localStorage.getItem("token_incentivi"))}catch(n){console.error("TOTP verify error",n),alert("Codice non valido")}finally{A(!1)}}}),e.jsx(fe,{open:B,onClose:()=>T(!1)})]})}export{be as default};
