import{r as s,V as M,j as e,u as S,O as I,d as b}from"./vendor.js";import{u as L}from"./index.js";function R({isOpen:n,onClose:f,selectedKey:d,credsMap:u}){const h=s.useRef(null),[x,g]=s.useState(!1),m=s.useRef(!1);return s.useEffect(()=>{if(!n)return;const r=document.body.style.overflow;return document.body.style.overflow="hidden",()=>{document.body.style.overflow=r}},[n]),s.useEffect(()=>{if(!n)return;m.current=!1;const r=o=>{try{if(o.origin!==window.location.origin)return;if(o.data&&o.data.type==="IMPERSONATE_ACK"){g(!0);try{if(m.current)return;const i=h.current,p=u?.[d];if(!i||!p)return;i.contentWindow?.postMessage({type:"IMPERSONATE_LOGIN",payload:{email:p.email,password:p.password}},window.location.origin),m.current=!0}catch{}}}catch{}};return window.addEventListener("message",r),()=>window.removeEventListener("message",r)},[n]),s.useEffect(()=>{if(!n)return;g(!1),m.current=!1;try{h.current?.contentWindow?.postMessage({type:"IMPERSONATE_RESET"},window.location.origin)}catch{}const r=setTimeout(()=>{try{if(m.current)return;const o=h.current,i=u?.[d];if(!o||!i)return;o.contentWindow?.postMessage({type:"IMPERSONATE_LOGIN",payload:{email:i.email,password:i.password}},window.location.origin),m.current=!0}catch{}},1e3);return()=>clearTimeout(r)},[n,d]),s.useEffect(()=>{if(!n)return;const r=h.current;if(!r)return;const o=()=>{try{const i=u?.[d];r.contentWindow?.postMessage({type:"IMPERSONATE_RESET"},window.location.origin),setTimeout(()=>{i&&r.contentWindow?.postMessage({type:"IMPERSONATE_LOGIN",payload:{email:i.email,password:i.password}},window.location.origin)},200)}catch{}};return r.addEventListener("load",o),()=>r.removeEventListener("load",o)},[n,d,u]),n?M.createPortal(e.jsxs("div",{className:"fixed inset-0 z-[1000] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/40",onClick:f}),e.jsxs("div",{className:"relative bg-white rounded-xl shadow-2xl w-[95vw] h-[85vh] max-w-6xl overflow-hidden border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-2 border-b border-gray-200 bg-gray-50",children:[e.jsxs("div",{className:"text-sm text-gray-700",children:["Sessione embedded • Accedi come: ",e.jsx("strong",{children:u?.[d]?.label||d})]}),e.jsx("button",{onClick:f,className:"px-3 py-1.5 text-sm rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Chiudi"})]}),e.jsx("iframe",{ref:h,title:"Impersonate",src:`/login?imp=${encodeURIComponent(d)}&t=${Date.now()}`,className:"block w-full h-[calc(85vh-40px)]"})]})]}),document.body):null}function z(){const n=S(),f=I(),{logout:d,user:u}=L(),[h,x]=s.useState(!1),[g,m]=s.useState(!1),[r,o]=s.useState("dealer"),[i,p]=s.useState(null),[N,v]=s.useState(null),w=s.useRef(null),k={dealer:{label:"DEALER",email:"mdlcomunicazioni@gmail.com",password:"Maglie25."},agente:{label:"AGENTE",email:"g.rosato@kimweb.it",password:"Fasano123!"},backoffice:{label:"BACKOFFICE",email:"attivazioni@kimweb.it",password:"Savana2025!"},amministrazione:{label:"AMMINISTRAZIONE",email:"amministrazione@kimweb.it",password:"!Kimbr2025"}},j=[{label:"Dashboard",items:[{name:"Home",href:"/supermaster"}]},{label:"Field & CRM",items:[{name:"CRM Visite",href:"/supermaster/crm-visite"},{name:"Agenti",href:"/supermaster/analisi"},{name:"Geolocalizzazione",href:"/supermaster/geolocalizzazione"}]},{label:"Analisi",items:[{name:"Analisi FW",href:"/supermaster/analisi-fw"},{name:"Analisi SKY",href:"/supermaster/analisi-sky"},{name:"Dealer Trend",href:"/supermaster/dealer-trend"}]},{label:"Compensi & Incentivi",items:[{name:"Compensi Agenti",href:"/supermaster/compensi"},{name:"Compensi Dealer",href:"/supermaster/compensi-dealer"},{name:"Piani Incentivi",href:"/supermaster/piani-incentivi-modulare"}]},{label:"Strumenti",items:[{name:"Tool Operativi",href:"/supermaster/strumenti"},{name:"Attività Backend",href:"/supermaster/attivita-backend"}]}],E=t=>t.items.some(c=>f.pathname.startsWith(c.href));s.useEffect(()=>{p(null),v(null),x(!1)},[f.pathname]);const A=t=>{p(c=>c===t?null:t)};s.useEffect(()=>{const t=c=>{w.current&&!w.current.contains(c.target)&&p(null)};return document.addEventListener("mousedown",t),()=>document.removeEventListener("mousedown",t)},[]);const C=()=>e.jsx("nav",{ref:w,className:"hidden md:flex items-center gap-2",children:j.map(t=>{if(t.items.length===1){const a=t.items[0];return e.jsx(b,{to:a.href,className:({isActive:y})=>`px-3 py-2 rounded-md text-sm font-medium transition-colors ${y?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"}`,end:a.href==="/supermaster",children:a.name},a.href)}const c=E(t),l=i===t.label;return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>A(t.label),className:`flex items-center gap-1 px-3 py-2 rounded-md text-sm font-medium transition-colors ${c?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"}`,children:[e.jsx("span",{children:t.label}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${l?"rotate-180":""}`,viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg","aria-hidden":"true",children:e.jsx("path",{d:"M6 8l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})})]}),e.jsx("div",{className:`absolute left-0 top-full mt-1 w-56 rounded-lg border border-gray-200 bg-white shadow-lg transition-all duration-150 ${l?"opacity-100 translate-y-0 pointer-events-auto":"opacity-0 -translate-y-1 pointer-events-none"}`,children:e.jsx("div",{className:"py-2",children:t.items.map(a=>e.jsx(b,{to:a.href,onClick:()=>p(null),className:({isActive:y})=>`block px-4 py-2 text-sm ${y?"text-blue-600 font-semibold bg-blue-50":"text-gray-700 hover:bg-gray-100"}`,end:a.href==="/supermaster",children:a.name},a.href))})})]},t.label)})});return e.jsxs("div",{className:"sticky top-0 z-50 pointer-events-auto bg-white/80 backdrop-blur border-b border-gray-200",children:[e.jsx("div",{className:"w-full px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex items-center justify-between h-14",children:[e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("span",{className:"font-semibold text-gray-800",children:"KIM Station • ARMANDO"})}),e.jsx("button",{className:"md:hidden inline-flex items-center justify-center w-9 h-9 rounded-md border border-gray-200 text-gray-700 hover:bg-gray-50","aria-label":"Apri menu",onClick:()=>x(t=>!t),children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",className:"w-5 h-5",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",d:"M4 7h16M4 12h16M4 17h16"})})}),C(),e.jsxs("div",{className:"hidden md:flex items-center gap-2",children:[e.jsxs("div",{className:"hidden sm:flex items-center gap-2 mr-2",children:[e.jsx("span",{className:"text-sm text-gray-500",children:"Accedi come"}),e.jsxs("select",{value:r,onChange:t=>o(t.target.value),className:"text-sm border-gray-300 rounded-md",children:[e.jsx("option",{value:"dealer",children:"DEALER"}),e.jsx("option",{value:"agente",children:"AGENTE"}),e.jsx("option",{value:"backoffice",children:"BACKOFFICE"}),e.jsx("option",{value:"amministrazione",children:"AMMINISTRAZIONE"})]}),e.jsx("button",{onClick:()=>m(!0),className:"px-3 py-2 text-sm rounded-md bg-blue-600 hover:bg-blue-700 text-white",children:"Apri"})]}),u?.name&&e.jsx("span",{className:"hidden sm:inline text-sm text-gray-500 mr-2",children:u.name}),e.jsx("button",{onClick:async()=>{try{await d()}finally{n("/login",{replace:!0})}},className:"px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700","aria-label":"Logout",children:"Logout"})]})]})}),h&&e.jsx("div",{className:"md:hidden border-t border-gray-200 bg-white/95 backdrop-blur",children:e.jsxs("div",{className:"px-4 py-3 space-y-2",children:[j.map(t=>{if(t.items.length===1){const l=t.items[0];return e.jsx(b,{to:l.href,onClick:()=>x(!1),className:({isActive:a})=>`block px-3 py-2 rounded-md text-sm ${a?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"}`,end:l.href==="/supermaster",children:l.name},l.href)}const c=N===t.label;return e.jsxs("div",{className:"border border-gray-100 rounded-lg",children:[e.jsxs("button",{type:"button",onClick:()=>v(c?null:t.label),className:"w-full flex items-center justify-between px-3 py-2 text-sm font-medium text-gray-700",children:[e.jsx("span",{children:t.label}),e.jsx("svg",{className:`w-4 h-4 transition-transform ${c?"rotate-180":""}`,viewBox:"0 0 20 20",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:e.jsx("path",{d:"M6 8l4 4 4-4",stroke:"currentColor",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"})})]}),c&&e.jsx("div",{className:"px-3 pb-2 space-y-1",children:t.items.map(l=>e.jsx(b,{to:l.href,onClick:()=>x(!1),className:({isActive:a})=>`block px-3 py-2 rounded-md text-sm ${a?"bg-blue-600 text-white":"text-gray-700 hover:bg-gray-100"}`,end:l.href==="/supermaster",children:l.name},l.href))})]},t.label)}),e.jsx("button",{onClick:async()=>{x(!1);try{await d()}finally{n("/login",{replace:!0})}},className:"w-full text-left px-3 py-2 rounded-md text-sm bg-red-50 hover:bg-red-100 text-red-700 font-medium",children:"Logout"})]})}),e.jsx(R,{isOpen:g,onClose:()=>m(!1),selectedKey:r,credsMap:k})]})}export{z as S};
