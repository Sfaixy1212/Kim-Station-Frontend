import{b as z,r as a,j as t,d as F,z as x}from"./vendor.js";import{S as V}from"./Topbar2.js";import{C as R}from"./Card.js";import{g as w}from"./index.js";function C({label:o,value:u,onChange:c}){return t.jsxs("div",{children:[t.jsx("label",{className:"block text-base font-semibold text-gray-700 dark:text-gray-300 mb-2",children:o}),t.jsx("input",{type:"month",value:u,onChange:d=>c(d.target.value),className:"border dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-md px-4 py-3 text-base w-full"})]})}function K(o,u=300){const[c,d]=a.useState(o);return a.useEffect(()=>{const l=setTimeout(()=>d(o),u);return()=>clearTimeout(l)},[o,u]),c}function Q(){const[o,u]=z(),[c,d]=a.useState(""),[l,h]=a.useState([]),[v,k]=a.useState(!1),[g,y]=a.useState(null),[D,n]=a.useState(!1),[A,m]=a.useState(-1),[b,T]=a.useState(o.get("from")||(()=>{const e=new Date;return e.setMonth(e.getMonth()-11),`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`})()),[f,L]=a.useState(o.get("to")||(()=>{const e=new Date;return`${e.getFullYear()}-${String(e.getMonth()+1).padStart(2,"0")}`})()),[p,j]=a.useState(null),[N,I]=a.useState(!1),M=K(c,300);a.useEffect(()=>{(async()=>{const r=M.trim();if(r.length<2){h([]),n(!1);return}k(!0);try{const s=await w(`/supermaster/dealers/search?q=${encodeURIComponent(r)}`),i=Array.isArray(s)?s:Array.isArray(s?.results)?s.results:Array.isArray(s?.rows)?s.rows:[];h(i),n(i.length>0),m(i.length?0:-1)}catch(s){console.error("[SM][DEALER SEARCH][ERR]",s),n(!1)}finally{k(!1)}})()},[M]);const E=e=>{y(e),d(e?.RagioneSociale||e?.name||""),h([]),n(!1),m(-1)},Y=e=>{if(!(!D||!l.length))if(e.key==="ArrowDown")e.preventDefault(),m(r=>(r+1)%l.length);else if(e.key==="ArrowUp")e.preventDefault(),m(r=>(r-1+l.length)%l.length);else if(e.key==="Enter"){e.preventDefault();const r=l[Math.max(0,A)];r&&E(r)}else e.key==="Escape"&&(e.preventDefault(),n(!1))},$=async()=>{const e=g?.IDDealer||g?.DealerID||g?.id;if(!e){x.error("Seleziona un dealer");return}I(!0),j(null);const r=x.loading("Calcolo andamento mensile…");try{const s=`/supermaster/dealers/${encodeURIComponent(e)}/trend?from=${b}&to=${f}`,i=await w(s);j(i),u({dealerId:e,from:b,to:f},{replace:!0})}catch(s){console.error("[SM][DEALER TREND][ERR]",s),x.error(s?.message||"Endpoint v2 non disponibile: contatta admin per deploy backend")}finally{x.dismiss(r),I(!1)}},_=a.useMemo(()=>Array.isArray(p?.months)?p.months:[],[p]),P=e=>{const r=["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],s=(e?.mese_label||e?.month||"").toString();if(/[A-Za-zÀ-ÿ]/.test(s))return s.replace("-","/");const i=e?.anno??e?.Year,S=e?.mese??e?.Month;if(i&&S){const O=Math.max(1,Number(S))-1;return`${r[O]||String(S).padStart(2,"0")}/${i}`}return s||""};return t.jsxs(t.Fragment,{children:[t.jsx(V,{}),t.jsxs("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6",children:[t.jsxs("div",{className:"mb-6 flex items-center justify-between gap-3",children:[t.jsxs("div",{children:[t.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"Andamento Dealer"}),t.jsx("p",{className:"text-sm text-gray-500",children:"Ricerca un dealer e visualizza l'andamento mensile su un intervallo di mesi."})]}),t.jsx(F,{to:"/supermaster",className:"px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Torna a SuperMaster"})]}),t.jsxs(R,{title:"Cerca dealer",subtitle:"Inserisci almeno 2 caratteri. Nessun filtro: sono inclusi tutti i dealer.",className:"py-6",children:[t.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[t.jsxs("div",{className:"relative",children:[t.jsx("label",{className:"block text-base font-semibold text-gray-700 dark:text-gray-300 mb-2",children:"Dealer"}),t.jsx("input",{value:c,onChange:e=>{d(e.target.value),e.target.value?n(!0):(y(null),n(!1))},onFocus:()=>{l.length&&n(!0)},onBlur:()=>{setTimeout(()=>n(!1),150)},onKeyDown:Y,placeholder:"Cerca per Ragione Sociale, P.IVA, Nome/Cognome Agente, ecc.",className:"w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-gray-200 rounded-md px-4 py-3 text-base"}),v&&t.jsx("div",{className:"absolute right-2 top-9 text-xs text-gray-500",children:"Ricerca…"}),D&&c.trim().length>=2&&!v&&t.jsx("div",{className:"absolute z-[60] mt-1 bg-white dark:bg-gray-800 border dark:border-gray-700 rounded w-full max-h-96 overflow-auto shadow-lg",children:l.length===0?t.jsx("div",{className:"px-3 py-2 text-sm text-gray-500 dark:text-gray-400",children:"Nessun dealer trovato"}):l.map((e,r)=>t.jsxs("button",{type:"button",className:`w-full text-left px-3 py-2 text-sm border-b border-gray-100 dark:border-gray-700 last:border-b-0 ${r===A?"bg-blue-50 dark:bg-blue-900/30":"hover:bg-gray-50 dark:hover:bg-gray-700"}`,onMouseEnter:()=>m(r),onMouseDown:s=>s.preventDefault(),onClick:()=>E(e),children:[t.jsx("div",{className:"font-medium text-gray-900 dark:text-gray-100",children:e.RagioneSociale||e.name}),t.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:["ID: ",e.IDDealer||e.DealerID||e.id," ",e.PartitaIVA?`• PIVA ${e.PartitaIVA}`:""]})]},e.IDDealer||e.id))})]}),t.jsx(C,{label:"Da (YYYY-MM)",value:b,onChange:T}),t.jsx(C,{label:"A (YYYY-MM)",value:f,onChange:L})]}),t.jsxs("div",{className:"mt-8 flex items-center gap-3",children:[t.jsx("button",{type:"button",onClick:$,disabled:N||!g,className:`px-6 py-3 rounded-md text-white text-base font-medium ${N?"bg-gray-400":"bg-blue-600 hover:bg-blue-700"}`,children:N?"Elaborazione…":"Vedi andamento"}),t.jsx("button",{type:"button",onClick:()=>{y(null),d(""),j(null)},className:"px-5 py-3 text-base font-medium rounded-md bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300",children:"Reset"})]})]}),p&&t.jsx("div",{className:"mt-6 grid grid-cols-1 gap-6",children:t.jsx(R,{title:"Andamento mensile",subtitle:"Valori aggregati per mese (vista analisi_supermaster_dealer)",children:_.length?t.jsx("div",{className:"overflow-auto",children:t.jsxs("table",{className:"min-w-full text-sm",children:[t.jsx("thead",{children:t.jsxs("tr",{className:"text-left text-gray-600",children:[t.jsx("th",{className:"py-2 pr-4",children:"Mese"}),t.jsx("th",{className:"py-2 pr-4",children:"TLC FISSO SHP"}),t.jsx("th",{className:"py-2 pr-4",children:"TLC MOBILE SHP"}),t.jsx("th",{className:"py-2 pr-4",children:"TLC FISSO RES"}),t.jsx("th",{className:"py-2 pr-4",children:"TLC MOBILE RES"}),t.jsx("th",{className:"py-2 pr-4",children:"TLC MOBILE RES RIC.AUTO"}),t.jsx("th",{className:"py-2 pr-4",children:"TLC MOBILE RES RIC.PURA"}),t.jsx("th",{className:"py-2 pr-4",children:"ENERGIA"}),t.jsx("th",{className:"py-2 pr-4",children:"SKY WIFI"}),t.jsx("th",{className:"py-2 pr-4",children:"PROVA SKY"}),t.jsx("th",{className:"py-2 pr-4",children:"SKY GLASS"}),t.jsx("th",{className:"py-2 pr-4",children:"SKY 3P"}),t.jsx("th",{className:"py-2 pr-4",children:"SKYTV_ONLY"})]})}),t.jsx("tbody",{children:_.map(e=>t.jsxs("tr",{className:"border-t",children:[t.jsx("td",{className:"py-2 pr-4 font-medium",children:P(e)}),t.jsx("td",{className:"py-2 pr-4",children:e.tlc_fisso_shp??0}),t.jsx("td",{className:"py-2 pr-4",children:e.tlc_mobile_shp??0}),t.jsx("td",{className:"py-2 pr-4",children:e.tlc_fisso_res??0}),t.jsx("td",{className:"py-2 pr-4",children:e.tlc_mobile_res??0}),t.jsx("td",{className:"py-2 pr-4",children:e.tlc_mobile_res_ric_auto??0}),t.jsx("td",{className:"py-2 pr-4",children:e.tlc_mobile_res_ric_pura??0}),t.jsx("td",{className:"py-2 pr-4",children:e.energia??0}),t.jsx("td",{className:"py-2 pr-4",children:e.sky_wifi??0}),t.jsx("td",{className:"py-2 pr-4",children:e.prova_sky??0}),t.jsx("td",{className:"py-2 pr-4",children:e.sky_glass??0}),t.jsx("td",{className:"py-2 pr-4",children:e.sky_triple_play??0}),t.jsx("td",{className:"py-2 pr-4",children:e.skytv_only??0})]},e.month||e.mese_label||`${e.anno}-${e.mese}`))})]})}):t.jsx("div",{className:"text-sm text-gray-500",children:"Nessun dato per l'intervallo selezionato."})})})]})]})}export{Q as default};
