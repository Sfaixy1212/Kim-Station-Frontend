import{r as a,j as e}from"./vendor.js";import{a as O,D as Q}from"./DashboardLayout.js";import{u as H}from"./index.js";import{P as J}from"./ProductCard.js";import{u as K}from"./useProdotti.js";import"./logo2.js";function V(){const[o,v]=a.useState([]),[x,h]=a.useState(!1),[g,j]=a.useState(null),[d,p]=a.useState(null),N=a.useCallback(async()=>{h(!0),j(null);try{const u=(await O.get("/api/agente/miei-dealer"))?.data||{},C=Array.isArray(u.dealers)?u.dealers:[];v(C.map(f=>({id:String(f.id),ragioneSociale:f.ragioneSociale,email:f.email,telefono:f.telefono}))),u.idAgente&&p(u.idAgente)}catch(S){j(S.normalized||S)}finally{h(!1)}},[]);return a.useEffect(()=>{N()},[N]),{dealers:o,idAgente:d,loading:x,error:g,refetch:N}}function Z({dealers:o=[],selectedId:v,onChange:x}){const[h,g]=a.useState(""),j=a.useMemo(()=>{const d=h.trim().toLowerCase(),p=Array.isArray(o)?o:[];return d?p.filter(N=>(N.ragioneSociale||"").toLowerCase().includes(d)):p},[o,h]);return e.jsx("div",{className:"bg-white rounded-xl p-4 sm:p-5 border border-gray-100",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 items-start sm:items-end",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Cerca dealer"}),e.jsx("input",{type:"text",value:h,onChange:d=>g(d.target.value),placeholder:"Filtra per ragione sociale...",className:"w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm"})]}),e.jsxs("div",{className:"w-full sm:w-96",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Seleziona dealer"}),e.jsxs("select",{value:v||"",onChange:d=>{const p=d.target.value;x?.(p)},className:"w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm",children:[e.jsx("option",{value:"",disabled:!0,children:"Seleziona un dealer..."}),j.map(d=>e.jsx("option",{value:d.id,children:d.ragioneSociale},d.id))]})]})]})})}function G({items:o,onIncrease:v,onDecrease:x,onRemove:h,transportMethod:g,setTransportMethod:j,notes:d,setNotes:p,onCheckout:N,photos:S=[],onAddPhotos:u,onRemovePhoto:C}){const f=a.useMemo(()=>{if(g==="Consegna a Mano")return 0;const s=o.map(c=>Number(c.speseSpedizione??c.SpeseSpedizione??0)).filter(c=>Number.isFinite(c)&&c>=0);return s.length===0?0:Math.max(0,...s)},[g,o]),I=a.useMemo(()=>o.reduce((s,c)=>s+(c.price||0)*(c.qty||1),0),[o]),E=a.useMemo(()=>I+f,[I,f]),D=a.useMemo(()=>!o||o.length===0?"â€”":new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(f),[o,f]),b=a.useRef(null),k=()=>{b.current?.click()},A=s=>{const c=s.target.files;c&&c.length&&typeof u=="function"&&u(c),s.target&&(s.target.value="")},w=s=>{typeof C=="function"&&C(s)};return e.jsxs("section",{className:"bg-white rounded-xl p-4 sm:p-6 sticky top-24",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Carrello"}),e.jsxs("div",{className:"divide-y divide-gray-100 border border-gray-100 rounded-xl overflow-hidden",children:[o.length===0&&e.jsx("div",{className:"p-4 text-sm text-gray-500 text-center",children:"Il carrello Ã¨ vuoto"}),o.map(s=>e.jsxs("div",{className:"flex flex-col gap-2 p-3 sm:flex-row sm:items-center",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx("img",{src:s.image,alt:s.title,className:"w-12 h-12 object-contain rounded"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900 line-clamp-1",children:s.title}),e.jsx("div",{className:"text-xs text-gray-500",children:new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(s.price)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>x(s.id),className:"h-8 w-8 inline-flex items-center justify-center rounded-md border border-gray-200 text-gray-700 hover:bg-gray-50",children:"-"}),e.jsx("span",{className:"w-6 text-center text-sm font-semibold",children:s.qty}),e.jsx("button",{onClick:()=>v(s.id),className:"h-8 w-8 inline-flex items-center justify-center rounded-md border border-gray-200 text-gray-700 hover:bg-gray-50",children:"+"})]}),e.jsx("button",{onClick:()=>h(s.id),className:"ml-2 text-red-600 text-sm hover:underline",children:"Rimuovi"})]}),Number(s.idOfferta)===446&&e.jsxs("div",{className:"pl-15 sm:pl-16",children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"Codice speciale (cim-flora-kim-dXXX)"}),e.jsx("input",{type:"text",value:s.customCode||"",onChange:c=>{const M=new CustomEvent("agentcart:updateItem",{detail:{id:s.id,patch:{customCode:c.target.value}}});window.dispatchEvent(M)},placeholder:"cim-flora-kim-d123",className:"w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm"})]})]},`${s.id}`))]}),e.jsxs("div",{className:"mt-5",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Metodo di trasporto"}),e.jsxs("div",{className:"grid grid-cols-1 gap-2",children:[e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer ${g==="Invio da Sede"?"border-blue-500 bg-blue-50":"border-gray-200 hover:bg-gray-50"}`,children:[e.jsx("span",{className:"flex items-center gap-2 text-sm text-gray-800",children:"Invio da Sede"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-gray-600",children:D}),e.jsx("input",{type:"radio",name:"transport",value:"Invio da Sede",checked:g==="Invio da Sede",onChange:()=>j("Invio da Sede")})]})]}),e.jsxs("label",{className:`flex items-center justify-between p-3 border rounded-lg cursor-pointer ${g==="Consegna a Mano"?"border-blue-500 bg-blue-50":"border-gray-200 hover:bg-gray-50"}`,children:[e.jsx("span",{className:"flex items-center gap-2 text-sm text-gray-800",children:"Consegna a Mano"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-sm text-gray-600",children:new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(0)}),e.jsx("input",{type:"radio",name:"transport",value:"Consegna a Mano",checked:g==="Consegna a Mano",onChange:()=>j("Consegna a Mano")})]})]})]})]}),e.jsxs("div",{className:"mt-5",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900 mb-2",children:"Note per l'ordine"}),e.jsx("textarea",{value:d,onChange:s=>p(s.target.value),rows:3,placeholder:"Aggiungi eventuali indicazioni per la spedizione o la fatturazione...",className:"w-full rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm"})]}),e.jsxs("div",{className:"mt-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-900",children:"Foto consegna"}),e.jsx("button",{type:"button",onClick:k,className:"inline-flex items-center gap-2 rounded-lg border border-blue-200 bg-blue-50 px-3 py-1.5 text-xs font-semibold text-blue-700 hover:bg-blue-100",children:"ðŸ“· Allega foto"})]}),e.jsx("input",{ref:b,type:"file",accept:"image/*",capture:"environment",multiple:!0,className:"hidden",onChange:A}),S.length===0?e.jsx("p",{className:"text-xs text-gray-500",children:"Nessuna foto allegata. Puoi caricare immagini da galleria o scattarle ora."}):e.jsx("div",{className:"flex flex-wrap gap-3",children:S.map(s=>e.jsxs("div",{className:"relative h-20 w-20 overflow-hidden rounded-lg border border-gray-200",children:[e.jsx("img",{src:s.preview,alt:s.file?.name||"Foto consegna",className:"h-full w-full object-cover"}),e.jsx("button",{type:"button",onClick:()=>w(s.id),className:"absolute top-1 right-1 rounded-full bg-white/80 px-1 text-[10px] text-red-600 shadow","aria-label":"Rimuovi foto",children:"âœ•"})]},s.id))})]}),e.jsxs("div",{className:"mt-5 border-t pt-4 space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotale"}),e.jsx("span",{className:"font-medium",children:new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(I)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Spedizione"}),e.jsx("span",{className:"font-medium",children:D})]}),e.jsxs("div",{className:"flex justify-between text-base pt-2",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:"Totale"}),e.jsx("span",{className:"font-bold text-gray-900",children:new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR"}).format(E)})]})]}),e.jsx("button",{type:"button",onClick:N,disabled:o.length===0,className:"mt-5 w-full inline-flex items-center justify-center rounded-lg bg-blue-600 px-4 py-3 text-white text-sm font-semibold shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition disabled:opacity-50 disabled:cursor-not-allowed",children:"INSERISCI ORDINE"})]})}function ae(){const{user:o}=H(),[v,x]=a.useState([]),[h,g]=a.useState("Invio da Sede"),[j,d]=a.useState(""),p=a.useRef(null),[N,S]=a.useState(""),[u,C]=a.useState([]),{data:f=[],loading:I,error:E,refetch:D}=K("SIM"),{dealers:b}=V(),[k,A]=a.useState(""),w=a.useMemo(()=>`selectedDealerId:${(o?.id||o?.email||o?.agentenome||o?.name||"unknown").toString()}`,[o?.id,o?.email,o?.agentenome,o?.name]);a.useEffect(()=>{try{const t=localStorage.getItem(w);t&&A(t)}catch{}},[w]),a.useEffect(()=>{if(!Array.isArray(b))return;if(!k){if(b.length===1){const r=String(b[0].id);A(r);try{localStorage.setItem(w,r)}catch{}}return}if(!b.some(r=>String(r.id)===String(k))){A("");try{localStorage.removeItem(w)}catch{}}},[b,k,w]);const s=t=>{A(t);try{localStorage.setItem(w,String(t||""))}catch{}};a.useEffect(()=>{const t=r=>{const{id:n,patch:m}=r.detail||{};!n||!m||x(i=>i.map(l=>l.id===n?{...l,...m}:l))};return window.addEventListener("agentcart:updateItem",t),()=>window.removeEventListener("agentcart:updateItem",t)},[]);const c=N.trim().toLowerCase(),M=a.useMemo(()=>{const t=Array.isArray(f)?f:[];return c?t.filter(r=>(r.title||"").toLowerCase().includes(c)||(r.id||"").toLowerCase().includes(c)):t},[f,c]),P=t=>{const r={id:t.id,idOfferta:Number(t.idOfferta||0),title:t.title,price:t.price,priceCents:t.priceCents,image:t.image,speseSpedizione:Number(t.speseSpedizione??0)};x(n=>{const m=n.findIndex(i=>i.id===t.id);if(m!==-1){const i=[...n];return i[m]={...i[m],qty:(i[m].qty||1)+1},i}return[...n,{...r,qty:1}]}),typeof window<"u"&&!window.matchMedia("(min-width: 1280px)").matches&&setTimeout(()=>{p.current?.scrollIntoView({behavior:"smooth",block:"start"})},0)},F=t=>x(r=>r.map(n=>n.id===t?{...n,qty:(n.qty||1)+1}:n)),q=t=>x(r=>r.map(n=>n.id===t?{...n,qty:Math.max(1,(n.qty||1)-1)}:n)),$=t=>x(r=>r.filter(n=>n.id!==t)),U=10,L=a.useCallback(t=>{const r=typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():`${Date.now()}-${Math.random()}`,n=URL.createObjectURL(t);return{id:r,file:t,preview:n}},[]),T=a.useCallback(t=>{if(!t||t.length===0)return;const r=Array.from(t),n=10*1024*1024,m=r.filter(i=>i.size>n);if(m.length>0){const i=m.map(y=>y.name).join(", "),l=(m[0].size/(1024*1024)).toFixed(2);alert(`Le seguenti foto superano il limite di 10MB:
${i}

Dimensione: ${l}MB

Riduci la dimensione o comprimi le immagini prima di caricarle.`);return}C(i=>{const l=Math.max(0,U-i.length);if(l<=0)return alert(`Puoi caricare massimo ${U} foto per ordine.`),i;const y=r.slice(0,l).map(L);return[...i,...y]})},[L]),X=a.useCallback(t=>{C(r=>{const n=r.filter(i=>i.id!==t),m=r.find(i=>i.id===t);return m&&URL.revokeObjectURL(m.preview),n})},[]);a.useEffect(()=>()=>{u.forEach(t=>URL.revokeObjectURL(t.preview))},[u]);const B=async()=>{const t=k;if(!t){alert("Seleziona un dealer prima di procedere.");return}const r=Array.isArray(b)?b.find(l=>String(l.id)===String(t)):null;if(!r){alert("Dealer selezionato non valido o non piÃ¹ disponibile. Selezionalo di nuovo.");return}const n=`Confermi l'invio ordine per il dealer:

${r.ragioneSociale} (ID ${r.id})`;if(!window.confirm(n)||v.length===0)return;for(const l of v)if(Number(l.idOfferta)===446){const y=(l.customCode||"").toString().trim();if(!/^cim-flora-kim-d\d{1,3}$/.test(y)){alert("Per il prodotto speciale (ID 446) Ã¨ necessario un codice valido nel formato cim-flora-kim-dXXX");return}}const m=v.map(l=>({idOfferta:Number(l.idOfferta),prezzo:Number(l.priceCents||0),quantita:Number(l.qty||1),customCode:l.customCode||void 0})),i={idDealer:Number(t),trasporto:h,carrello:m,noteOrdine:j||"",idAgente:void 0};try{const l=u.length>0;let y;if(l){const R=new FormData;R.append("order",JSON.stringify(i)),u.forEach(z=>{const _=z.file?.name||`foto-${z.id}.jpg`;R.append("photos",z.file,_)}),y=await O.post("/api/agente/ordine",R,{headers:{"Content-Type":"multipart/form-data"}})}else y=await O.post("/api/agente/ordine",i);if(y?.data?.success){alert("Ordine inviato con successo"),x([]),d(""),u.forEach(R=>URL.revokeObjectURL(R.preview)),C([]),A("");try{localStorage.removeItem(w)}catch{}}else alert("Ordine non riuscito")}catch(l){const y=l?.normalized?.message||"Errore durante l'invio dell'ordine";alert(y)}};return e.jsx(Q,{title:"Prodotti",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(Z,{dealers:b,selectedId:k,onChange:s}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-3 gap-6 mb-0",children:[e.jsx("div",{className:"xl:col-span-2 space-y-6",children:e.jsxs("section",{className:"bg-white rounded-xl p-4 sm:p-6 h-[calc(100vh-140px)] flex flex-col mt-2",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:"Catalogo Prodotti"}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("input",{type:"text",placeholder:"Cerca prodotto...",className:"w-48 sm:w-64 rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm",value:N,onChange:t=>S(t.target.value)})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto pr-1 sm:pr-2",children:e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6",children:[I&&[...Array(6)].map((t,r)=>e.jsx("div",{className:"h-40 bg-gray-100 rounded-2xl animate-pulse"},`sk-${r}`)),E&&e.jsxs("div",{className:"col-span-full text-sm text-red-600 flex items-center justify-between",children:[e.jsx("span",{children:"Errore nel caricamento prodotti."}),e.jsx("button",{onClick:D,className:"ml-3 px-3 py-1.5 rounded bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Riprova"})]}),!I&&!E&&M.map(t=>e.jsx(J,{image:t.image,title:t.title.toUpperCase(),price:t.price,onSelect:()=>P(t)},t.id)),!I&&!E&&M.length===0&&e.jsx("div",{className:"col-span-full text-sm text-gray-500",children:"Nessun prodotto trovato"})]})})]})}),e.jsx("div",{className:"space-y-6 mt-2 scroll-mt-24",ref:p,children:e.jsx(G,{items:v,onIncrease:F,onDecrease:q,onRemove:$,transportMethod:h,setTransportMethod:g,notes:j,setNotes:d,onCheckout:B,photos:u,onAddPhotos:T,onRemovePhoto:X})})]})]})})}export{ae as default};
