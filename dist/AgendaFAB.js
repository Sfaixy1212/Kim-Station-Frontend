import{r as o,j as e,a6 as I,C as k,X as K,a7 as L,a8 as U,a9 as Q,e as Y,aa as X}from"./vendor.js";import{g as M,p as Z}from"./index.js";function H({value:j,onChange:b,onPlaceSelected:v,placeholder:N="Cerca indirizzo...",className:w=""}){const d=o.useRef(null),h=o.useRef(null),[p,y]=o.useState(!1);return o.useEffect(()=>{if(window.google&&window.google.maps&&window.google.maps.places){y(!0);return}const r=document.createElement("script");return r.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA45k46jK9KokncxdY3hEpzZ7gMKBf7E74&libraries=places&language=it&region=IT",r.async=!0,r.defer=!0,r.onload=()=>y(!0),r.onerror=()=>{console.error("[GooglePlaces] Errore caricamento Google Maps API")},document.head.appendChild(r),()=>{}},[]),o.useEffect(()=>{if(!(!p||!d.current)){try{h.current=new window.google.maps.places.Autocomplete(d.current,{types:["address"],componentRestrictions:{country:"it"},fields:["address_components","formatted_address","geometry","name"]}),h.current.addListener("place_changed",()=>{const r=h.current.getPlace();if(!r.geometry){console.warn("[GooglePlaces] Nessun dettaglio disponibile per:",r.name);return}const P=r.address_components||[],a={formattedAddress:r.formatted_address||"",street:"",streetNumber:"",city:"",province:"",postalCode:"",country:"",lat:r.geometry.location.lat(),lng:r.geometry.location.lng()};P.forEach(u=>{const m=u.types;m.includes("route")&&(a.street=u.long_name),m.includes("street_number")&&(a.streetNumber=u.long_name),m.includes("locality")&&(a.city=u.long_name),m.includes("administrative_area_level_2")&&(a.province=u.short_name),m.includes("postal_code")&&(a.postalCode=u.long_name),m.includes("country")&&(a.country=u.long_name)});const C=[a.street,a.streetNumber].filter(Boolean).join(", ");console.log("[GooglePlaces] Place selezionato:",a),v&&v({indirizzoCompleto:C||a.formattedAddress,cap:a.postalCode,citta:a.city,provincia:a.province,latitudine:a.lat,longitudine:a.lng,formattedAddress:a.formattedAddress}),b&&b(C||a.formattedAddress)})}catch(r){console.error("[GooglePlaces] Errore inizializzazione:",r)}return()=>{h.current&&window.google.maps.event.clearInstanceListeners(h.current)}}},[p,v,b]),e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-gray-400",children:e.jsx(I,{className:"w-4 h-4"})}),e.jsx("input",{ref:d,type:"text",value:j,onChange:r=>b&&b(r.target.value),placeholder:N,className:`w-full border border-gray-300 rounded-lg pl-10 pr-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent ${w}`,disabled:!p}),!p&&e.jsx("div",{className:"absolute right-3 top-1/2 -translate-y-1/2",children:e.jsx("div",{className:"animate-spin h-4 w-4 border-2 border-blue-500 border-t-transparent rounded-full"})})]})}function ee({onVisitaCreated:j}){const[b,v]=o.useState(!1),[N,w]=o.useState(!1),[d,h]=o.useState([]),[p,y]=o.useState([]),[r,P]=o.useState(""),[a,C]=o.useState([]),[u,m]=o.useState(!1),[z,V]=o.useState(!1),[c,R]=o.useState(!1),[s,x]=o.useState({idDealer:"",ragioneSocialeDealer:"",dataVisita:new Date().toISOString().split("T")[0],oraInizio:new Date().toTimeString().slice(0,5),durataMinuti:60,referente:"",argomento:"",note:"",statoVisita:"COMPLETATA"}),[i,f]=o.useState({ragioneSociale:"",indirizzoCompleto:"",cap:"",citta:"",provincia:"",latitudine:null,longitudine:null,note:""});o.useEffect(()=>{T(),E()},[]),o.useEffect(()=>{if(r.trim()==="")y(d);else{const t=r.toLowerCase();y(d.filter(n=>n.RagioneSociale?.toLowerCase().includes(t)||n.Citta?.toLowerCase().includes(t)||n.Provincia?.toLowerCase().includes(t)))}},[r,d]);const T=async()=>{V(!0);try{console.log("[AgendaFAB] Caricamento dealer...");const t=await M("/agente/miei-dealer");console.log("[AgendaFAB] Response:",t);const n=t?.dealers||[];console.log("[AgendaFAB] Dealer ricevuti:",n);const g=n.map(l=>({IDDealer:l.id,RagioneSociale:l.ragioneSociale,Citta:l.citta||"",Provincia:l.provincia||"",Indirizzo:l.indirizzo||""}));h(g),y(g)}catch(t){console.error("[AgendaFAB] Errore caricamento dealer:",t)}finally{V(!1)}},E=async()=>{try{const t=new Date,g=(await M(`/agente/agenda/visite?month=${t.getMonth()+1}&year=${t.getFullYear()}`)).filter(l=>l.DataVisita===new Date().toISOString().split("T")[0]);C(g||[])}catch(t){console.error("Errore caricamento visite:",t)}},O=()=>{v(!0),setTimeout(()=>w(!0),10)},S=()=>{w(!1),setTimeout(()=>v(!1),300)},_=t=>{const n=t.target.value,g=d.find(l=>l.IDDealer===parseInt(n));x({...s,idDealer:n,ragioneSocialeDealer:g?.RagioneSociale||""})},F=async t=>{if(t.preventDefault(),c){if(!i.ragioneSociale||!i.citta||!i.provincia){alert("âš ï¸ Compila almeno: Ragione Sociale, CittÃ  e Provincia");return}}else if(!s.idDealer){alert("âš ï¸ Seleziona un point affiliato");return}m(!0);try{let n=c?i.latitudine:null,g=c?i.longitudine:null,l=null,A=null;if(navigator.geolocation)try{const D=await new Promise((B,$)=>{navigator.geolocation.getCurrentPosition(B,$,{timeout:5e3})});l=D.coords.latitude,A=D.coords.longitude}catch(D){console.warn("Geolocalizzazione non disponibile:",D)}c&&(!n||!g)&&l&&A&&(n=l,g=A);const G={...s,isNuovoPoint:c,nuovoPoint:c?i:null,latitudine:n,longitudine:g,latitudineDispositivo:l,longitudineDispositivo:A,statoVisita:s.statoVisita};await Z("/agente/agenda/visite",G),x({idDealer:"",ragioneSocialeDealer:"",dataVisita:new Date().toISOString().split("T")[0],oraInizio:new Date().toTimeString().slice(0,5),durataMinuti:60,referente:"",argomento:"",note:"",statoVisita:"COMPLETATA"}),f({ragioneSociale:"",indirizzoCompleto:"",cap:"",citta:"",provincia:"",latitudine:null,longitudine:null,note:""}),R(!1),E(),j&&j({dataVisita:s.dataVisita,statoVisita:s.statoVisita});const q=s.statoVisita==="PROGRAMMATA"?"âœ… Appuntamento programmato con successo!":"âœ… Visita registrata con successo!";alert(q),S()}catch(n){console.error("Errore salvataggio visita:",n),alert("âŒ Errore nel salvataggio della visita")}finally{m(!1)}};return e.jsxs(e.Fragment,{children:[e.jsxs("button",{onClick:O,className:"fixed bottom-24 right-6 z-40 w-14 h-14 bg-gradient-to-br from-blue-600 to-blue-700 hover:from-blue-700 hover:to-blue-800 text-white rounded-full shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center group",title:"Registra Visita",children:[e.jsx(k,{className:"w-6 h-6"}),a.length>0&&e.jsx("span",{className:"absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white text-xs rounded-full flex items-center justify-center",children:a.length})]}),b&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`fixed inset-0 bg-black/30 z-40 transition-opacity duration-300 ${N?"opacity-100":"opacity-0"}`,onClick:S}),e.jsxs("div",{className:`fixed top-0 right-0 h-full w-full max-w-md bg-white shadow-2xl z-50 flex flex-col transition-transform duration-300 ${N?"translate-x-0":"translate-x-full"}`,children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex items-center justify-between bg-gradient-to-r from-blue-600 to-blue-700 text-white",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(k,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold",children:"Agenda Visite"}),e.jsx("p",{className:"text-sm text-blue-100",children:"Registra o programma una visita"})]})]}),e.jsx("button",{onClick:S,className:"p-2 rounded-lg hover:bg-white/10 transition-colors",children:e.jsx(K,{className:"w-5 h-5"})})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6",children:[a.length>0&&e.jsxs("div",{className:"mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(k,{className:"w-4 h-4 text-blue-600"}),e.jsxs("span",{className:"text-sm font-semibold text-blue-900",children:[a.length," ",a.length===1?"visita":"visite"," oggi"]})]}),e.jsx("div",{className:"space-y-2",children:a.slice(0,3).map(t=>e.jsxs("div",{className:"text-xs text-blue-700",children:["â€¢ ",t.RagioneSocialeDealer," - ",t.OraInizio?.slice(0,5)]},t.ID))}),e.jsx("a",{href:"/agente/agenda",className:"text-xs text-blue-600 hover:text-blue-700 font-medium mt-2 inline-block",children:"Vedi tutte â†’"})]}),e.jsxs("form",{onSubmit:F,className:"space-y-4",children:[e.jsxs("div",{className:"bg-gray-50 border border-gray-200 rounded-lg p-3",children:[e.jsx("div",{className:"flex items-center justify-between mb-2",children:e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Tipo Point"})}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{type:"button",onClick:()=>R(!1),className:`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${c?"bg-white text-gray-700 border border-gray-300 hover:bg-gray-50":"bg-blue-600 text-white"}`,children:[e.jsx(I,{className:"w-4 h-4 inline mr-1"}),"Point Affiliato"]}),e.jsxs("button",{type:"button",onClick:()=>R(!0),className:`flex-1 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${c?"bg-green-600 text-white":"bg-white text-gray-700 border border-gray-300 hover:bg-gray-50"}`,children:[e.jsx(L,{className:"w-4 h-4 inline mr-1"}),"Nuovo Point"]})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:c?"ðŸ†• Stai visitando un point non ancora affiliato":"âœ… Seleziona dalla tua scuderia"})]}),!c&&e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[e.jsx(I,{className:"w-4 h-4 inline mr-1"}),"Point Affiliato *"]}),e.jsx("input",{type:"text",value:r,onChange:t=>P(t.target.value),placeholder:"Cerca per nome, cittÃ  o provincia...",className:"w-full border border-gray-300 rounded-lg px-3 py-2 mb-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"}),e.jsxs("select",{required:!0,value:s.idDealer,onChange:_,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent",disabled:z,children:[e.jsx("option",{value:"",children:z?"Caricamento...":`Seleziona un point... (${p.length} disponibili)`}),p.map(t=>e.jsxs("option",{value:t.IDDealer,children:[t.RagioneSociale," - ",t.Citta," (",t.Provincia,")"]},t.IDDealer))]}),p.length===0&&!z&&d.length>0&&e.jsxs("p",{className:"text-xs text-gray-500 mt-1",children:['Nessun dealer trovato con "',r,'"']}),d.length===0&&!z&&e.jsx("p",{className:"text-xs text-red-500 mt-1",children:"âš ï¸ Nessun dealer disponibile nella tua scuderia"})]}),c&&e.jsxs("div",{className:"space-y-3 bg-green-50 border border-green-200 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(L,{className:"w-5 h-5 text-green-600"}),e.jsx("h3",{className:"font-semibold text-green-900",children:"Dati Nuovo Point"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ragione Sociale *"}),e.jsx("input",{type:"text",required:!0,value:i.ragioneSociale,onChange:t=>f({...i,ragioneSociale:t.target.value}),placeholder:"Es: Bar Centrale di Rossi Mario",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Indirizzo Completo"}),e.jsx(H,{value:i.indirizzoCompleto,onChange:t=>f({...i,indirizzoCompleto:t}),onPlaceSelected:t=>{f({...i,indirizzoCompleto:t.indirizzoCompleto,cap:t.cap,citta:t.citta,provincia:t.provincia,latitudine:t.latitudine,longitudine:t.longitudine})},placeholder:"Cerca indirizzo su Google Maps..."}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"ðŸ’¡ Usa l'autocomplete per compilare automaticamente CAP, CittÃ  e Provincia"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"CAP"}),e.jsx("input",{type:"text",value:i.cap,onChange:t=>f({...i,cap:t.target.value}),placeholder:"00100",maxLength:5,className:"w-full border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-green-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"CittÃ  *"}),e.jsx("input",{type:"text",required:!0,value:i.citta,onChange:t=>f({...i,citta:t.target.value}),placeholder:"Roma",className:"w-full border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-green-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs font-medium text-gray-700 mb-1",children:"PR *"}),e.jsx("input",{type:"text",required:!0,value:i.provincia,onChange:t=>f({...i,provincia:t.target.value.toUpperCase()}),placeholder:"RM",maxLength:2,className:"w-full border border-gray-300 rounded-lg px-2 py-1.5 text-sm focus:ring-2 focus:ring-green-500 uppercase"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Note / Feedback Point"}),e.jsx("textarea",{value:i.note,onChange:t=>f({...i,note:t.target.value}),placeholder:"Es: Interessato a partnership, contattare tra 2 settimane...",rows:2,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-green-500 focus:border-transparent resize-none text-sm"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo Visita *"}),e.jsxs("select",{required:!0,value:s.statoVisita,onChange:t=>x({...s,statoVisita:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"COMPLETATA",children:"âœ… Visita giÃ  effettuata"}),e.jsx("option",{value:"PROGRAMMATA",children:"ðŸ“… Appuntamento da fare"})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:s.statoVisita==="PROGRAMMATA"?"Stai programmando un appuntamento futuro":"Stai registrando una visita giÃ  completata"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Data *"}),e.jsx("input",{type:"date",required:!0,value:s.dataVisita,onChange:t=>x({...s,dataVisita:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[e.jsx(U,{className:"w-4 h-4 inline mr-1"}),"Ora *"]}),e.jsx("input",{type:"time",required:!0,value:s.oraInizio,onChange:t=>x({...s,oraInizio:t.target.value}),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Durata *"}),e.jsxs("select",{required:!0,value:s.durataMinuti,onChange:t=>x({...s,durataMinuti:parseInt(t.target.value)}),className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:15,children:"15 minuti"}),e.jsx("option",{value:30,children:"30 minuti"}),e.jsx("option",{value:45,children:"45 minuti"}),e.jsx("option",{value:60,children:"1 ora"}),e.jsx("option",{value:90,children:"1 ora e 30 min"}),e.jsx("option",{value:120,children:"2 ore"}),e.jsx("option",{value:180,children:"3 ore"}),e.jsx("option",{value:240,children:"4 ore+"})]})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[e.jsx(Q,{className:"w-4 h-4 inline mr-1"}),"Referente"]}),e.jsx("input",{type:"text",value:s.referente,onChange:t=>x({...s,referente:t.target.value}),placeholder:"Nome del referente...",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:[e.jsx(Y,{className:"w-4 h-4 inline mr-1"}),"Argomento"]}),e.jsx("input",{type:"text",value:s.argomento,onChange:t=>x({...s,argomento:t.target.value}),placeholder:"Es: Formazione prodotti, Supporto tecnico...",className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Note"}),e.jsx("textarea",{value:s.note,onChange:t=>x({...s,note:t.target.value}),placeholder:"Note aggiuntive...",rows:3,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"})]}),e.jsxs("div",{className:"flex items-center space-x-3 pt-4",children:[e.jsx("button",{type:"button",onClick:S,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors",children:"Annulla"}),e.jsx("button",{type:"submit",disabled:u,className:"flex-1 px-4 py-2 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-colors disabled:opacity-50 flex items-center justify-center space-x-2",children:u?e.jsx("span",{children:"Salvataggio..."}):e.jsxs(e.Fragment,{children:[e.jsx(X,{className:"w-4 h-4"}),e.jsx("span",{children:"Registra"})]})})]})]})]})]})]})]})}export{ee as A};
