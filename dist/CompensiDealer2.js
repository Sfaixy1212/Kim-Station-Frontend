import{r as l,j as e,C as I,U as j,S as f,e as L,E as N,T as A}from"./vendor.js";import{u as R}from"./index.js";import{D as T}from"./DashboardLayout.js";import"./logo2.js";function U(){const{user:k}=R(),[o,y]=l.useState(()=>{const s=new Date;return`${s.getFullYear()}-${String(s.getMonth()+1).padStart(2,"0")}`}),[t,g]=l.useState(null),[c,p]=l.useState(""),[v,w]=l.useState([]),[u,m]=l.useState(!1),[i,S]=l.useState(null),[d,x]=l.useState(!1),[h,n]=l.useState("");l.useEffect(()=>{(async()=>{try{const r=await fetch("/api/supermaster/compensi-dealer/dealers",{headers:{Authorization:`Bearer ${localStorage.getItem("token")}`}});if(r.ok){const a=await r.json();w(a.dealers||[])}}catch(r){console.error("Errore caricamento dealer:",r)}})()},[]);const b=v.filter(s=>s.ragioneSociale?.toLowerCase().includes(c.toLowerCase())||s.agente?.toLowerCase().includes(c.toLowerCase())||s.citta?.toLowerCase().includes(c.toLowerCase())||s.provincia?.toLowerCase().includes(c.toLowerCase())),D=s=>{g(s),p(s.ragioneSociale),m(!1)},C=async()=>{if(!t){n("Seleziona un dealer");return}x(!0),n("");try{const s=`${o}-01`,r=await fetch("/api/supermaster/compensi-dealer",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({monthStart:s,dealerId:t.idDealer})});if(r.ok){const a=await r.json();console.log("[COMPENSI DEALER] Risposta API:",a),S(a)}else{const a=await r.json();console.error("[COMPENSI DEALER] Errore API:",a),n(a.message||"Errore nel caricamento dei compensi")}}catch(s){n("Errore di connessione"),console.error("Errore ricerca compensi:",s)}finally{x(!1)}},E=async()=>{if(!(!i||!t))try{x(!0);const s={dealer:{ragioneSociale:t.ragioneSociale,indirizzo:t.indirizzo||"",cap:t.cap||"",citta:t.citta||"",provincia:t.provincia||"",piva:t.piva||"",agente:t.agente||""},intestatario:{ragioneSociale:"KIM srls",indirizzo:"Via Appia, 322/324",cap:"72100",citta:"Brindisi",provincia:"BR",piva:"02567150749",codiceFiscale:"02567150749",codiceDestinatario:"M5UXCR1"},compensi:{mese:new Date(o+"-01").toLocaleDateString("it-IT",{month:"long",year:"numeric"}),totaleCompensi:i.totaleCompensi,totaleAttivazioni:i.totaleAttivazioni,segmenti:i.segmenti||[],dettagli:i.dettagli||[]},dataGenerazione:new Date().toLocaleDateString("it-IT"),numeroProgressivo:`INV-${t.idDealer}-${o.replace("-","")}`},r=await fetch("/api/supermaster/compensi-dealer/genera-invito",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify(s)});if(r.ok){const a=await r.json();a.success&&a.downloadUrl?(window.open(a.downloadUrl,"_blank"),console.log("Invito a fatturare generato:",a.filename)):n(a.message||"Errore nella generazione dell'invito")}else{const a=await r.json();n(a.message||"Errore nella generazione dell'invito")}}catch(s){n("Errore di connessione durante la generazione dell'invito"),console.error("Errore generazione invito:",s),x(!1)}};return e.jsx(T,{children:e.jsx("div",{className:"space-y-6 p-4 sm:p-6 lg:p-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"Compensi Dealer"}),e.jsx("p",{className:"text-gray-600",children:"Calcola e visualizza i compensi per dealer specifico"})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(I,{className:"inline w-4 h-4 mr-1"}),"Mese"]}),e.jsx("input",{type:"month",value:o,onChange:s=>y(s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:[e.jsx(j,{className:"inline w-4 h-4 mr-1"}),"Dealer"]}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{type:"text",value:c,onChange:s=>{p(s.target.value),m(!0),s.target.value||g(null)},onFocus:()=>m(!0),placeholder:"Cerca dealer...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"}),e.jsx(f,{className:"absolute right-3 top-2.5 w-4 h-4 text-gray-400"}),u&&b.length>0&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-auto",children:b.slice(0,10).map(s=>e.jsxs("div",{onClick:()=>D(s),className:"px-3 py-2 hover:bg-gray-100 cursor-pointer border-b border-gray-100 last:border-b-0",children:[e.jsx("div",{className:"font-medium text-gray-900",children:s.ragioneSociale}),e.jsxs("div",{className:"text-sm text-gray-500 flex items-center justify-between",children:[e.jsxs("span",{children:["Agente: ",s.agente||"N/A"]}),e.jsxs("span",{children:[s.citta," (",s.provincia,")"]})]}),e.jsxs("div",{className:"text-xs text-gray-400",children:["ID: ",s.idDealer]})]},s.idDealer))})]})]}),e.jsx("div",{className:"flex items-end",children:e.jsx("button",{onClick:C,disabled:d||!t,className:"w-full px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Caricamento..."]}):e.jsxs(e.Fragment,{children:[e.jsx(f,{className:"w-4 h-4"}),"Cerca"]})})})]}),h&&e.jsx("div",{className:"mt-4 p-3 bg-red-50 border border-red-200 rounded-md",children:e.jsx("p",{className:"text-red-600 text-sm",children:h})})]}),i&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsxs("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:["Riepilogo Compensi Dealer: ",t?.ragioneSociale]}),e.jsxs("p",{className:"text-gray-600",children:["Mese: ",new Date(o+"-01").toLocaleDateString("it-IT",{month:"long",year:"numeric"})]})]}),e.jsxs("button",{onClick:E,disabled:d,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center gap-2",children:[e.jsx(L,{className:"w-4 h-4"}),d?"Generando...":"GENERA INVITO"]})]}),e.jsx("div",{className:"bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-6 rounded-lg mb-6",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(N,{className:"w-8 h-8 text-blue-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-blue-900 mb-1",children:"Compenso Totale"}),e.jsx("p",{className:"text-4xl font-bold text-blue-900",children:i.totaleCompensi?.toLocaleString("it-IT",{style:"currency",currency:"EUR",minimumFractionDigits:2})||"â‚¬0,00"})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-green-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(A,{className:"w-5 h-5 text-green-600"}),e.jsx("span",{className:"text-sm font-medium text-green-900",children:"Totale Attivazioni"})]}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:i.totaleAttivazioni||0})]}),e.jsxs("div",{className:"bg-purple-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(j,{className:"w-5 h-5 text-purple-600"}),e.jsx("span",{className:"text-sm font-medium text-purple-900",children:"Agente di Riferimento"})]}),e.jsx("p",{className:"text-lg font-semibold text-purple-900",children:t?.agente||"N/A"})]})]})]}),i.dettagli&&i.dettagli.length>0&&e.jsx("div",{className:"space-y-6",children:i.segmenti?.map((s,r)=>e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden",children:[e.jsx("div",{className:"px-6 py-4 bg-gray-50 border-b border-gray-200",children:e.jsxs("h3",{className:"text-xl font-bold text-gray-900 flex items-center gap-2",children:[s.nome==="RES"&&e.jsx("span",{children:"ðŸ“ˆ"}),s.nome==="SHP"&&e.jsx("span",{children:"ðŸ¢"}),s.nome==="RES"?"Segmento Residenziale (RES)":"Segmento Business (SHP)"]})}),e.jsx("div",{className:"p-6 space-y-6",children:s.categorie?.map((a,z)=>e.jsxs("div",{className:"border-l-4 border-gray-200 pl-4",children:[e.jsxs("h4",{className:"text-lg font-semibold text-gray-800 mb-3",children:[a.nome==="FISSO"?"Prodotti Fissi":a.bucket==="FLEX"?"ENERGIA":"Prodotti Mobile"," - ",a.bucket]}),e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Dettaglio Calcolo:"}),e.jsx("span",{className:"text-lg font-bold text-gray-900",children:a.euroCalcolati?.toLocaleString("it-IT",{style:"currency",currency:"EUR",minimumFractionDigits:2})})]}),e.jsxs("p",{className:"text-gray-800 mb-2",children:[e.jsx("span",{className:"font-semibold",children:a.qty})," attivazioni Ã—",e.jsxs("span",{className:"font-semibold",children:[" ",a.importoPerPezzo?.toLocaleString("it-IT",{style:"currency",currency:"EUR",minimumFractionDigits:2})]}),"/cad. =",e.jsxs("span",{className:"font-bold text-blue-600",children:[" ",a.euroCalcolati?.toLocaleString("it-IT",{style:"currency",currency:"EUR",minimumFractionDigits:2})]})]}),a.note&&e.jsxs("p",{className:"text-sm italic text-gray-600",children:["Regola applicata: ",a.note]})]})]},z))})]},r))})]}),!i&&!d&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm border border-gray-200 p-12 text-center",children:[e.jsx(N,{className:"w-16 h-16 text-gray-300 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Nessun dato disponibile"}),e.jsx("p",{className:"text-gray-500",children:"Seleziona un dealer e un mese per visualizzare i compensi"})]}),u&&e.jsx("div",{className:"fixed inset-0 z-5",onClick:()=>m(!1)})]})})})}export{U as default};
