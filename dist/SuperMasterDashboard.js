import{O as ne,u as J,r as m,j as e,i as ee,v as oe,l as te,m as se,Y as ae,o as re,t as le,k as ce,q as de,Q as me}from"./vendor.js";import{u as ue,j as ge,g as z}from"./index.js";import pe from"./Incentivi.js";import{A as xe}from"./Analisi.js";import he from"./Strumenti.js";import{S as fe}from"./StatsCard.js";import{C as G}from"./Card.js";import{S as be}from"./Topbar2.js";import"./DashboardLayout.js";import"./logo2.js";function ye(){const[p,N]=m.useState([]),[h,y]=m.useState(!0),[u,f]=m.useState(null),[o,g]=m.useState({recordsets:[],loading:!1,error:""});m.useEffect(()=>{let i=!0;return(async()=>{try{y(!0);const l=await z("/supermaster/reports");if(!i)return;N(Array.isArray(l?.rows)?l.rows:[])}finally{i&&y(!1)}})(),()=>{i=!1}},[]);const x=async i=>{f(i),g({recordsets:[],loading:!0,error:""});try{const l=await z(`/supermaster/reports/${i}`),A=Array.isArray(l?.recordsets)?l.recordsets:[];g({recordsets:A,loading:!1,error:""})}catch{g({recordsets:[],loading:!1,error:"Errore nel caricamento report"})}},b=i=>{const l=Array.isArray(i)?i:[];if(l.length===0)return e.jsx("div",{className:"text-sm text-gray-500",children:"Nessun dato"});const A=Object.keys(l[0]||{});return e.jsx("div",{className:"overflow-auto border border-gray-200 rounded",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsx("tr",{children:A.map(c=>e.jsx("th",{className:"px-3 py-2 text-left text-gray-600 border-b",children:c},c))})}),e.jsx("tbody",{children:l.map((c,w)=>e.jsx("tr",{className:"border-b last:border-0",children:A.map(T=>e.jsx("td",{className:"px-3 py-2 text-gray-800 whitespace-nowrap",children:String(c[T])},T))},w))})]})})};return e.jsxs("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6",children:[e.jsx(G,{title:"Report Center",subtitle:"Report dinamici per ARMANDO",children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3",children:h?Array.from({length:6}).map((i,l)=>e.jsx("div",{className:"h-20 bg-gray-100 animate-pulse rounded"},l)):p.map(i=>e.jsxs("button",{onClick:()=>x(i.ID),className:`text-left p-3 border rounded hover:bg-gray-50 ${u===i.ID?"border-indigo-500":"border-gray-200"}`,children:[e.jsx("div",{className:"font-medium text-gray-800 line-clamp-1",children:i.Titolo}),e.jsx("div",{className:"text-xs text-gray-500 line-clamp-2",children:i.Descrizione})]},i.ID))})}),u!=null&&e.jsxs(G,{title:"Anteprima",subtitle:`Report ID: ${u}`,children:[o.loading&&e.jsx("div",{className:"text-sm text-gray-500",children:"Caricamentoâ€¦"}),o.error&&e.jsx("div",{className:"text-sm text-red-600",children:o.error}),!o.loading&&!o.error&&e.jsx("div",{className:"space-y-6",children:o.recordsets.map((i,l)=>e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs text-gray-500 mb-2",children:["Recordset ",l+1]}),b(i)]},l))})]})]})}function Ne(){const[p,N]=m.useState(!0),[h,y]=m.useState(""),u=new Date,o=(()=>{if(u.getDate()===1){const s=u.getMonth()===0?12:u.getMonth();return{year:u.getMonth()===0?u.getFullYear()-1:u.getFullYear(),month:s}}return{year:u.getFullYear(),month:u.getMonth()+1}})(),[g,x]=m.useState(o.year),[b,i]=m.useState(o.month),[l,A]=m.useState(""),[c,w]=m.useState(""),[T,I]=m.useState(0),[n,j]=m.useState({attivazioniMese:0,agentiAttiviMese:0,andamentoAttivazioniPercentuale:0,fastwebTlc:0,fastwebFissi:0,fastwebMobili:0,fastwebEnergy:0,sky:0,iliad:0,eniPlenitude:0,lastBatchTlc:null,lastBatchEnergy:null,generatedAt:null});m.useEffect(()=>{let t=!0;return(async()=>{try{N(!0);const s=new URLSearchParams;g&&s.set("year",String(g)),b&&s.set("month",String(b)),c&&s.set("agente",c);const a=await z(`/supermaster/kpi${s.toString()?`?${s.toString()}`:""}`);if(!t)return;const d=(E,D)=>{const F=new Set,k=M=>{if(!(!M||typeof M!="object")&&!F.has(M)){if(F.add(M),Array.isArray(M)){for(const C of M){const R=k(C);if(R!==void 0)return R}return}for(const[C,R]of Object.entries(M))if(D.some(_=>_.test(C))){const _=Number(R);if(Number.isFinite(_))return _}for(const C of Object.values(M))if(C&&typeof C=="object"){const R=k(C);if(R!==void 0)return R}}};try{const M=k(E);return Number.isFinite(M)?M:0}catch{return 0}};try{window.__SM_KPI_KEYS_LOGGED__||(console.log("[SM KPI] /supermaster/kpi keys:",Object.keys(a||{})),window.__SM_KPI_KEYS_LOGGED__=!0)}catch{}const r={attivazioniMese:Number(a?.attivazioniMese??0),agentiAttiviMese:Number(a?.agentiAttiviMese??a?.dealerAttiviMese??0),andamentoAttivazioniPercentuale:Number(a?.andamentoAttivazioniPercentuale??0),fastwebTlc:Number(a?.fastwebTlc??0),fastwebFissi:Number(a?.fastwebFissi??a?.fastwebTlcFissi??a?.fwFissi??a?.fissi??0),fastwebMobili:Number(a?.fastwebMobili??a?.fastwebTlcMobili??a?.fwMobili??a?.mobili??0),fastwebEnergy:Number(a?.fastwebEnergy??0),sky:d(a,[/(^|_)sky($|_|\b)/i,/sky\s*mese/i,/sky\s*tot/i]),iliad:d(a,[/(^|_)iliad($|_|\b)/i,/iliad\s*mese/i,/iliad\s*tot/i]),lastBatchTlc:a?.lastBatchTlc??null,lastBatchEnergy:a?.lastBatchEnergy??null,generatedAt:a?.generatedAt??null};r.sky=Number(a?.sky??r.sky??0),r.iliad=Number(a?.iliad??r.iliad??0),r.eniPlenitude=Number(a?.eniPlenitude??0),r.fastwebFissi||(r.fastwebFissi=d(a,[/fiss[oi]/i,/fw\s*fissi/i,/fissi_fw/i,/fastweb.*fiss[oi]/i])),r.fastwebMobili||(r.fastwebMobili=d(a,[/mobil[ei]/i,/fw\s*mobili/i,/mobile_fw/i,/fastweb.*mobil[ei]/i])),r.fastwebTlc&&r.fastwebFissi&&!r.fastwebMobili&&(r.fastwebMobili=Math.max(0,r.fastwebTlc-r.fastwebFissi)),r.fastwebTlc&&r.fastwebMobili&&!r.fastwebFissi&&(r.fastwebFissi=Math.max(0,r.fastwebTlc-r.fastwebMobili));try{const E=Number(r.fastwebFissi||0),D=Number(r.fastwebMobili||0),F=Number(r.fastwebEnergy||0),k=Number(r.sky||0),M=Number(r.iliad||0),C=Number(r.eniPlenitude||0);r.attivazioniMese=E+D+F+k+M+C}catch{}j(r),y("")}catch(s){console.error("[SuperMaster][KPI] Fetch error:",s),y("Impossibile caricare i KPI")}finally{t&&N(!1)}})(),()=>{t=!1}},[g,b,l,c,T]);const S=[{title:"Attivazioni mese",value:String(n.attivazioniMese),change:"",icon:"âš¡",trend:"flat"},{title:"FASTWEB FISSI",value:String(n.fastwebFissi),change:"",icon:"ðŸ“¶",trend:"flat"},{title:"FASTWEB MOBILI",value:String(n.fastwebMobili),change:"",icon:"ðŸ“±",trend:"flat"},{title:"% RIC.AUTOMATICA",value:Number.isFinite(n.andamentoAttivazioniPercentuale)?`${n.andamentoAttivazioniPercentuale}%`:"-",change:"",icon:"ðŸ”",trend:"flat"},{title:"FASTWEB ENERGY",value:String(n.fastwebEnergy),change:"",icon:"ðŸ”Œ",trend:"flat"},{title:"SKY",value:String(n.sky),change:"",icon:"ðŸ“º",trend:"flat"},{title:"ILIAD",value:String(n.iliad),change:"",icon:"ðŸ“¶",trend:"flat"},{title:"ENI PLENITUDE",value:String(n.eniPlenitude),change:"",icon:"âš¡",trend:"flat"}];return e.jsxs("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6 space-y-6",children:[e.jsxs("div",{className:"flex flex-wrap items-end gap-3 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Anno"}),e.jsx("select",{value:g,onChange:t=>x(Number(t.target.value)),className:"border-gray-300 rounded-md text-sm",children:Array.from({length:5},(t,s)=>u.getFullYear()-s).map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Mese"}),e.jsx("select",{value:b,onChange:t=>i(Number(t.target.value)),className:"border-gray-300 rounded-md text-sm",children:[1,2,3,4,5,6,7,8,9,10,11,12].map(t=>e.jsx("option",{value:t,children:String(t).padStart(2,"0")},t))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-500 mb-1",children:"Agente"}),e.jsx("input",{value:c,onChange:t=>w(t.target.value),placeholder:"Nome agente",className:"border-gray-300 rounded-md text-sm px-2 py-1.5"})]}),e.jsx("button",{onClick:()=>{const t=new Date,s=t.getDate();if(A(""),w(""),s===1){const a=t.getMonth()===0?12:t.getMonth(),d=t.getMonth()===0?t.getFullYear()-1:t.getFullYear();x(d),i(a)}else x(t.getFullYear()),i(t.getMonth()+1);I(a=>a+1)},className:"ml-auto text-xs px-3 py-2 border border-gray-300 rounded-md text-gray-600 hover:bg-gray-50",children:"Reset filtri"})]}),!p&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2 mb-4",children:[e.jsx("span",{className:"text-xs text-gray-500",children:"Ultimo aggiornamento dati"}),e.jsxs("span",{className:"text-xs px-2 py-1 rounded-full border border-gray-200 bg-white text-gray-700",children:["TLC: ",n.lastBatchTlc?new Date(n.lastBatchTlc).toLocaleDateString():"n/d"]}),e.jsxs("span",{className:"text-xs px-2 py-1 rounded-full border border-gray-200 bg-white text-gray-700",children:["ENERGY: ",n.lastBatchEnergy?new Date(n.lastBatchEnergy).toLocaleDateString():"n/d"]}),e.jsx("span",{className:"text-xs px-2 py-1 rounded-full border border-gray-200 bg-white text-gray-700",children:"SKY/ILIAD: realâ€‘time"}),n.generatedAt&&e.jsxs("span",{className:"ml-auto text-[11px] text-gray-400",children:["generato: ",new Date(n.generatedAt).toLocaleString()]})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-8 gap-4 mb-6",children:p?Array.from({length:8}).map((t,s)=>e.jsx("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm p-4 animate-pulse h-24"},s)):S.map((t,s)=>e.jsx("div",{className:"animate-fade-in",style:{animationDelay:`${s*.05}s`},children:e.jsx(fe,{...t})},s))}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(je,{filters:{year:g,month:b,province:l,agent:c}}),e.jsx(ve,{kpi:n,year:g,month:b}),e.jsx(Ee,{year:g,month:b})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(we,{filters:{year:g,month:b,province:l,agent:c}}),e.jsx(Se,{})]})]}),e.jsx(De,{})]})}function je({filters:p}){const[N,h]=m.useState([]),[y,u]=m.useState(!0),[f,o]=m.useState("");m.useEffect(()=>{let c=!0;return(async()=>{try{u(!0);const w=await z("/supermaster/reports"),I=(Array.isArray(w?.rows)?w.rows:[]).find(S=>/FASTWEB\s*-\s*Totali\s*Attivazione\s*Fissi\s*e\s*Mobili\s*mese\s*per\s*mese/i.test(S.Titolo||S.titolo||""));if(I?.ID!=null){const S=await z(`/supermaster/reports/${I.ID}`),a=((Array.isArray(S?.recordsets)?S.recordsets:[])[0]||[]).map(d=>({label:d.AnnoMese||d["Anno/Mese"]||d.PERIODO||"",mobile:Number(d.Mobile_FW||d.MOBILE||0),fisso:Number(d.Fissi_FW||d.FISSO||d.WIFI||0)})).sort((d,r)=>String(d.label).localeCompare(String(r.label)));if(c){h(a.map((d,r)=>({Giorno:d.label,Attivazioni:d.mobile+d.fisso}))),o(""),u(!1);return}}const n=await z("/supermaster/trend-mensile");if(!c)return;const j=Array.isArray(n?.rows)?n.rows:n?.data||n||[];h(j),o("")}catch{o("")}finally{c&&u(!1)}})(),()=>{c=!1}},[p?.year,p?.month,p?.province,p?.agent]);const g=N.map((c,w)=>({x:c.Giorno||c.giorno||c.label||c.PERIODO||w+1,y:Number(c.Attivazioni||c.attivazioni||c.val||c.Totale||0)})),x=Math.max(1,...g.map(c=>c.y)),b=g.length?g[g.length-1].y:0,i=g.length>1?Math.round(g.slice(0,-1).reduce((c,w)=>c+w.y,0)/(g.length-1)):0,l=i?Math.round((b-i)/Math.max(1,i)*100):0,A=l>=0?"text-emerald-600 bg-emerald-50 border-emerald-100":"text-rose-600 bg-rose-50 border-rose-100";return e.jsxs(G,{title:"Trend mensile",subtitle:"Attivazioni giorno per giorno (mese corrente)",actions:e.jsx("span",{className:`text-xs px-2 py-1 border rounded-full ${A}`,title:"Ultimo giorno vs media precedenti",children:l>=0?`+${l}%`:`${l}%`}),className:"isolate",children:[f&&e.jsx("div",{className:"text-xs text-red-600 mb-2",children:f}),e.jsx("div",{className:"h-52",children:e.jsx(ee,{width:"100%",height:"100%",children:e.jsxs(oe,{data:g,margin:{top:8,right:8,bottom:0,left:0},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"gradLine",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"0%",stopColor:"#6366f1",stopOpacity:.9}),e.jsx("stop",{offset:"100%",stopColor:"#3b82f6",stopOpacity:.5})]})}),e.jsx(te,{strokeDasharray:"3 3",stroke:"#eef2ff"}),e.jsx(se,{dataKey:"x",tick:{fontSize:11,fill:"#6b7280"},axisLine:!1,tickLine:!1}),e.jsx(ae,{hide:!0,domain:[0,x]}),e.jsx(re,{formatter:c=>[c,"Attivazioni"],labelFormatter:c=>`Giorno ${c}`}),e.jsx(le,{type:"monotone",dataKey:"y",stroke:"url(#gradLine)",strokeWidth:3,dot:!1,activeDot:{r:5}})]})})}),e.jsx("div",{className:"mt-3 text-right",children:e.jsx("a",{href:"/supermaster/analisi",className:"text-xs text-indigo-600 hover:text-indigo-700",children:"Vedi tutto â†’"})})]})}function ve({kpi:p,year:N,month:h}){const[y,u]=m.useState(null),[f,o]=m.useState([]);m.useEffect(()=>{let i=!0;return(async()=>{try{const l=new URLSearchParams;Number.isFinite(h)&&l.set("month",String(h)),Number.isFinite(N)&&l.set("year",String(N));const A=await z(`/supermaster/kpi/sky-hoover${l.toString()?`?${l.toString()}`:""}`),c=Array.isArray(A?.rows)?A.rows:Array.isArray(A)?A:[],w=new Set(["Anno","Mese","AnnoMese","Anno/Mese","PERIODO","Agente","AGENTE","Point","POINT","CITTA","Provincia","PROVINCIA","ORDINAMENTO","ORDINAMENTO_DETTAGLI","DataAggiornamento","ID","Titolo"]);let T=0;const I={};for(const j of c)for(const[S,t]of Object.entries(j)){if(w.has(S))continue;const s=Number(t);!Number.isFinite(s)||s===0||(T+=s,I[S]=(I[S]||0)+s)}const n=Object.entries(I).map(([j,S])=>({label:j,value:S})).sort((j,S)=>S.value-j.value);try{console.debug("[SM][sky-hoover]",{year:N,month:h,rowsLen:c.length,tot:T,breakdown:n})}catch{}i&&(u(T),o(n))}catch{i&&(u(null),o([]))}})(),()=>{i=!1}},[N,h]);const g=[{name:"FASTWEB FISSI",value:Number(p.fastwebFissi||0),color:"bg-blue-600"},{name:"FASTWEB MOBILI",value:Number(p.fastwebMobili||0),color:"bg-sky-500"},{name:"FASTWEB ENERGY",value:Number(p.fastwebEnergy||0),color:"bg-cyan-500"},{name:"SKY",value:Number(p.sky||0),color:"bg-indigo-500"},{name:"ILIAD",value:Number(p.iliad||0),color:"bg-purple-500"},{name:"ENI PLENITUDE",value:Number(p.eniPlenitude||0),color:"bg-emerald-500"}];g.reduce((i,l)=>i+l.value,0);const x=g.map(i=>({name:i.name,value:i.value,color:i.color})),b=({active:i,payload:l,label:A})=>{try{console.debug("[SM][MixProdotti][Tooltip]",{active:i,label:A,payloadLen:(l||[]).length})}catch{}if(!i||!l||!l.length)return null;const c=l[0]?.payload?.name||A,w=l[0]?.value??0;if(c!=="SKY")return e.jsxs("div",{className:"text-xs bg-white p-2 rounded shadow border border-gray-200",children:[e.jsx("div",{className:"font-semibold text-gray-800",children:c}),e.jsxs("div",{className:"text-gray-700",children:[c,": ",w]})]});const T=Number.isFinite(y)?y:w;return e.jsxs("div",{className:"text-xs bg-white p-2 rounded shadow border border-gray-200 max-w-[240px]",children:[e.jsx("div",{className:"font-semibold text-gray-800 mb-1",children:"SKY"}),e.jsxs("div",{className:"text-gray-800 mb-1",children:["Totale: ",T]}),f&&f.length>0?e.jsx("ul",{className:"space-y-0.5 max-h-40 overflow-auto",children:f.map((I,n)=>e.jsxs("li",{className:"flex justify-between gap-2",children:[e.jsx("span",{className:"text-gray-600 truncate",children:I.label}),e.jsx("span",{className:"text-gray-900 font-medium",children:I.value})]},n))}):e.jsx("div",{className:"text-gray-500",children:"Nessun dettaglio disponibile"})]})};return e.jsx(G,{title:"Mix prodotti (mese)",subtitle:"Distribuzione attivazioni per linea (Fissi/Mobili separati)",className:"isolate",children:e.jsx("div",{className:"h-56",children:e.jsx(ee,{width:"100%",height:"100%",children:e.jsxs(ce,{data:x,margin:{top:8,right:8,bottom:0,left:-20},children:[e.jsx(te,{strokeDasharray:"3 3",stroke:"#eef2ff"}),e.jsx(se,{dataKey:"name",tick:{fontSize:11,fill:"#6b7280"},axisLine:!1,tickLine:!1}),e.jsx(ae,{hide:!0}),e.jsx(re,{content:i=>e.jsx(b,{...i})}),e.jsx(de,{dataKey:"value",radius:[6,6,0,0],children:x.map((i,l)=>e.jsx(me,{fill:i.color==="bg-blue-600"?"#2563eb":i.color==="bg-sky-500"?"#0ea5e9":i.color==="bg-cyan-500"?"#06b6d4":i.color==="bg-indigo-500"?"#6366f1":i.color==="bg-purple-500"?"#8b5cf6":i.color==="bg-emerald-500"?"#10b981":"#8b5cf6"},`cell-${l}`))})]})})})})}function we(){const[p,N]=m.useState([]),[h,y]=m.useState(!0),[u,f]=m.useState(!1),[o,g]=m.useState("ALL"),[x,b]=m.useState([]),[i,l]=m.useState([]),[A,c]=m.useState(!1),[w,T]=m.useState("");m.useEffect(()=>{let n=!0;return(async()=>{try{y(!0);const j=await z("/supermaster/reports"),t=(Array.isArray(j?.rows)?j.rows:[]).find(s=>/SUPERM\.?\s*-\s*Attivit[aÃ ]\s*recenti/i.test(s.Titolo||s.titolo||""));if(t?.ID!=null){const s=await z(`/supermaster/reports/${t.ID}`),d=(Array.isArray(s?.recordsets)?s.recordsets:[])[0]||[];if(n){Array.isArray(d)&&d.length>0&&N(d),y(!1);return}}try{console.debug("[SM][AttivitaRecenti] Report non trovato o vuoto")}catch{}}catch{}finally{n&&y(!1)}})(),()=>{n=!1}},[]);const I=async n=>{try{c(!0),T(""),n&&g(n);const j=await z("/supermaster/reports"),t=(Array.isArray(j?.rows)?j.rows:[]).find(s=>/SUPERM\.?\s*-\s*Attivit[aÃ ]\s*recenti/i.test(s.Titolo||s.titolo||""));if(t?.ID!=null){const s=await z(`/supermaster/reports/${t.ID}`),a=Array.isArray(s?.recordsets)?s.recordsets:[];b((a[1]||[]).slice(0,5)),l((a[2]||[]).slice(0,5))}else b([]),l([]);f(!0)}catch{T("Errore nel caricamento dei dettagli"),f(!0)}finally{c(!1)}};return e.jsxs(G,{title:"AttivitÃ  recenti",subtitle:"Ultimi eventi su attivazioni, ordini e dealer",actions:h?e.jsx("span",{className:"text-xs text-gray-400",children:"Caricamentoâ€¦"}):null,children:[e.jsx("ul",{className:"divide-y divide-gray-100",children:(p.length?p:h?Array.from({length:5}):[]).slice(0,5).map((n,j)=>{const t=(n?.Tipo||n?.tipo||"").toString().toUpperCase().includes("ATTIVAZIONE"),s=t?"bg-emerald-100 text-emerald-700 border-emerald-200":"bg-indigo-100 text-indigo-700 border-indigo-200",a=t?"âš¡ ATT":"ðŸ§¾ ORD";return e.jsxs("li",{className:"py-2 text-sm flex items-center justify-between cursor-pointer hover:bg-gray-50 px-2 rounded",onClick:()=>I(t?"ATT":"ORD"),children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("span",{className:`inline-flex items-center justify-center text-[10px] font-semibold px-2 py-0.5 rounded border ${s}`,children:a}),e.jsx("div",{className:"text-gray-700 truncate",children:n?.Descrizione||n?.descrizione||n?.title||"Evento"})]}),e.jsx("div",{className:"text-xs text-gray-400 whitespace-nowrap",children:String(n?.Data||n?.data||"").slice(0,16)})]},j)})}),p.length===0&&!h&&e.jsx("div",{className:"text-sm text-gray-500",children:"Nessuna attivitÃ  recente."}),u&&e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:()=>f(!1)}),e.jsxs("div",{className:"relative bg-white rounded-lg shadow-xl w-full max-w-3xl mx-4 p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"Dettagli recenti"}),e.jsx("button",{onClick:()=>f(!1),className:"text-gray-500 hover:text-gray-700",children:"âœ•"})]}),A&&e.jsx("div",{className:"text-sm text-gray-500",children:"Caricamentoâ€¦"}),w&&e.jsx("div",{className:"text-sm text-red-600",children:w}),!A&&!w&&e.jsxs("div",{className:`grid grid-cols-1 ${o==="ALL"?"md:grid-cols-2":""} gap-4`,children:[(o==="ALL"||o==="ATT")&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"Ultime 5 Attivazioni"}),e.jsx("div",{className:"max-h-72 overflow-auto border rounded",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Tipo"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Data"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Descrizione"})]})}),e.jsxs("tbody",{children:[x.map((n,j)=>{const S=(n?.Tipo||n?.tipo||"").toString().toUpperCase();return e.jsxs("tr",{className:"border-b last:border-0",children:[e.jsx("td",{className:"px-3 py-2 text-gray-700",children:S||"ATTIVAZIONE"}),e.jsx("td",{className:"px-3 py-2 text-gray-600",children:String(n.Data||n.data||"").slice(0,16)}),e.jsx("td",{className:"px-3 py-2 text-gray-800",children:n.Descrizione||n.descrizione||""})]},j)}),x.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"px-3 py-4 text-sm text-gray-500",children:"Nessuna attivazione"})})]})]})})]}),(o==="ALL"||o==="ORD")&&e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-gray-500 mb-2",children:"Ultimi 5 Ordini"}),e.jsx("div",{className:"max-h-72 overflow-auto border rounded",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Tipo"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Data"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Descrizione"})]})}),e.jsxs("tbody",{children:[i.map((n,j)=>{const S=(n?.Tipo||n?.tipo||"").toString().toUpperCase()||"ORDINE";return e.jsxs("tr",{className:"border-b last:border-0",children:[e.jsx("td",{className:"px-3 py-2 text-gray-700",children:S}),e.jsx("td",{className:"px-3 py-2 text-gray-600",children:String(n.Data||n.data||"").slice(0,16)}),e.jsx("td",{className:"px-3 py-2 text-gray-800",children:n.Descrizione||n.descrizione||""})]},j)}),i.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"px-3 py-4 text-sm text-gray-500",children:"Nessun ordine"})})]})]})})]})]})]})]})]})}function Se(){const p=J(),N=[{label:"Report mensile",onClick:()=>window.open("/api/supermaster/report/mensile","_blank")},{label:"Export attivazioni",onClick:()=>window.open("/api/supermaster/export/attivazioni?period=month","_blank")},{label:"Apri geolocalizzazione",onClick:()=>p("/supermaster/geolocalizzazione")},{label:"Analisi agenti",onClick:()=>p("/supermaster/analisi")}];return e.jsx(G,{title:"Azioni rapide",subtitle:"Report ed esplorazione",children:e.jsx("div",{className:"grid grid-cols-1 gap-2",children:N.map((h,y)=>e.jsx("button",{onClick:h.onClick,className:"w-full text-left px-3 py-2 border border-gray-200 rounded-md hover:bg-gray-50 active:scale-[0.99] transition text-sm text-gray-700",children:h.label},y))})})}function Ae(){return e.jsx("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6",children:e.jsx(pe,{})})}function Me(){const[p,N]=m.useState(!0),[h,y]=m.useState(""),[u,f]=m.useState({step:0,msg:"Caricamentoâ€¦",progress:5}),o="sm-map-container",g=t=>new Promise((s,a)=>{const d=document.querySelector(`script[src="${t}"]`);if(d){d.addEventListener("load",s),d.addEventListener("error",a);return}const r=document.createElement("script");r.src=t,r.async=!0,r.defer=!0,r.onload=s,r.onerror=a,document.head.appendChild(r)}),x=t=>{const s=t.lat??t.latitude??t.Latitude??t.Latitudine??t.Lat,a=t.lng??t.longitude??t.Longitude??t.Longitudine??t.Lng;if(s==null||a==null)return null;const d=Number(s),r=Number(a);return Number.isFinite(d)&&Number.isFinite(r)?{lat:d,lng:r}:null},b=t=>[t.Indirizzo||t.indirizzo,t.CAP||t.cap,t.Citta||t.CittÃ ||t.citta,t.Provincia||t.provincia,"Italia"].filter(Boolean).map(a=>String(a).trim()).filter(Boolean).join(", "),i="supermaster_geocode_cache_v1",l=720*60*60*1e3,A=()=>{try{return JSON.parse(localStorage.getItem(i)||"{}")}catch{return{}}},c=t=>{try{localStorage.setItem(i,JSON.stringify(t))}catch{}},w=t=>{if(!t)return null;const a=A()[t];return!a||Date.now()-(a.ts||0)>l?null:{lat:a.lat,lng:a.lng}},T=(t,s)=>{if(!t||!s)return;const a=A();a[t]={lat:s.lat,lng:s.lng,ts:Date.now()},c(a)},I=async(t,s)=>{const d=[150,300,600,1200];for(let r=0;r<4;r++){try{const D=(await t.geocode({address:s}))?.results?.[0]?.geometry?.location;if(D)return{lat:D.lat(),lng:D.lng()}}catch(E){const D=E&&E.message||"";if(!/OVER_QUERY_LIMIT|RESOURCE_EXHAUSTED/i.test(D)&&r===3)throw E}await new Promise(E=>setTimeout(E,d[r]))}return null},n=(t,s)=>{const a=t.lat,d=t.lng,r=s.lat,E=s.lng,D=6371,F=P=>P*Math.PI/180,k=F(r-a),M=F(E-d),C=Math.sin(k/2),R=Math.sin(M/2),_=C*C+Math.cos(F(a))*Math.cos(F(r))*R*R,W=2*Math.atan2(Math.sqrt(_),Math.sqrt(1-_));return D*W},j=(t="#2563eb")=>({url:`data:image/svg+xml;utf-8,${encodeURIComponent(`<?xml version="1.0" ?><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="${t}" stroke-width="1.5"><path d="M12 22s8-4.5 8-12a8 8 0 1 0-16 0c0 7.5 8 12 8 12z" fill="${t}" stroke="${t}"/></svg>`)}`,scaledSize:new window.google.maps.Size(32,32),anchor:new window.google.maps.Point(16,30)}),S=(t,s)=>{const a=[],d=(E,D)=>{D==null||D===""||D==="NULL"||a.push(`<div><span style="color:#64748b">${E}:</span> <strong style="color:#111827">${String(D)}</strong></div>`)};if(d("Ragione Sociale",t.RagioneSociale||t.ragioneSociale||t.Dealer||t.NomeDealer||t.dealer),d("Cellulare",t.RecapitoCell||t.cell||t.Cell||t.RecapitoCellulare),d("StationCode",t.StationCode||t.stationCode),d("COMSY1",t.COMSY1),d("COMSY2",t.COMSY2),d("Agente",t.Agente||t.agente||t.NOME_AGENTE||t.nomeAgente),typeof s=="number"){const E=s<10?s.toFixed(2):s.toFixed(1);a.push(`<div><span style="color:#64748b">Distanza</span>: <strong style="color:#111827">${E} km da KIM srls</strong></div>`)}return`
      <div style="font-size:12px; line-height:1.3; max-width:260px">
        <div style="font-weight:600; color:#111827; margin-bottom:4px">${t.RagioneSociale||t.Dealer||t.NomeDealer||"Dealer"}</div>
        ${a.join("")}
      </div>
    `};return m.useEffect(()=>{let t=!0;return(async()=>{try{N(!0),f({step:1,msg:"Caricamentoâ€¦",progress:10});const s=await z("/config/maps-key");if(!t)return;f({step:2,msg:"Sto preparando la mappaâ€¦",progress:20});const a=s?.apiKey||s?.key,d=s?.mapId||void 0;if(!a)throw new Error("API key Google Maps non configurata");if(await g(`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(a)}&v=weekly`),await g("https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"),!t)return;f({step:3,msg:"Sto caricando i dealersâ€¦",progress:35});let r=document.getElementById(o);if(!r){r=document.createElement("div"),r.id=o,r.style.width="100%",r.style.height="70vh";const v=document.getElementById(`${o}-holder`);v&&v.appendChild(r)}const E=await z("/dealers/locations");if(!t)return;f({step:4,msg:"Sto posizionando i dealers sulla mappaâ€¦",progress:45});const D=new window.google.maps.Geocoder,F="Via Appia 324, 72100 Brindisi, Italia";let k=w(F);if(!k){const v=await I(D,F);v&&(k=v,T(F,v))}const M=[],C=Array.isArray(E)?E:[],R=C.length||1;let _=0;for(const v of C){let L=x(v);if(!L){const $=b(v);$&&(L=w($)||await I(D,$),L&&T($,L))}if(L&&M.push({d:v,ll:L}),_+=1,t&&_%3===0){const $=Math.min(_/R,1),Q=Math.floor(45+$*40);f(O=>({...O,progress:Q}))}}const W=M[0]?.ll||{lat:41.1171,lng:16.8719},P=new window.google.maps.Map(r,{center:W,zoom:6,mapId:d});t&&f({step:5,msg:"Quasi prontoâ€¦",progress:90});const Y=new window.google.maps.LatLngBounds,q=new window.google.maps.InfoWindow;let B=null,U=null,K=null;const X=(v,L)=>{try{q.setContent(L)}catch{}q.open({anchor:v,map:P})},V=()=>{try{q.close()}catch{}};P.addListener("click",()=>{B=null,V()});const H=M.map(({d:v,ll:L})=>{const $=!!(v.COMSY||v.Comsy||v.comsy||v.COMSY1||v.COMSY2),Q=j($?"#f97316":"#2563eb"),O=new window.google.maps.Marker({position:L,icon:Q}),ie=k?n(L,k):null,Z=S(v,ie);return O.addListener("mouseover",()=>{B&&B!==O||(K&&(clearTimeout(K),K=null),U=setTimeout(()=>X(O,Z),120))}),O.addListener("mouseout",()=>{B!==O&&(U&&(clearTimeout(U),U=null),K=setTimeout(()=>V(),200))}),O.addListener("click",()=>{B===O?(B=null,V()):(B=O,X(O,Z))}),Y.extend(L),O});if(k){const v=new window.google.maps.Marker({position:k,map:P,title:"HQ â€¢ KIM srls",icon:j("#16a34a")});Y.extend(k)}try{const v=window.markerClusterer?.MarkerClusterer||window.MarkerClusterer;v?new v({map:P,markers:H}):H.forEach(L=>L.setMap(P))}catch{H.forEach(v=>v.setMap(P))}if(!Y.isEmpty&&(typeof Y.isEmpty!="function"||!Y.isEmpty())&&P.fitBounds(Y),!t)return;y(M.length?"":"Nessun dealer con coordinate disponibili."),f({step:6,msg:"Fatto!",progress:100})}catch(s){console.error("[SuperMaster][Geo] Errore mappa:",s),t&&y(s.message||"Errore nella mappa")}finally{t&&N(!1)}})(),()=>{t=!1}},[]),e.jsxs("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6 space-y-4",children:[e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm p-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"Geolocalizzazione Dealer"}),p&&e.jsxs("div",{className:"flex items-center gap-3 text-xs text-gray-500",children:[e.jsx("span",{children:u.msg}),e.jsx("div",{className:"w-40 h-2 bg-gray-200 rounded overflow-hidden",children:e.jsx("div",{className:"h-2 bg-blue-600 transition-all duration-300",style:{width:`${Math.min(u.progress,100)}%`}})})]})]}),h&&e.jsx("div",{className:"text-xs text-red-600 mt-2",children:h})]}),e.jsxs("div",{id:`${o}-holder`,className:"bg-white border border-gray-200 rounded-lg shadow-sm p-2",children:[p&&e.jsxs("div",{className:"px-2 pb-2",children:[e.jsx("div",{className:"text-xs text-gray-500 mb-2",children:u.msg}),e.jsx("div",{className:"w-full h-2 bg-gray-200 rounded overflow-hidden",children:e.jsx("div",{className:"h-2 bg-blue-600 transition-all duration-300",style:{width:`${Math.min(u.progress,100)}%`}})}),e.jsx("div",{className:"mt-2 text-[11px] text-gray-400",children:"Sto preparando la mappa, caricando i dealers e posizionando i markerâ€¦"})]}),!p&&e.jsx("div",{className:"text-xs text-gray-400 px-2 pb-2",children:"Mappa interattiva"})]})]})}function Ee({year:p,month:N}){const[h,y]=m.useState([]),[u,f]=m.useState(!0),[o,g]=m.useState("");return m.useEffect(()=>{let x=!0;return(async()=>{try{f(!0);const b=new URLSearchParams;Number.isFinite(N)&&b.set("month",String(N)),Number.isFinite(p)&&b.set("year",String(p));const i=`/supermaster/classifica-agenti${b.toString()?`?${b.toString()}`:""}`,l=await z(i);if(!x)return;y(Array.isArray(l)?l.slice(0,10):[]),g("")}catch(b){console.error("[SuperMaster][RANKING] Fetch error:",b),g("Impossibile caricare la classifica agenti")}finally{x&&f(!1)}})(),()=>{x=!1}},[p,N]),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"Top Agenti (mese corrente)"}),u&&e.jsx("span",{className:"text-xs text-gray-400",children:"Caricamentoâ€¦"})]}),o&&e.jsx("div",{className:"text-xs text-red-600 mb-2",children:o}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-left text-gray-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pr-3",children:"Agente"}),e.jsx("th",{className:"py-2 pr-3",children:"Dealer totali"}),e.jsx("th",{className:"py-2 pr-3",children:"Dealer ingaggiati"}),e.jsx("th",{className:"py-2 pr-3",children:"Attivazioni"}),e.jsx("th",{className:"py-2 pr-3",children:"Media/Dealer"})]})}),e.jsxs("tbody",{children:[h.map((x,b)=>e.jsxs("tr",{className:"border-t border-gray-100",children:[e.jsx("td",{className:"py-2 pr-3 font-medium text-gray-800",children:x.Agente||x.agente||"â€”"}),e.jsx("td",{className:"py-2 pr-3",children:x.DealerTotali??x.dealer_totali??"0"}),e.jsx("td",{className:"py-2 pr-3",children:x.DealerIngaggiati??x.dealer_ingaggiati??"0"}),e.jsx("td",{className:"py-2 pr-3",children:x.TotaleAttivazioni??x.totale_attivazioni??"0"}),e.jsx("td",{className:"py-2 pr-3",children:(x.MediaAttivazioniPerDealer??x.media_attivazioni_per_dealer??0).toFixed?(x.MediaAttivazioniPerDealer??x.media_attivazioni_per_dealer??0).toFixed(2):x.MediaAttivazioniPerDealer??x.media_attivazioni_per_dealer??0})]},b)),(!h||h.length===0)&&!u&&e.jsx("tr",{children:e.jsx("td",{className:"py-4 text-gray-500",colSpan:5,children:"Nessun dato disponibile per il mese corrente."})})]})]})})]})}function De(){const[p,N]=m.useState([]),[h,y]=m.useState(!0),[u,f]=m.useState("");return m.useEffect(()=>{let o=!0;return(async()=>{try{y(!0);const g=await z("/supermaster/attivazioni");if(!o)return;N(Array.isArray(g)?g.slice(0,10):Array.isArray(g?.rows)?g.rows.slice(0,10):[]),f("")}catch(g){console.error("[SuperMaster][ATTIVAZIONI] Fetch error:",g),f("Impossibile caricare le attivazioni")}finally{o&&y(!1)}})(),()=>{o=!1}},[]),e.jsxs("div",{className:"bg-white border border-gray-200 rounded-lg shadow-sm p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold text-gray-800",children:"Ultime attivazioni (mese corrente)"}),h&&e.jsx("span",{className:"text-xs text-gray-400",children:"Caricamentoâ€¦"})]}),u&&e.jsx("div",{className:"text-xs text-red-600 mb-2",children:u}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"text-left text-gray-500",children:e.jsxs("tr",{children:[e.jsx("th",{className:"py-2 pr-3",children:"Data"}),e.jsx("th",{className:"py-2 pr-3",children:"Tipo"}),e.jsx("th",{className:"py-2 pr-3",children:"Dealer"}),e.jsx("th",{className:"py-2 pr-3",children:"Agente"})]})}),e.jsxs("tbody",{children:[p.map((o,g)=>{const x=o.DataOra||o.Data||o.created_at||o.dataInserimento||"",b=o.Tipo||o.source||o.Operatore||o.operatore||"â€”",i=o.Dealer||o.NomeDealer||o.dealer||o.nomeDealer||"â€”",l=o.Agente||o.agente||"â€”";return e.jsxs("tr",{className:"border-top border-gray-100",children:[e.jsx("td",{className:"py-2 pr-3",children:String(x).slice(0,10)}),e.jsx("td",{className:"py-2 pr-3",children:b}),e.jsx("td",{className:"py-2 pr-3",children:i}),e.jsx("td",{className:"py-2 pr-3",children:l})]},g)}),(!p||p.length===0)&&!h&&e.jsx("tr",{children:e.jsx("td",{className:"py-4 text-gray-500",colSpan:4,children:"Nessuna attivazione trovata per il mese corrente."})})]})]})})]})}function Pe(){const{user:p}=ue(),N=ne(),h=J();m.useEffect(()=>{const f=ge(),o=(p?.role||"").toString().trim().toLowerCase().replace(/[^a-z]/g,"");try{console.log("[SM Guard] token?",!!f,"role:",o,"path:",window?.location?.pathname)}catch{}if(!f){h("/login",{replace:!0});return}if(o==="agente"||o==="agent"){h("/agente",{replace:!0});return}if(o&&o!=="supermaster"&&o!=="admin"){h("/unauthorized",{replace:!0});return}},[p]);const y=(N.pathname||"").toLowerCase(),u=y.includes("/strumenti")?"strumenti":y.includes("/incentivi")?"incentivi":y.includes("/geolocalizzazione")?"geo":y.includes("/analisi")?"analisi":y.includes("/reports")?"reports":"home";return m.useEffect(()=>{try{console.log("[SM] pathname:",N.pathname,"-> section:",u)}catch{}},[N.pathname,u]),e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(be,{}),u==="home"&&e.jsx(Ne,{}),u==="incentivi"&&e.jsx(Ae,{}),u==="strumenti"&&e.jsx(he,{}),u==="geo"&&e.jsx(Me,{}),u==="analisi"&&e.jsx(xe,{embed:!0}),u==="reports"&&e.jsx(ye,{})]})}export{Pe as default};
