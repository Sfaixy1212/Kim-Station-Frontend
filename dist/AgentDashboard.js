import{r as l,j as e}from"./vendor.js";import{g as N,u as S}from"./index.js";import{D as E}from"./DashboardLayout.js";import{S as C}from"./StatsCard.js";import{C as M}from"./Card.js";import{A as T}from"./AgendaFAB.js";import"./logo2.js";function D({scope:d,dealerId:m,agente:u,title:i="News",maxItems:b=3}){const[v,s]=l.useState([]),[y,r]=l.useState(!0),[t,g]=l.useState("");return l.useEffect(()=>{let h=!0;return(async()=>{try{r(!0),g("");const a=new URLSearchParams;d&&a.set("scope",d),a.set("active","true"),d==="dealer"&&m!=null&&m!==""&&a.set("dealerId",String(m)),d==="agente"&&u&&a.set("agente",String(u));const x=await N(`/supermaster/news?${a.toString()}`);if(!h)return;const f=Array.isArray(x)?x:[];s(f.slice(0,b))}catch(a){h&&g(a?.message||"Errore caricamento news")}finally{h&&r(!1)}})(),()=>{h=!1}},[d,m,u,b]),e.jsxs(M,{title:i,subtitle:d==="dealer"?"Comunicazioni per il tuo punto vendita":"Comunicazioni per l'agente",children:[y&&e.jsx("div",{className:"space-y-1.5",children:Array.from({length:2}).map((h,a)=>e.jsx("div",{className:"h-3 bg-gray-200 rounded animate-pulse"},a))}),!y&&t&&e.jsx("div",{className:"text-xs text-red-600",children:t}),!y&&!t&&e.jsxs("ul",{className:"space-y-1",children:[v.slice(0,2).map(h=>e.jsxs("li",{className:"border-b last:border-none border-gray-100 pb-1",children:[e.jsx("div",{className:"text-xs font-medium text-gray-800 line-clamp-1",children:h.Titolo}),e.jsx("div",{className:"text-xs text-gray-500 line-clamp-1",children:h.Messaggio})]},h.ID)),v.length===0&&e.jsx("li",{className:"text-xs text-gray-500",children:"Nessuna news al momento."})]})]})}function $(){const[d,m]=l.useState(null),[u,i]=l.useState(!0),[b,v]=l.useState(null),[s,y]=l.useState(""),r=l.useMemo(()=>{const a=[],x=new Date,f=x.getFullYear(),j=x.getMonth()+1,n=2025,o=9;let c=n,p=o;for(;c<f||c===f&&p<=j;){const w=`${c}-${String(p).padStart(2,"0")}-01`,A=new Date(c,p-1,1).toLocaleDateString("it-IT",{month:"long",year:"numeric"});a.push({value:w,label:A.charAt(0).toUpperCase()+A.slice(1)}),p++,p>12&&(p=1,c++)}return a.reverse()},[]);l.useEffect(()=>{let a=!0;return(async()=>{try{i(!0);const x=s?`/agente/compensi?monthStart=${s}`:"/agente/compensi",f=await N(x);a&&(console.log("[CompensationCard] Dati ricevuti:",f),m(f))}catch(x){console.error("Errore fetch compensi:",x),a&&v(x.message||"Errore di caricamento")}finally{a&&i(!1)}})(),()=>{a=!1}},[s]);const t=a=>new Intl.NumberFormat("it-IT",{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:2}).format(a||0),g=d?.data||{};d?.meseLabel,console.log("[CompensationCard] compensiData:",g);const h=[{key:"Euro_RA",title:"â‚¬ RA",icon:"ðŸ”",color:"bg-green-50 border-green-200",textColor:"text-green-700"},{key:"Euro_Attivazioni",title:"â‚¬ ATTIVAZIONI",icon:"ðŸ“±",color:"bg-blue-50 border-blue-200",textColor:"text-blue-700"},{key:"Euro_SimVendute",title:"â‚¬ SIM",icon:"ðŸ§¾",color:"bg-purple-50 border-purple-200",textColor:"text-purple-700"},{key:"Euro_Bonus",title:"â‚¬ BONUS",icon:"ðŸŽ",color:"bg-orange-50 border-orange-200",textColor:"text-orange-700"},{key:"Euro_Contributo",title:"â‚¬ CONTRIB.",icon:"ðŸ’¼",color:"bg-gray-50 border-gray-200",textColor:"text-gray-700"},{key:"Euro_Totale_Compenso",title:"â‚¬ TOTALE",icon:"ðŸ’°",color:"bg-emerald-100 border-emerald-300",textColor:"text-emerald-800",highlight:!0}];return e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 flex items-center",children:"ðŸ’° Compensi del Mese"}),e.jsxs("select",{value:s,onChange:a=>y(a.target.value),className:"text-sm border border-gray-300 rounded-md px-3 py-1.5 bg-white hover:border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all",children:[e.jsx("option",{value:"",children:"Mese Corrente"}),r.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))]})]}),u&&e.jsx("div",{className:"py-6 text-sm text-gray-500 text-center",children:"Caricamento compensi..."}),b&&!u&&e.jsx("div",{className:"py-6 text-sm text-red-600 text-center",children:b}),!u&&!b&&e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-3 gap-3",children:h.map(a=>{const x=g[a.key]||0;return e.jsxs("div",{className:`rounded-lg border p-3 transition-all hover:shadow-md ${a.highlight?"ring-2 ring-emerald-400":""} ${a.color}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-lg",children:a.icon}),a.highlight&&e.jsx("span",{className:"text-[10px] font-bold text-emerald-600 bg-emerald-200 px-1.5 py-0.5 rounded-full",children:"TOTALE"})]}),e.jsx("div",{className:`text-xs font-medium mb-1 ${a.textColor}`,children:a.title}),e.jsx("div",{className:`text-lg font-bold ${a.highlight?"text-emerald-800":a.textColor}`,children:t(x)})]},a.key)})})]})}const F=["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"];function I(d){return["ILIAD","KENA","1MOBILE","WEEDOO"].reduce((u,i)=>u+(Number(d?.[i])||0),0)}function P(d){return["MOBILE","FISSO","ENERGIA","PRODOTTI"].reduce((u,i)=>u+(Number(d?.[i])||0),0)}function R(d){const m=/^(\d{4})[-\/.](\d{2})$/.exec(String(d||""));if(!m)return String(d||"");const u=Math.max(0,Math.min(11,parseInt(m[2],10)-1));return F[u]}function O(){const[d]=l.useState(6),[m,u]=l.useState([]),[i,b]=l.useState(!0),[v,s]=l.useState(null),{user:y}=S(),r=(y?.role||"").toString().toLowerCase(),t=r==="agente"||r==="agent";l.useEffect(()=>{let n=!0;return(async()=>{try{b(!0);const o=t?`/agente/andamento-attivazioni?months=${d}`:`/andamento?year=${new Date().getFullYear()}`,c=await N(o);let p=[];c&&Array.isArray(c)?p=c:c&&Array.isArray(c?.data)&&(p=c.data),n&&u(p)}catch(o){console.error("Errore fetch andamento mensile:",o),n&&s(o.message||"Errore di caricamento")}finally{n&&b(!1)}})(),()=>{n=!1}},[t,d]);const g=l.useMemo(()=>m.map(n=>{const o=n.AnnoMese??n.ANNO_MESE??n.anno_mese;return{month:R(o),activations:t?P(n):I(n)}}),[m,t]),h=l.useMemo(()=>Math.max(1,...g.map(n=>n.activations)),[g]),a=(n,o)=>n/o*100,x=g[g.length-1]||{activations:0,month:"-"},f=g[g.length-2]||{activations:0},j=f.activations?(x.activations-f.activations)/f.activations*100:0;return e.jsxs("div",{className:"bg-white rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900 flex items-center",children:"Andamento Mensile"}),e.jsx("div",{className:"flex space-x-3 text-xs",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-3 h-3 bg-blue-500 rounded mr-1"}),e.jsx("span",{className:"text-gray-600",children:"Attivazioni"})]})})]}),i&&e.jsx("div",{className:"py-6 text-sm text-gray-500",children:"Caricamentoâ€¦"}),v&&!i&&e.jsx("div",{className:"py-6 text-sm text-red-600",children:v}),!i&&!v&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-4",children:e.jsx("div",{className:"flex items-end justify-between h-38 bg-gray-50 rounded-lg p-3",children:g.map((n,o)=>e.jsxs("div",{className:"flex flex-col items-center space-y-2 flex-1",children:[e.jsx("div",{className:"flex flex-col items-center space-y-1 w-full",children:e.jsx("div",{className:"w-3 bg-gray-200 rounded relative",children:e.jsx("div",{className:"bg-blue-500 rounded transition-all duration-500",style:{height:`${a(n.activations,h)}px`},title:`${n.activations} attivazioni`})})}),e.jsx("span",{className:"text-xs text-gray-600 font-medium",children:n.month||"-"})]},`${n.month||"-"}-${o}`))})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsx("div",{className:"bg-blue-50 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-blue-600 font-medium",children:["Attivazioni ",x.month]}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:x.activations})]}),e.jsxs("div",{className:`text-sm font-medium ${j>=0?"text-green-600":"text-red-600"}`,children:[j>=0?"â†—":"â†˜"," ",Math.abs(j).toFixed(1),"%"]})]})}),e.jsx("div",{className:"bg-purple-50 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-purple-600 font-medium",children:"Media Mensile"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:g.length?Math.round(g.reduce((n,o)=>n+o.activations,0)/g.length):0})]}),e.jsx("div",{className:"text-xs text-purple-600",children:"attivazioni"})]})})]})]})]})}function z(){const d=new Date,[m]=l.useState(d.getFullYear()),[u]=l.useState(d.getMonth()+1),[i,b]=l.useState(null),[v,s]=l.useState(!0);l.useEffect(()=>{let r=!0;return(async()=>{try{s(!0);const t=await N(`/agente/obiettivi-compensi-v2?year=${m}&month=${u}`);r&&b(t)}catch(t){console.error("Errore fetch obiettivi:",t)}finally{r&&s(!1)}})(),()=>{r=!1}},[m,u]);const y=l.useMemo(()=>{if(!i?.targetsDetailed)return[];const r=i.targetsDetailed,t=i.progressi||{},g=(c,p)=>{if(!p)return{actual:c||0,target:0,percent:0};const w=Math.round(c/p*100);return{actual:c||0,target:p,percent:w}},h=r.fissi?.totale||0,a=r.mobili?.totale||0,x=r.energy?.totale||0,f=(t.fissiStart||0)+(t.fissiPro||0)+(t.fissiUltra||0),j=(t.mobileStart||0)+(t.mobilePro||0)+(t.mobileUltra||0),n=(t.energyCore||0)+(t.energyFlex||0)+(t.energyFix||0)+(t.energyEni||0),o=(c,p)=>p>0?Math.round(c/p*100):0;return[{title:"FISSI",summary:g(t.fissiAttuali,h),details:[{label:"Start",actual:t.fissiStart||0,percent:o(t.fissiStart,f),showTarget:!1},{label:"Pro",actual:t.fissiPro||0,percent:o(t.fissiPro,f),showTarget:!1},{label:"Ultra",actual:t.fissiUltra||0,percent:o(t.fissiUltra,f),showTarget:!1}].filter(c=>c.actual>0)},{title:"MOBILI",summary:g(t.mobileAttuali,a),details:[{label:"Start",actual:t.mobileStart||0,percent:o(t.mobileStart,j),showTarget:!1},{label:"Pro",actual:t.mobilePro||0,percent:o(t.mobilePro,j),showTarget:!1},{label:"Ultra",actual:t.mobileUltra||0,percent:o(t.mobileUltra,j),showTarget:!1},{label:"% RA",actual:t.mobilePercentRA||0,unit:"%",showTarget:!1,isRAPercentage:!0},{label:"Convergenze",actual:t.convergenzaRES||0,percent:o(t.convergenzaRES,j),showTarget:!1}].filter(c=>c.isRAPercentage||c.actual>0)},{title:"ENERGY",summary:g(t.energyAttuali,x),details:[{label:"Core",actual:t.energyCore||0,percent:o(t.energyCore,n),showTarget:!1},{label:"Flex",actual:t.energyFlex||0,percent:o(t.energyFlex,n),showTarget:!1},{label:"Fix",actual:t.energyFix||0,percent:o(t.energyFix,n),showTarget:!1},{label:"ENI",actual:t.energyEni||0,percent:o(t.energyEni,n),showTarget:!1},{label:"% FW",actual:t.energyPercentFastweb||0,unit:"%",showTarget:!1,isRAPercentage:!0}].filter(c=>c.isRAPercentage||c.actual>0)}]},[i]);return v?e.jsx("div",{className:"text-sm text-gray-500",children:"Caricamento obiettivi..."}):y.length?e.jsx("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:y.map(r=>e.jsx(L,{...r},r.title))}):e.jsx("div",{className:"text-sm text-gray-500",children:"Nessun obiettivo disponibile"})}function L({title:d,summary:m,details:u}){const i=m?.percent??0,b=i>=100?"text-emerald-600":i>=75?"text-amber-600":i>=50?"text-orange-500":"text-rose-500",v=i>=100?"bg-emerald-500":i>=75?"bg-amber-500":i>=50?"bg-orange-400":"bg-rose-500";return e.jsxs("div",{className:"bg-white rounded-xl shadow-sm p-6 border border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-700",children:d}),e.jsxs("span",{className:`text-2xl font-bold ${b}`,children:[i,"%"]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("div",{className:"flex justify-between text-sm mb-2",children:e.jsxs("span",{className:"text-gray-600",children:["Target: ",m?.target||0," attivazioni"]})}),e.jsx("div",{className:"h-2 bg-gray-100 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-2 ${v}`,style:{width:`${Math.min(i,100)}%`}})}),e.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:[m?.actual||0," / ",m?.target||0," attivazioni"]})]}),u&&u.length>0&&e.jsx("div",{className:"space-y-2 pt-4 border-t border-gray-100",children:u.map((s,y)=>e.jsxs("div",{className:"flex justify-between items-center text-xs",children:[e.jsx("span",{className:"text-gray-600",children:s.label}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`font-medium ${s.isRAPercentage?s.actual>=50?"text-emerald-600":"text-rose-600":""}`,children:s.showTarget===!1?`${s.actual||0} ${s.unit||"attivazioni"}`:`${s.actual||0} / ${s.target||0} ${s.unit||""}`}),s.showTarget===!1&&!s.isRAPercentage&&s.percent!=null&&s.percent>0&&e.jsxs("span",{className:"text-[10px] text-gray-400",children:["(",s.percent,"%)"]})]})]},y))})]})}function H(){const[d,m]=l.useState(null),[u,i]=l.useState(null),[b,v]=l.useState(null),{user:s}=S();l.useEffect(()=>{let r=!0;async function t(){try{const g=new Date().getFullYear(),h=new Date().getMonth()+1,a=encodeURIComponent((s?.agentenome||s?.name||"").toString()),[x,f,j]=await Promise.all([N("/agente/attivazioni-oggi"),N("/agente/ordini-attesa-pagamento-count"),N(`/agente/reportistica?year=${g}&month=${h}${a?`&agente=${a}`:""}`)]);if(!r)return;m(x?.totale??0),i(f?.totale??0);const n=j?.data?.kpi_card?.[0];v(n?.dealer_ingaggiati??0)}catch(g){console.error("[AgentDashboard] Errore caricamento KPI:",g),r&&(m(0),i(0),v(0))}}return t(),()=>{r=!1}},[s?.agentenome,s?.name]);const y=[{title:"Ordini in Attesa di pagamento",value:u??"â€”",subtitle:"Stato ordini = 0",icon:"ðŸ“¦",trend:"neutral",trendValue:"",color:"orange"},{title:"Dealer Attivi",value:b??"â€”",subtitle:"Dealer ingaggiati (mese corrente)",icon:"ðŸ‘¥",trend:"neutral",trendValue:"",color:"purple"}];return e.jsxs(E,{children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(D,{scope:"agente",agente:(s?.agentenome||s?.name||"").toString(),title:"News",maxItems:3}),y.filter(r=>r.title!=="Fatturato Mensile").map((r,t)=>e.jsx(C,{title:r.title,value:String(r.value),subtitle:r.subtitle,icon:r.icon,trend:r.trend,trendValue:r.trendValue,color:r.color},t))]}),e.jsx(z,{}),e.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-4",children:[e.jsx($,{}),e.jsx(O,{})]})]}),e.jsx(T,{})]})}export{H as default};
