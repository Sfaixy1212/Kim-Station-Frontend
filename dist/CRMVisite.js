import{r as o,j as e,ah as je,C as U,T as be,a9 as G,a6 as C,e as B,ai as fe,aj as Ne,ak as ye,al as ve,g as we,am as De,an as Se,f as Ae,ao as Ce,ap as ke,aq as X,ar as Te,as as Le,at as Y,au as Ie,av as te}from"./vendor.js";import{S as Pe}from"./Topbar2.js";import{g as M,p as Me}from"./index.js";delete te.Icon.Default.prototype._getIconUrl;te.Icon.Default.mergeOptions({iconRetinaUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon-2x.png",iconUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-icon.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png"});const V=r=>r?typeof r=="string"&&r.includes(":")?r.slice(0,5):r instanceof Date||typeof r=="object"?new Date(r).toLocaleTimeString("it-IT",{hour:"2-digit",minute:"2-digit"}):String(r).slice(0,5):"",Ve=r=>{if(!r)return"";const m=[];if(r.IndirizzoPoint&&m.push(r.IndirizzoPoint.trim()),r.CittaPoint||r.ProvinciaPoint){const d=(r.CittaPoint||"").trim(),u=(r.ProvinciaPoint||"").trim(),j=d&&u?`${d} (${u})`:d||u;j&&m.push(j)}return r.CapPoint&&m.push(`CAP ${String(r.CapPoint).trim()}`),m.join(" - ")},ee=r=>{const m=Ve(r);return m?e.jsxs("div",{className:"flex items-center space-x-2 text-xs md:text-sm text-gray-500 mt-1 truncate",children:[e.jsx(C,{className:"w-4 h-4"}),e.jsx("span",{className:"truncate",children:m})]}):null};function Fe(){const[r,m]=o.useState([]),[d,u]=o.useState(null),[j,k]=o.useState(!0),[w,D]=o.useState(null),[S,b]=o.useState(!1),[h,z]=o.useState(""),[f,x]=o.useState(""),[N,se]=o.useState(""),[y,re]=o.useState(""),[T,ae]=o.useState(""),[L,ne]=o.useState(""),[ie,le]=o.useState([]),[oe,ce]=o.useState([]),[p,O]=o.useState(null),[de,q]=o.useState(null),[I,_]=o.useState(!1),[Oe,K]=o.useState(!1),[R,W]=o.useState({}),[P,Z]=o.useState(!0),[E,H]=o.useState(new Date);o.useEffect(()=>{J(),O(null),q(null),_(!1)},[h,f,N,y,T,L]);const J=async()=>{k(!0);try{const t=new URLSearchParams;h&&t.append("idAgente",h),f&&t.append("idDealer",f),N&&t.append("month",N),y&&t.append("year",y),T&&t.append("stato",T),L&&t.append("argomento",L);const a=await M(`/supermaster/crm-visite?${t.toString()}`);if(m(a||[]),a&&a.length>0){const l=new Map,c=new Map;a.forEach(i=>{i.IDAgente&&i.NomeAgente&&l.set(i.IDAgente,i.NomeAgente),i.IDDealer&&i.RagioneSocialeDealer&&c.set(i.IDDealer,i.RagioneSocialeDealer)}),le(Array.from(l,([i,g])=>({id:i,nome:g}))),ce(Array.from(c,([i,g])=>({id:i,nome:g})))}if(N&&y){const l=await M(`/supermaster/crm-visite/statistiche?month=${N}&year=${y}`);u(l||null)}else u(null)}catch(t){console.error("Errore caricamento dati CRM:",t)}finally{k(!1)}},$=t=>{const a=Math.floor(t/60),l=t%60;return a===0?`${l}min`:l===0?`${a}h`:`${a}h ${l}min`},xe=t=>t<60?"bg-green-50 border-green-200 text-green-700":t<=120?"bg-yellow-50 border-yellow-200 text-yellow-700":"bg-red-50 border-red-200 text-red-700",F=async t=>{try{const a=await M(`/supermaster/crm-visite/${t.ID}`);D(a),b(!0)}catch(a){console.error("Errore caricamento dettaglio:",a)}},me=async(t,a)=>{if(!(!t||!a)){K(!0);try{const l=await M(`/supermaster/crm-visite/percorso/${t}?data=${a}`);O(l);const c={};l?.percorso?.forEach(i=>{i.tipo==="VISITA"&&i.visitaId&&(c[i.visitaId]={kmDaPrecedente:i.kmDaPrecedente,kmProgressivi:i.kmProgressivi})}),W(c)}catch(l){console.error("Errore caricamento percorso:",l),O(null),W({})}finally{K(!1)}}},ge=t=>{const a=new Date(t),l=a.getDay(),c=a.getDate()-l+(l===0?-6:1),i=new Date(a.setDate(c)),g=[];for(let s=0;s<7;s++){const n=new Date(i);n.setDate(i.getDate()+s),g.push(n)}return g},A=o.useMemo(()=>ge(E),[E]),v=o.useMemo(()=>{const t={};return r.forEach(a=>{let l=a.DataVisita.split("T")[0];t[l]||(t[l]=[]),t[l].push(a)}),Object.keys(t).forEach(a=>{t[a].sort((l,c)=>{const i=l.OraInizio||"00:00",g=c.OraInizio||"00:00";return i.localeCompare(g)})}),t},[r]),he=o.useMemo(()=>{const t={};return A.forEach(a=>{const l=a.toISOString().split("T")[0];t[l]=v[l]||[]}),t},[A,v]),Q=t=>{const a=new Date(E);a.setDate(a.getDate()+t*7),H(a)},ue=()=>{if(r.length===0){alert("Nessuna visita da esportare");return}const t=r.map(n=>({Data:new Date(n.DataVisita).toLocaleDateString("it-IT"),Ora:n.OraInizio?.slice(0,5)||"",Agente:n.NomeAgente||"",Dealer:n.RagioneSocialeDealer||"","Durata (min)":n.DurataMinuti||0,Referente:n.Referente||"",Argomento:n.Argomento||"",Stato:n.StatoVisita||"",Note:n.Note||"",Latitudine:n.Latitudine||"",Longitudine:n.Longitudine||""})),a=Object.keys(t[0]),l=[a.join(";"),...t.map(n=>a.map(pe=>`"${n[pe]}"`).join(";"))].join(`
`),c=new Blob(["\uFEFF"+l],{type:"text/csv;charset=utf-8;"}),i=document.createElement("a"),g=URL.createObjectURL(c),s=`visite_crm_${new Date().toISOString().split("T")[0]}.csv`;i.setAttribute("href",g),i.setAttribute("download",s),i.style.visibility="hidden",document.body.appendChild(i),i.click(),document.body.removeChild(i)};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(Pe,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"ðŸ—ºï¸ CRM Visite Agenti"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Monitora e gestisci tutte le visite degli agenti ai dealer"})]}),e.jsxs("button",{onClick:ue,disabled:r.length===0,className:"flex items-center space-x-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:[e.jsx(je,{className:"w-4 h-4"}),e.jsx("span",{children:"Esporta Report CSV"})]})]}),d&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4",children:[e.jsx("div",{className:"bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-4 border border-blue-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-blue-600 font-medium",children:"Visite Totali"}),e.jsx("p",{className:"text-2xl font-bold text-blue-900",children:d.globali?.TotaleVisite||0})]}),e.jsx(U,{className:"w-8 h-8 text-blue-600 opacity-50"})]})}),e.jsx("div",{className:"bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-4 border border-green-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-green-600 font-medium",children:"Completate"}),e.jsx("p",{className:"text-2xl font-bold text-green-900",children:d.globali?.VisiteCompletate||0})]}),e.jsx(be,{className:"w-8 h-8 text-green-600 opacity-50"})]})}),e.jsx("div",{className:"bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-4 border border-purple-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-purple-600 font-medium",children:"Agenti Attivi"}),e.jsx("p",{className:"text-2xl font-bold text-purple-900",children:d.globali?.AgentiAttivi||0})]}),e.jsx(G,{className:"w-8 h-8 text-purple-600 opacity-50"})]})}),e.jsx("div",{className:"bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-4 border border-orange-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-orange-600 font-medium",children:"Dealer Visitati"}),e.jsx("p",{className:"text-2xl font-bold text-orange-900",children:d.globali?.DealerVisitati||0})]}),e.jsx(C,{className:"w-8 h-8 text-orange-600 opacity-50"})]})}),e.jsx("div",{className:"bg-gradient-to-br from-pink-50 to-pink-100 rounded-xl p-4 border border-pink-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-pink-600 font-medium",children:"Ore Totali"}),e.jsxs("p",{className:"text-2xl font-bold text-pink-900",children:[Math.round((d.globali?.MinutiTotali||0)/60),"h"]})]}),e.jsx(B,{className:"w-8 h-8 text-pink-600 opacity-50"})]})})]}),e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-4",children:[e.jsx(fe,{className:"w-5 h-5 text-gray-600"}),e.jsx("h2",{className:"text-lg font-bold text-gray-900",children:"Filtri"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Agente"}),e.jsxs("select",{value:h,onChange:t=>z(t.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Tutti"}),ie.map(t=>e.jsx("option",{value:t.id,children:t.nome},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Dealer"}),e.jsxs("select",{value:f,onChange:t=>x(t.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Tutti"}),oe.map(t=>e.jsx("option",{value:t.id,children:t.nome},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Mese"}),e.jsxs("select",{value:N,onChange:t=>se(t.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Tutti"}),["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"].map((t,a)=>e.jsx("option",{value:a+1,children:t},a))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Anno"}),e.jsxs("select",{value:y,onChange:t=>re(t.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Tutti"}),[2024,2025,2026].map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Stato"}),e.jsxs("select",{value:T,onChange:t=>ae(t.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500",children:[e.jsx("option",{value:"",children:"Tutti"}),e.jsx("option",{value:"PROGRAMMATA",children:"Programmata"}),e.jsx("option",{value:"COMPLETATA",children:"Completata"}),e.jsx("option",{value:"ANNULLATA",children:"Annullata"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Argomento"}),e.jsx("input",{type:"text",value:L,onChange:t=>ne(t.target.value),placeholder:"Cerca...",className:"w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500"})]})]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-white rounded-xl shadow-sm border border-gray-200 p-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs("button",{onClick:()=>Z(!0),className:`flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${P?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:[e.jsx(Ne,{className:"w-4 h-4"}),e.jsx("span",{children:"Vista Calendario"})]}),e.jsxs("button",{onClick:()=>Z(!1),className:`flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors ${P?"bg-gray-100 text-gray-700 hover:bg-gray-200":"bg-blue-600 text-white"}`,children:[e.jsx(ye,{className:"w-4 h-4"}),e.jsx("span",{children:"Vista Lista"})]})]}),P&&e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("button",{onClick:()=>Q(-1),className:"p-2 rounded-lg hover:bg-gray-100 transition-colors",title:"Settimana precedente",children:e.jsx(ve,{className:"w-5 h-5 text-gray-700"})}),e.jsxs("span",{className:"text-sm font-medium text-gray-700",children:[A[0]?.toLocaleDateString("it-IT",{day:"numeric",month:"short"})," - ",A[6]?.toLocaleDateString("it-IT",{day:"numeric",month:"long",year:"numeric"})]}),e.jsx("button",{onClick:()=>Q(1),className:"p-2 rounded-lg hover:bg-gray-100 transition-colors",title:"Settimana successiva",children:e.jsx(we,{className:"w-5 h-5 text-gray-700"})}),e.jsx("button",{onClick:()=>H(new Date),className:"px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors",children:"Oggi"})]})]}),P?e.jsx("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 p-6",children:e.jsx("div",{className:"grid grid-cols-7 gap-3",children:A.map((t,a)=>{const l=t.toISOString().split("T")[0],c=he[l]||[],i=l===new Date().toISOString().split("T")[0],g=t.toLocaleDateString("it-IT",{weekday:"short"}),s=t.getDate();return e.jsxs("div",{className:`flex flex-col border rounded-lg overflow-hidden ${i?"border-blue-500 ring-2 ring-blue-100":"border-gray-200"}`,children:[e.jsxs("div",{className:`p-3 text-center ${i?"bg-blue-600 text-white":"bg-gray-50"}`,children:[e.jsx("div",{className:"text-xs font-medium uppercase",children:g}),e.jsx("div",{className:"text-2xl font-bold",children:s}),c.length>0&&e.jsxs("div",{className:`text-xs mt-1 ${i?"text-blue-100":"text-gray-600"}`,children:[c.length," visit",c.length!==1?"e":"a"]})]}),e.jsx("div",{className:"flex-1 p-2 space-y-2 bg-gray-50 min-h-[300px] max-h-[500px] overflow-y-auto",children:c.length===0?e.jsx("div",{className:"text-center text-xs text-gray-400 mt-4",children:"Nessuna visita"}):c.map(n=>e.jsxs("div",{onClick:()=>F(n),className:`p-2 rounded-lg border cursor-pointer transition-all hover:shadow-md ${n.StatoVisita==="COMPLETATA"?"bg-green-50 border-green-200 hover:bg-green-100":n.StatoVisita==="ANNULLATA"?"bg-red-50 border-red-200 hover:bg-red-100":"bg-white border-gray-200 hover:bg-gray-50"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-1",children:[e.jsx("span",{className:"text-xs font-bold text-gray-900",children:V(n.OraInizio)}),e.jsx("span",{className:`text-[10px] px-1.5 py-0.5 rounded-full ${n.StatoVisita==="COMPLETATA"?"bg-green-100 text-green-700":n.StatoVisita==="ANNULLATA"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:n.StatoVisita==="COMPLETATA"?"âœ“":n.StatoVisita==="ANNULLATA"?"âœ—":"â—‹"})]}),e.jsx("div",{className:"text-xs font-medium text-gray-900 line-clamp-2 mb-1",children:n.RagioneSocialeDealer}),n.CittaPoint&&e.jsxs("div",{className:"text-[10px] text-gray-600 flex items-center",children:[e.jsx(C,{className:"w-3 h-3 mr-1"}),n.CittaPoint]}),n.NomeAgente&&e.jsxs("div",{className:"text-[10px] text-gray-500 mt-1",children:["ðŸ‘¤ ",n.NomeAgente]})]},n.ID))})]},a)})})}):e.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200",children:[e.jsx("div",{className:"p-6 border-b border-gray-200",children:e.jsxs("h2",{className:"text-lg font-bold text-gray-900",children:["Visite (",r.length,")",h&&Object.keys(v).length>0&&e.jsxs("span",{className:"ml-2 text-sm font-normal text-gray-600",children:["â€¢ ",Object.keys(v).length," giorni"]})]})}),j?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"Caricamento..."}):r.length===0?e.jsx("div",{className:"p-8 text-center text-gray-500",children:"Nessuna visita trovata"}):h?e.jsx("div",{className:"divide-y divide-gray-200",children:Object.keys(v).sort().reverse().map(t=>{const a=v[t],[l,c,i]=t.split("-").map(Number),g=new Date(l,c-1,i);return e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx(U,{className:"w-5 h-5 text-blue-600"}),e.jsx("h3",{className:"text-lg font-bold text-gray-900",children:g.toLocaleDateString("it-IT",{weekday:"long",day:"numeric",month:"long",year:"numeric"})}),e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded",children:[a.length," ",a.length===1?"visita":"visite"]})]}),e.jsxs("button",{onClick:()=>{q(t),me(h,t)},className:"flex items-center space-x-2 px-3 py-1.5 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(C,{className:"w-4 h-4"}),e.jsx("span",{children:"Calcola Percorso"})]})]}),p&&de===t&&e.jsxs("div",{className:"mb-4 p-4 bg-green-50 border border-green-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"font-bold text-green-900",children:"ðŸ“ Percorso Giornaliero"}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("button",{onClick:()=>_(!I),className:"flex items-center gap-2 px-3 py-1.5 text-sm bg-white border border-green-300 rounded-lg hover:bg-green-50 transition-colors",children:[e.jsx(De,{className:"w-4 h-4"}),I?"Nascondi":"Mostra"," Mappa",I?e.jsx(Se,{className:"w-4 h-4"}):e.jsx(Ae,{className:"w-4 h-4"})]}),e.jsxs("span",{className:"text-lg font-bold text-green-700",children:[p.kmTotali," km totali"]})]})]}),I&&e.jsx("div",{className:"mb-4 rounded-lg overflow-hidden border border-green-300",style:{height:"400px"},children:e.jsxs(Ce,{bounds:p.percorso.filter(s=>s.latitudine&&s.longitudine).map(s=>[s.latitudine,s.longitudine]),scrollWheelZoom:!0,style:{height:"100%",width:"100%"},children:[e.jsx(ke,{attribution:'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),p.routeGeometry&&p.routeGeometry.length>0?e.jsx(X,{positions:p.routeGeometry.map(s=>[s[1],s[0]]),color:"#16a34a",weight:4,opacity:.8}):e.jsx(X,{positions:p.percorso.filter(s=>s.latitudine&&s.longitudine).map(s=>[s.latitudine,s.longitudine]),color:"#16a34a",weight:3,opacity:.7,dashArray:"5, 10"}),p.percorso.map((s,n)=>!s.latitudine||!s.longitudine?null:e.jsx(Te,{position:[s.latitudine,s.longitudine],children:e.jsx(Le,{children:e.jsxs("div",{className:"text-sm",children:[e.jsxs("div",{className:"font-bold text-green-700 mb-1",children:[n,". ",s.tipo==="VISITA"&&s.citta||s.descrizione]}),s.tipo==="VISITA"&&e.jsxs(e.Fragment,{children:[s.ragioneSociale&&e.jsx("div",{className:"text-gray-600 text-xs mb-1",children:s.ragioneSociale}),s.indirizzo&&e.jsx("div",{className:"text-gray-500 text-xs mb-1",children:s.indirizzo}),s.ora&&e.jsxs("div",{className:"text-gray-600 text-xs",children:["ðŸ• ",s.ora]}),s.referente&&e.jsxs("div",{className:"text-gray-600 text-xs",children:["ðŸ‘¤ ",s.referente]})]}),e.jsx("div",{className:"text-green-600 font-medium text-xs mt-1",children:s.kmDaPrecedente>0&&`+${s.kmDaPrecedente} km`})]})})},n))]})}),e.jsx("div",{className:"space-y-2",children:p.percorso.map((s,n)=>e.jsxs("div",{className:"flex items-center space-x-3 text-sm",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center font-bold",children:n}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"font-medium text-gray-900",children:s.tipo==="VISITA"?e.jsxs(e.Fragment,{children:[s.citta||s.descrizione,s.ragioneSociale&&s.citta&&e.jsxs("span",{className:"text-gray-600 font-normal text-xs ml-2",children:["â†’ ",s.ragioneSociale]})]}):s.descrizione}),s.tipo==="VISITA"&&s.indirizzo&&e.jsx("p",{className:"text-gray-500 text-xs mt-0.5",children:s.indirizzo}),s.ora&&e.jsxs("p",{className:"text-gray-600",children:["ðŸ• ",s.ora]}),s.warning&&e.jsxs("p",{className:"text-orange-600 text-xs mt-1",children:["âš ï¸ ",s.warning]})]}),e.jsxs("div",{className:"text-right",children:[s.kmDaPrecedente>0&&e.jsxs("p",{className:"text-green-700 font-medium",children:["+",s.kmDaPrecedente," km"]}),e.jsxs("p",{className:"text-gray-600 text-xs",children:[s.kmProgressivi," km tot"]})]})]},n))})]}),e.jsx("div",{className:"space-y-2",children:a.map(s=>e.jsx("div",{onClick:()=>F(s),className:"p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"flex items-center space-x-3 mb-2",children:e.jsx("span",{className:"font-semibold text-gray-900",children:s.RagioneSocialeDealer})}),ee(s),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-gray-600",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsxs("span",{children:[V(s.OraInizio)," (",$(s.DurataMinuti),")"]})]}),s.Referente&&e.jsxs("div",{className:"flex items-center space-x-2 text-gray-600",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{children:s.Referente})]}),s.NumCommenti>0&&e.jsxs("div",{className:"flex items-center space-x-2 text-blue-600",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.NumCommenti," commenti"]})]})]}),s.Argomento&&e.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:["ðŸ’¬ ",s.Argomento]})]}),e.jsx("div",{className:"flex flex-col items-end space-y-2",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${s.StatoVisita==="COMPLETATA"?"bg-green-100 text-green-700":s.StatoVisita==="ANNULLATA"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:s.StatoVisita})})]})},s.ID))})]},t)})}):e.jsx("div",{className:"divide-y divide-gray-200",children:r.map(t=>e.jsx("div",{onClick:()=>F(t),className:"p-4 hover:bg-gray-50 cursor-pointer transition-colors",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx("span",{className:"font-semibold text-gray-900",children:t.NomeAgente}),e.jsx("span",{className:"text-gray-400",children:"â†’"}),e.jsx("span",{className:"text-gray-700",children:t.RagioneSocialeDealer})]}),ee(t),R[t.ID]&&e.jsxs("div",{className:"text-xs md:text-sm text-green-600 mt-1",children:["+",R[t.ID].kmDaPrecedente," km â€¢ ",R[t.ID].kmProgressivi," km totali"]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 text-sm",children:[e.jsxs("div",{className:"flex items-center space-x-2 text-gray-600",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsx("span",{children:new Date(t.DataVisita).toLocaleDateString("it-IT")})]}),e.jsxs("div",{className:"flex items-center space-x-2 text-gray-600",children:[e.jsx(B,{className:"w-4 h-4"}),e.jsxs("span",{children:[V(t.OraInizio)," (",$(t.DurataMinuti),")"]})]}),t.Referente&&e.jsxs("div",{className:"flex items-center space-x-2 text-gray-600",children:[e.jsx(G,{className:"w-4 h-4"}),e.jsx("span",{children:t.Referente})]}),t.NumCommenti>0&&e.jsxs("div",{className:"flex items-center space-x-2 text-blue-600",children:[e.jsx(Y,{className:"w-4 h-4"}),e.jsxs("span",{children:[t.NumCommenti," commenti"]})]})]}),t.Argomento&&e.jsxs("div",{className:"mt-2 text-sm text-gray-600",children:["ðŸ’¬ ",t.Argomento]})]}),e.jsxs("div",{className:"flex flex-col items-end space-y-2",children:[e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${t.StatoVisita==="COMPLETATA"?"bg-green-100 text-green-700":t.StatoVisita==="ANNULLATA"?"bg-red-100 text-red-700":"bg-yellow-100 text-yellow-700"}`,children:t.StatoVisita}),e.jsx("span",{className:`px-2 py-1 rounded text-xs ${xe(t.DurataMinuti)}`,children:$(t.DurataMinuti)})]})]})},t.ID))})]}),S&&w&&e.jsx(ze,{visita:w,onClose:()=>{b(!1),D(null),J()}})]})]})}function ze({visita:r,onClose:m}){const[d,u]=o.useState(""),[j,k]=o.useState("NOTA"),[w,D]=o.useState(!1),S=r.visita.LatitudineDispositivo,b=r.visita.LongitudineDispositivo,h=S&&b,z=h?`https://www.google.com/maps?q=${S},${b}`:null,f=async()=>{if(d.trim()){D(!0);try{await Me(`/supermaster/crm-visite/${r.visita.ID}/commenti`,{commento:d,tipoCommento:j}),u(""),alert("Commento aggiunto con successo!"),m()}catch(x){console.error("Errore aggiunta commento:",x),alert("Errore nell'aggiunta del commento")}finally{D(!1)}}};return e.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4",children:[e.jsx("div",{className:"absolute inset-0 bg-black/30",onClick:m}),e.jsxs("div",{className:"relative bg-white rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx("div",{className:"sticky top-0 bg-gradient-to-r from-blue-600 to-blue-700 text-white px-6 py-4 rounded-t-xl",children:e.jsx("h2",{className:"text-xl font-bold",children:"Dettaglio Visita"})}),e.jsxs("div",{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Agente:"}),e.jsx("p",{className:"font-semibold",children:r.visita.NomeAgente})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Dealer:"}),e.jsx("p",{className:"font-semibold",children:r.visita.RagioneSocialeDealer})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Data:"}),e.jsx("p",{className:"font-semibold",children:new Date(r.visita.DataVisita).toLocaleDateString("it-IT")})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Ora:"}),e.jsx("p",{className:"font-semibold",children:V(r.visita.OraInizio)})]}),r.visita.Referente&&e.jsxs("div",{children:[e.jsx("span",{className:"text-gray-600",children:"Referente:"}),e.jsx("p",{className:"font-semibold",children:r.visita.Referente})]}),r.visita.Argomento&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-gray-600",children:"Argomento:"}),e.jsx("p",{className:"font-semibold",children:r.visita.Argomento})]}),r.visita.Note&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-gray-600",children:"Note:"}),e.jsx("p",{className:"text-gray-700",children:r.visita.Note})]})]}),e.jsxs("div",{className:"p-4 bg-gray-50 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[e.jsx(C,{className:"w-4 h-4 text-gray-600"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:"Posizione registrazione dispositivo"})]}),h?e.jsxs("div",{className:"text-sm text-gray-700 space-y-1",children:[e.jsxs("p",{children:["Latitudine: ",e.jsx("span",{className:"font-mono",children:Number(S).toFixed(6)})]}),e.jsxs("p",{children:["Longitudine: ",e.jsx("span",{className:"font-mono",children:Number(b).toFixed(6)})]}),e.jsxs("a",{href:z,target:"_blank",rel:"noreferrer",className:"inline-flex items-center space-x-1 text-blue-600 hover:underline text-sm",children:[e.jsx("span",{children:"Apri su Google Maps"}),e.jsx(Ie,{className:"w-3 h-3"})]})]}):e.jsx("p",{className:"text-sm text-gray-500",children:"Posizione non registrata per questa visita."})]}),r.commenti&&r.commenti.length>0&&e.jsxs("div",{children:[e.jsxs("h3",{className:"font-bold text-gray-900 mb-3",children:["Commenti (",r.commenti.length,")"]}),e.jsx("div",{className:"space-y-3",children:r.commenti.map(x=>e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 border border-gray-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"font-medium text-sm",children:x.NomeUtente}),e.jsx("span",{className:`text-xs px-2 py-1 rounded ${x.TipoCommento==="REMINDER"?"bg-yellow-100 text-yellow-700":x.TipoCommento==="FEEDBACK"?"bg-green-100 text-green-700":"bg-blue-100 text-blue-700"}`,children:x.TipoCommento})]}),e.jsx("p",{className:"text-sm text-gray-700",children:x.Commento}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:new Date(x.CreatoIl).toLocaleString("it-IT")})]},x.ID))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-gray-900 mb-3",children:"Aggiungi Commento"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("select",{value:j,onChange:x=>k(x.target.value),className:"w-full border border-gray-300 rounded-lg px-3 py-2",children:[e.jsx("option",{value:"NOTA",children:"Nota"}),e.jsx("option",{value:"REMINDER",children:"Reminder"}),e.jsx("option",{value:"FEEDBACK",children:"Feedback"})]}),e.jsx("textarea",{value:d,onChange:x=>u(x.target.value),placeholder:"Scrivi un commento...",rows:4,className:"w-full border border-gray-300 rounded-lg px-3 py-2 resize-none"}),e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("button",{onClick:m,className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50",children:"Chiudi"}),e.jsx("button",{onClick:f,disabled:w||!d.trim(),className:"flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50",children:w?"Salvataggio...":"Aggiungi Commento"})]})]})]})]})]})]})}export{Fe as default};
