import{r as a,j as t}from"./vendor.js";import{b as _,a as B,D as q}from"./DashboardLayout.js";import"./index.js";import"./logo2.js";function X(){const[i,n]=a.useState([]),y=a.useRef(null),[F,f]=a.useState(!1),N=a.useRef(null),[j,v]=a.useState(!1),[C,c]=a.useState(""),[m,M]=a.useState(""),[d,P]=a.useState(""),[u,z]=a.useState(""),[x,A]=a.useState(String(new Date().getFullYear())),E=a.useMemo(()=>["Gennaio","Febbraio","Marzo","Aprile","Maggio","Giugno","Luglio","Agosto","Settembre","Ottobre","Novembre","Dicembre"],[]),R=a.useMemo(()=>{const e=new Date().getFullYear();return Array.from({length:6},(s,l)=>String(e-l))},[]),O=a.useCallback(()=>{typeof window<"u"&&!window.matchMedia("(min-width: 1280px)").matches&&N.current?.scrollIntoView({behavior:"smooth",block:"start"})},[]),b=a.useCallback(e=>{const s=Array.from(e).map(l=>({file:l,progress:0,status:"pending"}));n(l=>[...l,...s])},[]),L=a.useCallback(e=>{e.preventDefault(),e.stopPropagation(),f(!1),e.dataTransfer?.files?.length&&b(e.dataTransfer.files)},[b]),U=a.useCallback(e=>{e.preventDefault(),e.stopPropagation(),f(!0)},[]),I=a.useCallback(e=>{e.preventDefault(),e.stopPropagation(),f(!1)},[]),w=a.useCallback(e=>{const s=(e||"").toLowerCase(),l={gennaio:"01",febbraio:"02",marzo:"03",aprile:"04",maggio:"05",giugno:"06",luglio:"07",agosto:"08",settembre:"09",ottobre:"10",novembre:"11",dicembre:"12"};if(l[s])return l[s];const r=String(e).padStart(2,"0");return/^(0[1-9]|1[0-2])$/.test(r)?r:""},[]),T=a.useCallback(async()=>{if(c(""),!m||!d||!u||!x){c("Compila tutti i campi obbligatori.");return}if(i.length===0){c("Seleziona almeno un file.");return}const e=w(u);if(!e){c("Mese non valido.");return}try{v(!0),n(r=>r.map(o=>({...o,status:"uploading",progress:0})));const s=new FormData;i.forEach(r=>s.append("files",r.file)),s.append("orderNumber",d.trim()),s.append("contractMonth",e),s.append("contractYear",String(x)),s.append("customerName",m.trim());const l=await _("/api/contratti/upload",s,{onUploadProgress:r=>{if(!r.total)return;const o=Math.round(r.loaded*100/r.total);n($=>$.map(V=>({...V,progress:o})))}});n(r=>r.map(o=>({...o,status:"done",progress:100}))),await g(),setTimeout(()=>n([]),600)}catch(s){const l=s.normalized||s;c(l?.message||"Errore upload"),n(r=>r.map(o=>({...o,status:"pending"})))}finally{v(!1)}},[i,m,d,u,x,w]),H=a.useCallback(()=>n([]),[]),G=a.useCallback(e=>n(s=>s.filter((l,r)=>r!==e)),[]),[S,Y]=a.useState([]),[h,k]=a.useState(!1),[p,D]=a.useState(""),g=a.useCallback(async()=>{try{D(""),k(!0);const e=await B.get("/api/contratti"),s=Array.isArray(e.data)?e.data:[];Y(s)}catch(e){const s=e.normalized||e;D(s?.message||"Errore caricamento storico")}finally{k(!1)}},[]);return a.useEffect(()=>{g()},[g]),t.jsx(q,{title:"Upload",children:t.jsxs("div",{className:"grid grid-cols-1 xl:grid-cols-2 gap-6",children:[t.jsxs("section",{className:"bg-white rounded-xl p-4 sm:p-6 mt-2 h-[calc(100vh-140px)] flex flex-col",children:[t.jsxs("div",{className:"flex items-center justify-between mb-4",children:[t.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Carica Contratti"}),t.jsx("button",{type:"button",onClick:O,className:"xl:hidden inline-flex items-center rounded-lg bg-gray-900 text-white px-3 py-1.5 text-xs sm:text-sm hover:bg-black/80 transition",title:"Visualizza Storico",children:"Visualizza Storico"})]}),t.jsxs("div",{className:"flex-1 min-h-0 overflow-y-auto pr-1 sm:pr-2 flex flex-col gap-6",children:[t.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-5",children:[t.jsxs("div",{className:"sm:col-span-2",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Nome e Cognome Intestatario Contratto *"}),t.jsx("input",{type:"text",value:m,onChange:e=>M(e.target.value),placeholder:"Mario Rossi",className:"mt-1 w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600 text-sm"})]}),t.jsxs("div",{className:"sm:col-span-2",children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Numero Ordine (es. OR-00123) *"}),t.jsx("input",{type:"text",value:d,onChange:e=>P(e.target.value),placeholder:"OR-00123",className:"mt-1 w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600 text-sm"})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Mese Contratto *"}),t.jsxs("select",{value:u,onChange:e=>z(e.target.value),className:"mt-1 w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600 text-sm",children:[t.jsx("option",{value:"",children:"Seleziona mese"}),E.map(e=>t.jsx("option",{value:e,children:e},e))]})]}),t.jsxs("div",{children:[t.jsx("label",{className:"text-sm font-medium text-gray-700",children:"Anno Contratto *"}),t.jsx("select",{value:x,onChange:e=>A(e.target.value),className:"mt-1 w-full rounded-lg border-gray-300 focus:border-blue-600 focus:ring-blue-600 text-sm",children:R.map(e=>t.jsx("option",{value:e,children:e},e))})]})]}),t.jsx("div",{className:"text-xs text-blue-700 bg-blue-50 border border-blue-100 rounded-md px-3 py-2",children:"Info: Seleziona uno o piÃ¹ file PDF o immagini (JPG, PNG). Altri formati non sono ammessi. Max 10MB ciascuno."}),t.jsx("div",{onDrop:L,onDragOver:U,onDragLeave:I,className:["border-2 border-dashed rounded-xl p-8 sm:p-10 text-center transition min-h-[300px] flex-1 flex items-center justify-center",F?"border-blue-500 bg-blue-50/40":"border-gray-200 hover:border-gray-300"].join(" "),children:t.jsxs("div",{className:"mx-auto max-w-md",children:[t.jsx("div",{className:"text-4xl mb-3",children:"ðŸ“¤"}),t.jsx("h4",{className:"text-base font-semibold text-gray-900 mb-1",children:"Trascina qui i file PDF e/o immagini"}),t.jsx("p",{className:"text-sm text-gray-500 mb-4",children:"Oppure clicca per selezionare dal dispositivo"}),t.jsxs("div",{className:"flex items-center justify-center gap-3",children:[t.jsx("button",{type:"button",onClick:()=>y.current?.click(),className:"inline-flex items-center rounded-lg bg-blue-600 px-4 py-2 text-white text-sm hover:bg-blue-700 transition",children:"Scegli file"}),i.length>0&&t.jsx("button",{type:"button",onClick:T,disabled:j,className:"inline-flex items-center rounded-lg bg-emerald-600 px-4 py-2 text-white text-sm hover:bg-emerald-700 transition disabled:opacity-60",children:j?"Caricamentoâ€¦":"Avvia upload"}),i.length>0&&t.jsx("button",{type:"button",onClick:H,className:"inline-flex items-center rounded-lg bg-gray-100 px-4 py-2 text-gray-700 text-sm hover:bg-gray-200 transition",children:"Pulisci"})]}),C&&t.jsx("div",{className:"mt-3 text-xs text-red-600",children:C}),t.jsx("input",{ref:y,type:"file",multiple:!0,accept:"application/pdf,image/jpeg,image/png",className:"hidden",onChange:e=>b(e.target.files)})]})}),i.length>0&&t.jsxs("div",{children:[t.jsx("h5",{className:"text-sm font-semibold text-gray-800 mb-3",children:"File selezionati"}),t.jsx("ul",{className:"space-y-3",children:i.map((e,s)=>t.jsxs("li",{className:"flex items-center justify-between gap-3 bg-gray-50 rounded-lg p-3",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsx("p",{className:"text-sm font-medium text-gray-900 truncate",children:e.file.name}),t.jsxs("p",{className:"text-xs text-gray-500",children:[(e.file.size/1024).toFixed(1)," KB"]})]}),t.jsx("div",{className:"flex-1 mx-3",children:t.jsx("div",{className:"h-2 bg-white rounded-full overflow-hidden border border-gray-200",children:t.jsx("div",{className:"h-full bg-blue-600 transition-all",style:{width:`${Math.round(e.progress)}%`}})})}),t.jsxs("div",{className:"flex items-center gap-2",children:[e.status==="done"&&t.jsx("span",{className:"text-xs text-emerald-600",children:"Completato"}),e.status==="uploading"&&t.jsx("span",{className:"text-xs text-blue-600 animate-pulse",children:"Caricamentoâ€¦"}),e.status==="pending"&&t.jsx("span",{className:"text-xs text-gray-500",children:"In attesa"}),t.jsx("button",{type:"button",onClick:()=>G(s),className:"text-gray-400 hover:text-red-600 text-sm",title:"Rimuovi",children:"âœ•"})]})]},s))})]})]})]}),t.jsxs("section",{ref:N,className:"bg-white rounded-xl p-4 sm:p-6 mt-2 h-[calc(100vh-140px)] flex flex-col scroll-mt-24",children:[t.jsx("h3",{className:"text-base font-semibold text-gray-900 mb-4",children:"Storico Caricamenti"}),t.jsxs("div",{className:"flex-1 overflow-y-auto pr-1 sm:pr-2",children:[h&&t.jsx("div",{className:"h-full flex items-center justify-center text-sm text-gray-500",children:"Caricamento storicoâ€¦"}),p&&t.jsxs("div",{className:"text-sm text-red-600 mb-2",children:[p," ",t.jsx("button",{onClick:g,className:"ml-2 text-gray-700 underline",children:"Riprova"})]}),!h&&!p&&S.length===0?t.jsx("div",{className:"h-full flex items-center justify-center text-sm text-gray-500",children:"Nessun caricamento effettuato"}):!h&&!p?t.jsx("ul",{className:"divide-y divide-gray-100",children:S.map((e,s)=>t.jsxs("li",{className:"py-3 flex items-center justify-between gap-4",children:[t.jsxs("div",{className:"min-w-0",children:[t.jsxs("p",{className:"text-sm font-medium text-gray-900 truncate",children:[e.NomeCliente||e.nomeCliente||e.CognomeCliente," Â· ",e.NumeroOrdine||e.CodiceProposta]}),t.jsxs("p",{className:"text-xs text-gray-500 truncate",children:[e.MeseContratto,"/",e.AnnoContratto," Â· ",e.NomeFile||e.nomeFile]}),t.jsxs("div",{className:"mt-1 flex flex-wrap items-center gap-2",children:[t.jsxs("span",{className:"inline-flex items-center rounded-full bg-gray-100 px-2 py-0.5 text-[11px] text-gray-700",children:["Stato: ",e.StatoEsteso||(e.Stato!=null?`Stato ${e.Stato}`:"N/D")]}),e.Note?t.jsxs("span",{title:e.Note,className:"inline-flex max-w-[420px] items-center rounded-full bg-amber-50 px-2 py-0.5 text-[11px] text-amber-700 truncate",children:["Note: ",e.Note]}):null]})]}),t.jsx("a",{href:e.S3PublicUrl||e.S3Url||(e.FullPath&&String(e.FullPath).startsWith("/contratti")?`https://contrattistation.s3.eu-west-1.amazonaws.com${e.FullPath}`:e.FullPath),target:"_blank",rel:"noreferrer",className:"text-xs rounded-full px-2 py-1 bg-emerald-50 text-emerald-700 hover:bg-emerald-100",children:"Apri PDF"})]},s))}):null]})]})]})})}export{X as default};
