import{r as b,j as l,d as Z}from"./vendor.js";import{C as ee}from"./Card.js";import{S as te}from"./Topbar2.js";import{g as U}from"./index.js";function ae(){const[j,z]=b.useState(!0),[A,T]=b.useState(""),[D,h]=b.useState({step:0,msg:"Caricamento…",progress:5}),M="sm-map-container",_=e=>new Promise((t,o)=>{const r=document.querySelector(`script[src="${e}"]`);if(r){r.addEventListener("load",t),r.addEventListener("error",o);return}const n=document.createElement("script");n.src=e,n.async=!0,n.defer=!0,n.onload=t,n.onerror=o,document.head.appendChild(n)}),q=e=>{const t=e.lat??e.latitude??e.Latitude??e.Latitudine??e.Lat,o=e.lng??e.longitude??e.Longitude??e.Longitudine??e.Lng;if(t==null||o==null)return null;const r=Number(t),n=Number(o);return Number.isFinite(r)&&Number.isFinite(n)?{lat:r,lng:n}:null},Q=e=>[e.Indirizzo||e.indirizzo,e.CAP||e.cap,e.Citta||e.Città||e.citta,e.Provincia||e.provincia,"Italia"].filter(Boolean).map(o=>String(o).trim()).filter(Boolean).join(", "),$="supermaster_geocode_cache_v1",X=720*60*60*1e3,O=()=>{try{return JSON.parse(localStorage.getItem($)||"{}")}catch{return{}}},K=e=>{try{localStorage.setItem($,JSON.stringify(e))}catch{}},Y=e=>{if(!e)return null;const o=O()[e];return!o||Date.now()-(o.ts||0)>X?null:{lat:o.lat,lng:o.lng}},B=(e,t)=>{if(!e||!t)return;const o=O();o[e]={lat:t.lat,lng:t.lng,ts:Date.now()},K(o)},G=async(e,t)=>{const r=[150,300,600,1200];for(let n=0;n<4;n++){try{const i=(await e.geocode({address:t}))?.results?.[0]?.geometry?.location;if(i)return{lat:i.lat(),lng:i.lng()}}catch(a){const i=a&&a.message||"";if(!/OVER_QUERY_LIMIT|RESOURCE_EXHAUSTED/i.test(i)&&n===3)throw a}await new Promise(a=>setTimeout(a,r[n]))}return null},W=(e,t)=>{const o=e.lat,r=e.lng,n=t.lat,a=t.lng,i=6371,d=g=>g*Math.PI/180,m=d(n-o),w=d(a-r),C=Math.sin(m/2),S=Math.sin(w/2),y=C*C+Math.cos(d(o))*Math.cos(d(n))*S*S,k=2*Math.atan2(Math.sqrt(y),Math.sqrt(1-y));return i*k},P=(e="#2563eb")=>({url:`data:image/svg+xml;utf-8,${encodeURIComponent(`<?xml version="1.0" ?><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="${e}" stroke-width="1.5"><path d="M12 22s8-4.5 8-12a8 8 0 1 0-16 0c0 7.5 8 12 8 12z" fill="${e}" stroke="${e}"/></svg>`)}`,scaledSize:new window.google.maps.Size(32,32),anchor:new window.google.maps.Point(16,30)}),J=(e,t)=>{const o=[],r=(a,i)=>{i==null||i===""||i==="NULL"||o.push(`<div><span style="color:#64748b">${a}:</span> <strong style="color:#111827">${String(i)}</strong></div>`)};if(r("Ragione Sociale",e.RagioneSociale||e.ragioneSociale||e.Dealer||e.NomeDealer||e.dealer),r("Cellulare",e.RecapitoCell||e.cell||e.Cell||e.RecapitoCellulare),r("StationCode",e.StationCode||e.stationCode),r("COMSY1",e.COMSY1),r("COMSY2",e.COMSY2),r("Agente",e.Agente||e.agente||e.NOME_AGENTE||e.nomeAgente),typeof t=="number"){const a=t<10?t.toFixed(2):t.toFixed(1);o.push(`<div><span style="color:#64748b">Distanza</span>: <strong style="color:#111827">${a} km da KIM srls</strong></div>`)}return`
      <div style="font-size:12px; line-height:1.3; max-width:260px">
        <div style="font-weight:600; color:#111827; margin-bottom:4px">${e.RagioneSociale||e.Dealer||e.NomeDealer||"Dealer"}</div>
        ${o.join("")}
      </div>
    `};return b.useEffect(()=>{let e=!0;return(async()=>{try{z(!0),h({step:1,msg:"Caricamento…",progress:10});const t=await U("/config/maps-key");if(!e)return;h({step:2,msg:"Sto preparando la mappa…",progress:20});const o=t?.apiKey||t?.key,r=t?.mapId||void 0;if(!o)throw new Error("API key Google Maps non configurata");if(await _(`https://maps.googleapis.com/maps/api/js?key=${encodeURIComponent(o)}&v=weekly`),await _("https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"),!e)return;h({step:3,msg:"Sto caricando i dealers…",progress:35});let n=document.getElementById(M);if(!n){n=document.createElement("div"),n.id=M,n.style.width="100%",n.style.height="70vh";const s=document.getElementById(`${M}-holder`);s&&s.appendChild(n)}const a=await U("/dealers/locations");if(!e)return;h({step:4,msg:"Sto posizionando i dealers sulla mappa…",progress:45});const i=new window.google.maps.Geocoder,d="Via Appia 324, 72100 Brindisi, Italia";let m=Y(d);if(!m){const s=await G(i,d);s&&(m=s,B(d,s))}const w=[],C=Array.isArray(a)?a:[],S=C.length||1;let y=0;for(const s of C){let c=q(s);if(!c){const u=Q(s);u&&(c=Y(u)||await G(i,u),c&&B(u,c))}if(c&&w.push({d:s,ll:c}),y+=1,e&&y%3===0){const u=Math.min(y/S,1),R=Math.floor(45+u*40);h(p=>({...p,progress:R}))}}const k=w[0]?.ll||{lat:41.1171,lng:16.8719},g=new window.google.maps.Map(n,{center:k,zoom:6,mapId:r});e&&h({step:5,msg:"Quasi pronto…",progress:90});const x=new window.google.maps.LatLngBounds,I=new window.google.maps.InfoWindow;let f=null,v=null,E=null;const F=(s,c)=>{try{I.setContent(c)}catch{}I.open({anchor:s,map:g})},L=()=>{try{I.close()}catch{}};g.addListener("click",()=>{f=null,L()});const N=w.map(({d:s,ll:c})=>{const u=!!(s.COMSY||s.Comsy||s.comsy||s.COMSY1||s.COMSY2),R=P(u?"#f97316":"#2563eb"),p=new window.google.maps.Marker({position:c,icon:R}),V=m?W(c,m):null,H=J(s,V);return p.addListener("mouseover",()=>{f&&f!==p||(E&&(clearTimeout(E),E=null),v=setTimeout(()=>F(p,H),120))}),p.addListener("mouseout",()=>{f!==p&&(v&&(clearTimeout(v),v=null),E=setTimeout(()=>L(),200))}),p.addListener("click",()=>{f===p?(f=null,L()):(f=p,F(p,H))}),x.extend(c),p});if(m){const s=new window.google.maps.Marker({position:m,map:g,title:"HQ • KIM srls",icon:P("#16a34a")});x.extend(m)}try{const s=window.markerClusterer?.MarkerClusterer||window.MarkerClusterer;s?new s({map:g,markers:N}):N.forEach(c=>c.setMap(g))}catch{N.forEach(s=>s.setMap(g))}if(!x.isEmpty&&(typeof x.isEmpty!="function"||!x.isEmpty())&&g.fitBounds(x),!e)return;T(w.length?"":"Nessun dealer con coordinate disponibili."),h({step:6,msg:"Fatto!",progress:100})}catch(t){console.error("[SuperMaster][Geo] Errore mappa:",t),e&&T(t.message||"Errore nella mappa")}finally{e&&z(!1)}})(),()=>{e=!1}},[]),l.jsxs(l.Fragment,{children:[l.jsx(te,{}),l.jsxs("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6 space-y-4",children:[l.jsxs("div",{className:"flex items-center justify-between",children:[l.jsx("h1",{className:"text-xl font-semibold text-gray-900",children:"Geolocalizzazione Dealer"}),l.jsx(Z,{to:"/supermaster",className:"px-3 py-2 text-sm rounded-md bg-gray-100 hover:bg-gray-200 text-gray-700",children:"Torna a SuperMaster"})]}),l.jsxs(ee,{title:"Mappa",subtitle:"Dealer su Google Maps (cluster, info e distanza da HQ)",children:[A&&l.jsx("div",{className:"text-xs text-red-600 mb-2",children:A}),j&&l.jsxs("div",{className:"flex items-center gap-3 text-xs text-gray-500 mb-2",children:[l.jsx("span",{children:D.msg}),l.jsx("div",{className:"w-40 h-2 bg-gray-200 rounded overflow-hidden",children:l.jsx("div",{className:"h-2 bg-blue-600 transition-all duration-300",style:{width:`${Math.min(D.progress,100)}%`}})})]}),l.jsx("div",{id:`${M}-holder`,className:"bg-white border border-gray-200 rounded-lg shadow-sm p-2",children:!j&&l.jsx("div",{className:"text-xs text-gray-400 px-2 pb-2",children:"Mappa interattiva"})})]})]})]})}export{ae as default};
