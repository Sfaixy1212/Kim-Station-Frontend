import{r as o,z as L,j as e}from"./vendor.js";import{D as O}from"./DashboardLayout.js";import{u as C,g as F}from"./index.js";import"./logo2.js";function K(){const{user:a}=C(),s=new Date().getFullYear(),[i,c]=o.useState(s),[b,f]=o.useState(!1),[p,E]=o.useState(null),[d,U]=o.useState({fastweb:{},sky:{},sim:{}}),[w,N]=o.useState(""),[m,S]=o.useState(""),[B,j]=o.useState(!1),[R,P]=o.useState({tlc:null,energy:null});o.useEffect(()=>{let l=!0;return(async()=>{try{const n=await F("/agente/reportistica/last-updates"),x=n?.data?.data||n?.data||{};if(!l)return;P({tlc:x.tlc||null,energy:x.energy||null})}catch(n){console.warn("[ReportisticaV3] last-updates errore:",n?.message)}})(),()=>{l=!1}},[]),o.useEffect(()=>{let l=!0;return(async()=>{try{f(!0),E(null);const n=new URLSearchParams({year:String(i)});m&&m.trim()&&n.set("dealer",m.trim());const x=`/agente/reportistica/v3?${n.toString()}`;console.log("[ReportisticaV3] Chiamando API:",x);const h=(await F(x))?.data||{};l&&(U({fastweb:h.fastweb||{totale:{},dealers:[]},sky:h.sky||{totale:{},dealers:[]},sim:h.sim||{aggregated:{},details:[]}}),console.log("[ReportisticaV3] Dati caricati:",h))}catch(n){console.error("[ReportisticaV3] Errore:",n),l&&(E(n.message||"Errore nel caricamento"),L.error("Errore nel caricamento dati"))}finally{l&&f(!1)}})(),()=>{l=!1}},[i,m]);const v=o.useMemo(()=>{const l=(w||"").trim().toLowerCase();if(!l||l.length<2)return[];const x=(d.fastweb?.dealers||[]).map(I=>I.Point||"").filter(Boolean),y=new Set,h=[];for(const I of x){const M=I.trim(),T=M.toUpperCase();if(!y.has(T)&&(M.toLowerCase().includes(l)&&(y.add(T),h.push(M)),h.length>=15))break}return h},[w,d.fastweb]),u=o.useMemo(()=>{const l=d.fastweb?.totale||{},n=d.sky?.totale||{},x=d.sim?.aggregated||{};return{fissi:Number(l.FISSI||0),mobili:Number(l.MOBILI||0),mobileRA:Number(l.MobileRA||0),percentRA:Number(l.MobilePercentRA||0),energy:Number(l.ENERGY||0),skyTotale:Number(n.SKY_TOTALE||0),simFW:Number(x.FW_SIM||0),simUNO:Number(x.UNO_SIM||0),simTotale:Object.values(x).reduce((y,h)=>y+Number(h||0),0)}},[d]);return e.jsx(O,{title:"Reportistica V3",children:e.jsxs("div",{className:"space-y-4 mt-4",children:[e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-100 flex items-center justify-between",children:[e.jsx("div",{className:"text-sm text-gray-700 font-semibold",children:"Reportistica Agente (Nuova Versione)"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{label:"Ultimo Aggiornamento TLC",value:A(R.tlc),color:"blue"}),e.jsx(k,{label:"Ultimo aggiornamento ENERGY",value:A(R.energy),color:"emerald"})]})]}),e.jsx("div",{className:"bg-white rounded-xl p-4 border border-gray-100",children:e.jsxs("div",{className:"flex items-center gap-3 flex-wrap",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Anno"}),e.jsx("select",{value:i,onChange:l=>c(Number(l.target.value)),className:"rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm",children:[s,s-1,s-2].map(l=>e.jsx("option",{value:l,children:l},l))})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e.jsx("input",{type:"radio",name:"dealerFilter",checked:!m,onChange:()=>{S(""),N(""),j(!1)},className:"text-blue-600"}),"TUTTI"]}),e.jsxs("label",{className:"flex items-center gap-2 text-sm text-gray-700",children:[e.jsx("input",{type:"radio",name:"dealerFilter",checked:!!m,onChange:()=>{},className:"text-blue-600"}),"Dealer specifico"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx("label",{className:"block text-xs text-gray-600 mb-1",children:"Ragione Sociale"}),e.jsx("input",{value:w,onChange:l=>{N(l.target.value),S(""),j(!0)},onFocus:()=>j(!0),onKeyDown:l=>{if(l.key==="Enter"&&v.length>0){const n=v[0];N(n),S(n),j(!1),l.preventDefault()}},placeholder:"Ragione Sociale",className:"rounded-lg border-gray-300 focus:border-blue-500 focus:ring-blue-500 text-sm w-64"}),B&&v.length>0&&e.jsx("div",{className:"absolute z-10 mt-1 w-64 max-h-56 overflow-auto rounded-lg border border-gray-200 bg-white shadow",children:v.map(l=>e.jsx("button",{type:"button",onClick:()=>{N(l),S(l),j(!1)},className:"block w-full text-left px-3 py-2 text-sm hover:bg-gray-50",children:l},l))})]}),b&&e.jsx("div",{className:"text-sm text-gray-500",children:"Caricamentoâ€¦"}),p&&e.jsx("div",{className:"text-sm text-red-600",children:p})]})}),!m&&e.jsxs("section",{className:"grid grid-cols-2 md:grid-cols-4 lg:grid-cols-8 gap-3",children:[e.jsx(g,{label:"Fissi",value:u.fissi}),e.jsx(g,{label:"Mobili",value:u.mobili}),e.jsx(g,{label:"Mobile RA",value:u.mobileRA}),e.jsx(g,{label:"% RA",value:`${u.percentRA.toFixed(1)}%`}),e.jsx(g,{label:"Energy",value:u.energy}),e.jsx(g,{label:"Sky",value:u.skyTotale}),e.jsx(g,{label:"SIM FW",value:u.simFW}),e.jsx(g,{label:"SIM Totali",value:u.simTotale})]}),e.jsxs("section",{className:"bg-white rounded-xl p-4 border border-gray-100",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"ðŸ“Š Dettaglio Fastweb"}),e.jsx("div",{className:"overflow-auto max-h-[500px]",children:e.jsx(D,{dealers:d.fastweb?.dealers||[]})})]}),!m&&d.sky?.dealers?.length>0&&e.jsxs("section",{className:"bg-white rounded-xl p-4 border border-gray-100",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"ðŸ“º Dettaglio Sky"}),e.jsx("div",{className:"overflow-auto max-h-[400px]",children:e.jsx(Y,{dealers:d.sky?.dealers||[]})})]}),!m&&d.sim?.details?.length>0&&e.jsxs("section",{className:"bg-white rounded-xl p-4 border border-gray-100",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-3",children:"ðŸ“± SIM Vendute"}),e.jsx("div",{className:"overflow-auto",children:e.jsx(_,{details:d.sim?.details||[],aggregated:d.sim?.aggregated||{}})})]})]})})}function D({dealers:a}){return a.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Nessun dato disponibile"}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-700 sticky top-0 z-10",children:e.jsxs("tr",{children:[e.jsx(r,{children:"Point"}),e.jsx(r,{children:"Mese"}),e.jsx(r,{children:"FISSI"}),e.jsx(r,{children:"Start"}),e.jsx(r,{children:"Pro"}),e.jsx(r,{children:"Ultra"}),e.jsx(r,{children:"MOBILI"}),e.jsx(r,{children:"Start"}),e.jsx(r,{children:"Pro"}),e.jsx(r,{children:"Ultra"}),e.jsx(r,{children:"RA"}),e.jsx(r,{children:"% RA"}),e.jsx(r,{children:"RES"}),e.jsx(r,{children:"BUS"}),e.jsx(r,{children:"Conv RES"}),e.jsx(r,{children:"Conv BUS"}),e.jsx(r,{children:"ENERGY"}),e.jsx(r,{children:"Core"}),e.jsx(r,{children:"Flex"}),e.jsx(r,{children:"Fix"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:a.map((s,i)=>e.jsxs("tr",{className:"odd:bg-white even:bg-gray-50 hover:bg-blue-50",children:[e.jsx(t,{children:s.Point}),e.jsx(t,{children:s.AnnoMese}),e.jsx(t,{children:e.jsx("strong",{children:s.FISSI||0})}),e.jsx(t,{children:s.FissoStart||0}),e.jsx(t,{children:s.FissoPro||0}),e.jsx(t,{children:s.FissoUltra||0}),e.jsx(t,{children:e.jsx("strong",{children:s.MOBILI||0})}),e.jsx(t,{children:s.MobileStart||0}),e.jsx(t,{children:s.MobilePro||0}),e.jsx(t,{children:s.MobileUltra||0}),e.jsx(t,{className:"font-semibold text-blue-600",children:s.MobileRA||0}),e.jsxs(t,{children:[(s.MobilePercentRA||0).toFixed(1),"%"]}),e.jsx(t,{children:s["MOBILI RES"]||0}),e.jsx(t,{children:s["MOBILI BUS"]||0}),e.jsx(t,{children:s["di cui CONV_RES"]||0}),e.jsx(t,{children:s["di cui CONV_BUS"]||0}),e.jsx(t,{children:e.jsx("strong",{children:s.ENERGY||0})}),e.jsx(t,{children:s.EnergyCore||0}),e.jsx(t,{children:s.EnergyFlex||0}),e.jsx(t,{children:s.EnergyFix||0})]},i))})]})}function Y({dealers:a}){return a.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Nessun dato Sky disponibile"}):e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-700 sticky top-0",children:e.jsxs("tr",{children:[e.jsx(r,{children:"Point"}),e.jsx(r,{children:"Mese"}),e.jsx(r,{children:"TV Only"}),e.jsx(r,{children:"Triple Play"}),e.jsx(r,{children:"WiFi RES"}),e.jsx(r,{children:"Sky Glass"}),e.jsx(r,{children:"4P"}),e.jsx(r,{children:"Prova Sky"}),e.jsx(r,{children:"Mobile"}),e.jsx(r,{children:"WiFi BUS"}),e.jsx(r,{children:"B&B BUS"}),e.jsx(r,{children:"BAR BUS"}),e.jsx(r,{children:"TOTALE"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:a.map((s,i)=>e.jsxs("tr",{className:"odd:bg-white even:bg-gray-50 hover:bg-purple-50",children:[e.jsx(t,{children:s.Point}),e.jsx(t,{children:s.Mese}),e.jsx(t,{children:s.TV_ONLY||0}),e.jsx(t,{children:s.TRIPLE_PLAY||0}),e.jsx(t,{children:s.WIFI_RESIDENZIALE||0}),e.jsx(t,{children:s.SKY_GLASS||0}),e.jsx(t,{children:s["4P"]||0}),e.jsx(t,{children:s["PROVA SKY"]||0}),e.jsx(t,{children:s.MOBILE||0}),e.jsx(t,{children:s.WIFI_BUSINESS||0}),e.jsx(t,{children:s["B&B BUS"]||0}),e.jsx(t,{children:s["BAR BUS"]||0}),e.jsx(t,{children:e.jsx("strong",{children:s.SKY_TOTALE||0})})]},i))})]})}function _({details:a,aggregated:s}){return a.length===0?e.jsx("div",{className:"text-center py-8 text-gray-500",children:"Nessuna SIM venduta"}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"bg-blue-50 rounded-lg p-3 border border-blue-200",children:[e.jsx("div",{className:"text-xs text-blue-600 font-medium",children:"FW SIM"}),e.jsx("div",{className:"text-2xl font-bold text-blue-900",children:s.FW_SIM||0})]}),e.jsxs("div",{className:"bg-green-50 rounded-lg p-3 border border-green-200",children:[e.jsx("div",{className:"text-xs text-green-600 font-medium",children:"UNO SIM"}),e.jsx("div",{className:"text-2xl font-bold text-green-900",children:s.UNO_SIM||0})]}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-3 border border-gray-200",children:[e.jsx("div",{className:"text-xs text-gray-600 font-medium",children:"TOTALE"}),e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:Object.values(s).reduce((i,c)=>i+Number(c||0),0)})]})]}),e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-50 text-gray-700",children:e.jsxs("tr",{children:[e.jsx(r,{children:"Mese"}),e.jsx(r,{children:"Tipologia"}),e.jsx(r,{children:"QuantitÃ "})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:a.map((i,c)=>e.jsxs("tr",{className:"odd:bg-white even:bg-gray-50",children:[e.jsx(t,{children:i.AnnoMese}),e.jsx(t,{children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${i.SIMTYPE==="FW_SIM"?"bg-blue-100 text-blue-800":"bg-green-100 text-green-800"}`,children:i.SIMTYPE})}),e.jsx(t,{children:e.jsx("strong",{children:i.SIM_Vendute||0})})]},c))})]})]})}function g({label:a,value:s}){return e.jsxs("div",{className:"bg-white rounded-xl p-3 border border-gray-100",children:[e.jsx("div",{className:"text-xs text-gray-600",children:a}),e.jsx("div",{className:"text-xl font-bold text-gray-900",children:s??"-"})]})}function r({children:a}){return e.jsx("th",{className:"px-3 py-2 text-left text-xs font-semibold whitespace-nowrap",children:a})}function t({children:a,className:s=""}){return e.jsx("td",{className:`px-3 py-2 whitespace-nowrap ${s}`,children:a})}function A(a){if(!a)return"-";try{const s=new Date(a);if(!isNaN(s.getTime())){const b=String(s.getDate()).padStart(2,"0"),f=String(s.getMonth()+1).padStart(2,"0"),p=s.getFullYear();return`${b}/${f}/${p}`}const i=String(a),c=i.match(/^(\d{4})[-/]?(\d{2})[-/]?(\d{2})/);return c?`${c[3]}/${c[2]}/${c[1]}`:i}catch{return"-"}}function k({label:a,value:s,color:i="blue"}){const c={blue:"bg-blue-50 text-blue-700 border-blue-100",emerald:"bg-emerald-50 text-emerald-700 border-emerald-100",amber:"bg-amber-50 text-amber-700 border-amber-100",gray:"bg-gray-50 text-gray-700 border-gray-100"},b=c[i]||c.blue;return e.jsxs("div",{className:`inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs border ${b}`,children:[e.jsx("span",{className:"font-medium whitespace-nowrap",children:a}),e.jsx("span",{className:"font-semibold",children:s??"-"})]})}export{K as default};
