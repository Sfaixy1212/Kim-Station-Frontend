import{u as L,r,z as a,j as e,d as N}from"./vendor.js";import{C as b}from"./Card.js";import{u as F,g as R,p as w,i as $}from"./index.js";import{A as O}from"./Topbar.js";function Q(){const{user:P,logout:U}=F();L();const[o,y]=r.useState(""),[v,m]=r.useState([]),[I,j]=r.useState(!1),[i,x]=r.useState(""),[E,u]=r.useState(""),[g,c]=r.useState(!1),[d,l]=r.useState(""),p=r.useRef(null),[h,D]=r.useState(null),[C,f]=r.useState(!1);r.useEffect(()=>{if(!o||o.trim().length<2){m([]);return}return j(!0),clearTimeout(p.current),p.current=setTimeout(async()=>{try{const t=await R(`/admin/dealers/search?q=${encodeURIComponent(o.trim())}`);m(Array.isArray(t)?t:[])}catch(t){console.error(t),a.error("Errore ricerca dealer")}finally{j(!1)}},300),()=>clearTimeout(p.current)},[o]);async function S(){const t=parseInt(i,10);if(!Number.isInteger(t)||t<=0){a.error("IDDealer non valido");return}const n=a.loading("Riattivazione in corso...");try{const s=await w(`/admin/users/${t}/reactivate`,{});a.success("Utente riattivato"),l(""),c(!1),console.log("[REACTIVATE][OK]",s)}catch(s){console.error("[REACTIVATE][ERR]",s),a.error("Errore durante la riattivazione")}finally{a.dismiss(n)}}async function z(){const t=parseInt(i,10);if(!Number.isInteger(t)||t<=0){a.error("IDDealer non valido");return}const n=a.loading("Disattivazione in corso...");try{const s=await w(`/admin/users/${t}/soft-delete`,{});a.success("Utente disattivato (soft delete)"),l(""),c(!1),console.log("[SOFT_DELETE][OK]",s)}catch(s){console.error("[SOFT_DELETE][ERR]",s),a.error("Errore durante la disattivazione")}finally{a.dismiss(n)}}function A(t){x(String(t.IDDealer||"")),u(String(t.RagioneSociale||"")),y(""),m([]),l(`DELETE DEALER ${t.IDDealer}`)}async function k(){const t=parseInt(i,10);if(!Number.isInteger(t)||t<=0){a.error("IDDealer non valido");return}const n=`DELETE DEALER ${t}`;if(d!==n){a.error("Frase di conferma non corretta");return}try{const s=await R(`/admin/users/${t}/deps`);D(s?.deps||{ordini:0,transazioni:0,agenti:0}),f(!0)}catch(s){console.error("[DEPS][ERR]",s),a.error("Errore nel recupero dipendenze")}}async function T(){const t=parseInt(i,10),n=a.loading("Eliminazione in corso...");try{const s=await $(`/admin/users/${t}/hard-delete?force=${g?"true":"false"}`,{confirm:!0,phrase:d});a.success("Utente eliminato definitivamente"),x(""),u(""),l(""),c(!1),D(null),f(!1),console.log("[HARD_DELETE][OK]",s)}catch(s){console.error("[HARD_DELETE][ERR]",s),String(s?.message||"Errore").toLowerCase().includes("409")?a.error("Dipendenze presenti (ordini/transazioni). Abilita Force per procedere."):a.error("Errore durante l'eliminazione")}finally{a.dismiss(n)}}return e.jsxs(e.Fragment,{children:[e.jsx(O,{}),e.jsxs("div",{className:"w-full px-4 sm:px-6 lg:px-8 py-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-xl font-semibold text-gray-900 dark:text-gray-100",children:"Dashboard Admin"}),e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Pannello di amministrazione e gestione utenti"})]}),e.jsx(b,{title:"Creazione Utente Station",subtitle:"Crea rapidamente un Dealer o un Agente",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("div",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Compila il form dedicato per inserire i dati e assegnare il ruolo corretto (Dealer o Agente)."}),e.jsx(N,{to:"/admin/users/create",className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow text-sm",children:"Apri form"})]})}),e.jsx("div",{className:"mt-6"}),e.jsx(b,{title:"Import Dati",subtitle:"FW Energia, RA e TLC giornaliero",children:e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx("div",{className:"text-sm text-gray-700 dark:text-gray-300",children:"Gestisci tutti gli import da un'unica interfaccia con tab dedicati per FW Energia, Import RA e TLC giornaliero (INSERITO KIM)."}),e.jsx(N,{to:"/admin/imports",className:"px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded shadow text-sm",children:"Apri Import"})]})}),e.jsx("div",{className:"mt-6"}),e.jsx(b,{title:"Elimina Utente (Hard Delete)",subtitle:"Operazione irreversibile. Richiede doppia conferma.",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cerca per Ragione Sociale"}),e.jsx("input",{value:o,onChange:t=>y(t.target.value),placeholder:"Inserisci almeno 2 caratteri...",className:"w-full border rounded px-3 py-2"}),I&&e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:"Ricerca..."}),!!v.length&&e.jsx("div",{className:"mt-2 border rounded divide-y overflow-hidden",children:v.map(t=>e.jsxs("button",{type:"button",onClick:()=>A(t),className:"w-full text-left px-3 py-2 hover:bg-gray-50",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:t.RagioneSociale}),e.jsxs("div",{className:"text-xs text-gray-600",children:["IDDealer: ",t.IDDealer," • ",t.RecapitoEmail]})]},t.IDDealer))})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-3",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"IDDealer"}),e.jsx("input",{value:i,onChange:t=>x(t.target.value),className:"w-full border rounded px-3 py-2"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ragione Sociale (solo informativa)"}),e.jsx("input",{value:E,onChange:t=>u(t.target.value),className:"w-full border rounded px-3 py-2",placeholder:"Facoltativo"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Frase di conferma"}),e.jsx("input",{value:d,onChange:t=>l(t.target.value),className:"w-full border rounded px-3 py-2",placeholder:i?`DELETE DEALER ${i}`:"DELETE DEALER <ID>"})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-gray-700",children:[e.jsx("input",{type:"checkbox",checked:g,onChange:t=>c(t.target.checked)}),"Forza eliminazione (se esistono ordini/transazioni)"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",onClick:k,className:"px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded shadow text-sm",children:"Elimina definitivamente"}),e.jsx("button",{type:"button",onClick:z,className:"px-4 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded shadow text-sm",children:"Soft delete"}),e.jsx("button",{type:"button",onClick:S,className:"px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded shadow text-sm",children:"Riattiva utente"})]})]})]})}),C&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4",children:e.jsxs("div",{className:"w-full max-w-lg rounded-2xl bg-white shadow-xl",children:[e.jsxs("div",{className:"px-5 py-4 border-b",children:[e.jsx("h3",{className:"text-base font-semibold text-gray-900",children:"Conferma eliminazione definitiva"}),e.jsxs("p",{className:"text-xs text-gray-500",children:["IDDealer: ",i," • ",E||"—"]})]}),e.jsxs("div",{className:"px-5 py-4 space-y-3",children:[e.jsx("div",{className:"text-sm text-gray-700",children:"Dipendenze rilevate:"}),e.jsxs("ul",{className:"text-sm text-gray-800 list-disc pl-6",children:[e.jsxs("li",{children:["Ordini: ",h?.ordini??0]}),e.jsxs("li",{children:["Transazioni: ",h?.transazioni??0]}),e.jsxs("li",{children:["Agenti: ",h?.agenti??0]})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Questa operazione è irreversibile. Gli ordini e le transazioni non saranno cancellati."}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-gray-700",children:[e.jsx("input",{type:"checkbox",checked:g,onChange:t=>c(t.target.checked)}),"Forza eliminazione (se esistono ordini/transazioni)"]}),e.jsxs("div",{className:"text-sm text-gray-700",children:["Digita la frase di conferma: ",e.jsxs("code",{className:"px-1 py-0.5 bg-gray-100 rounded",children:["DELETE DEALER ",i]})]}),e.jsx("input",{value:d,onChange:t=>l(t.target.value),className:"w-full border rounded px-3 py-2 text-sm"})]}),e.jsxs("div",{className:"px-5 py-4 border-t flex items-center justify-end gap-2",children:[e.jsx("button",{onClick:()=>{f(!1)},className:"px-3 py-2 text-sm rounded bg-gray-100 hover:bg-gray-200",children:"Annulla"}),e.jsx("button",{onClick:T,className:"px-3 py-2 text-sm rounded bg-red-600 hover:bg-red-700 text-white",children:"Conferma elimina"})]})]})})]})]})}export{Q as default};
